<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Collin K. Berke, Ph.D.">
<meta name="dcterms.date" content="2024-01-01">
<meta name="description" content="Learning how to use the recipes package, one day at a time">

<title>Collin K. Berke, Ph.D.&nbsp;- 30 day tidymodels recipes challenge</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<link href="../../../icon.png" rel="icon" type="image/png">
<script src="../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../../site_libs/bootstrap/bootstrap-dark.min.css" rel="stylesheet" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">Collin K. Berke, Ph.D.</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../index.html" rel="" target="">
 <span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../now.html" rel="" target="">
 <span class="menu-text">Now</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../blog/index.html" rel="" target="">
 <span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../til/index.html" rel="" target="">
 <span class="menu-text">Today I Learned</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#background" id="toc-background" class="nav-link active" data-scroll-target="#background">Background</a></li>
  <li><a href="#my-spin-on-this" id="toc-my-spin-on-this" class="nav-link" data-scroll-target="#my-spin-on-this">My spin on this</a></li>
  <li><a href="#what-i-intend-to-get-out-of-this-challenge" id="toc-what-i-intend-to-get-out-of-this-challenge" class="nav-link" data-scroll-target="#what-i-intend-to-get-out-of-this-challenge">What I intend to get out of this challenge</a></li>
  <li><a href="#day-01---create-a-recipe" id="toc-day-01---create-a-recipe" class="nav-link" data-scroll-target="#day-01---create-a-recipe">Day 01 - Create a recipe</a></li>
  <li><a href="#day-02---how-to-use-prep-and-bake" id="toc-day-02---how-to-use-prep-and-bake" class="nav-link" data-scroll-target="#day-02---how-to-use-prep-and-bake">Day 02 - How to use <code>prep()</code> and <code>bake()</code></a></li>
  <li><a href="#day-03---selector-functions" id="toc-day-03---selector-functions" class="nav-link" data-scroll-target="#day-03---selector-functions">Day 03 - Selector functions</a></li>
  <li><a href="#day-04---create-dummy-variables-using-step_dummy" id="toc-day-04---create-dummy-variables-using-step_dummy" class="nav-link" data-scroll-target="#day-04---create-dummy-variables-using-step_dummy">Day 04 - Create dummy variables using <code>step_dummy()</code></a></li>
  <li><a href="#day-05---create-a-binary-indicator-variable-for-holidays-using-step_holiday" id="toc-day-05---create-a-binary-indicator-variable-for-holidays-using-step_holiday" class="nav-link" data-scroll-target="#day-05---create-a-binary-indicator-variable-for-holidays-using-step_holiday">Day 05 - Create a binary indicator variable for holidays using <code>step_holiday()</code></a></li>
  <li><a href="#day-06---use-step_zv-to-drop-variables-with-one-value" id="toc-day-06---use-step_zv-to-drop-variables-with-one-value" class="nav-link" data-scroll-target="#day-06---use-step_zv-to-drop-variables-with-one-value">Day 06 - Use <code>step_zv()</code> to drop variables with one value</a></li>
  <li><a href="#day-07---use-step_impute_-functions-for-imputation" id="toc-day-07---use-step_impute_-functions-for-imputation" class="nav-link" data-scroll-target="#day-07---use-step_impute_-functions-for-imputation">Day 07 - Use <code>step_impute_*()</code> functions for imputation</a></li>
  <li><a href="#day-08---use-bagged-tree-models-to-impute-missing-data-with-step_impute_bag" id="toc-day-08---use-bagged-tree-models-to-impute-missing-data-with-step_impute_bag" class="nav-link" data-scroll-target="#day-08---use-bagged-tree-models-to-impute-missing-data-with-step_impute_bag">Day 08 - Use bagged tree models to impute missing data with <code>step_impute_bag()</code></a></li>
  <li><a href="#day-09---impute-missing-values-using-step_impute_knn" id="toc-day-09---impute-missing-values-using-step_impute_knn" class="nav-link" data-scroll-target="#day-09---impute-missing-values-using-step_impute_knn">Day 09 - Impute missing values using <code>step_impute_knn()</code></a></li>
  <li><a href="#day-10---impute-missing-values-using-a-linear-model-with-step_impute_linear" id="toc-day-10---impute-missing-values-using-a-linear-model-with-step_impute_linear" class="nav-link" data-scroll-target="#day-10---impute-missing-values-using-a-linear-model-with-step_impute_linear">Day 10 - Impute missing values using a linear model with <code>step_impute_linear()</code></a></li>
  <li><a href="#day-11---impute-values-using-step_impute_lower" id="toc-day-11---impute-values-using-step_impute_lower" class="nav-link" data-scroll-target="#day-11---impute-values-using-step_impute_lower">Day 11 - Impute values using <code>step_impute_lower()</code></a></li>
  <li><a href="#day-12---impute-values-using-a-rolling-window-via-step_impute_roll" id="toc-day-12---impute-values-using-a-rolling-window-via-step_impute_roll" class="nav-link" data-scroll-target="#day-12---impute-values-using-a-rolling-window-via-step_impute_roll">Day 12 - Impute values using a rolling window via <code>step_impute_roll()</code></a></li>
  <li><a href="#day-13---use-step_corr-to-remove-highly-correlated-predictors" id="toc-day-13---use-step_corr-to-remove-highly-correlated-predictors" class="nav-link" data-scroll-target="#day-13---use-step_corr-to-remove-highly-correlated-predictors">Day 13 - Use <code>step_corr()</code> to remove highly correlated predictors</a></li>
  <li><a href="#day-14---perform-dimension-reduction-with-step_pca" id="toc-day-14---perform-dimension-reduction-with-step_pca" class="nav-link" data-scroll-target="#day-14---perform-dimension-reduction-with-step_pca">Day 14 - Perform dimension reduction with <code>step_pca()</code></a></li>
  <li><a href="#day-15---use-step_ica-for-signal-extraction" id="toc-day-15---use-step_ica-for-signal-extraction" class="nav-link" data-scroll-target="#day-15---use-step_ica-for-signal-extraction">Day 15 - Use <code>step_ica()</code> for signal extraction</a></li>
  <li><a href="#day-16---use-step_other-to-collapse-low-occurring-categorical-levels-into-other" id="toc-day-16---use-step_other-to-collapse-low-occurring-categorical-levels-into-other" class="nav-link" data-scroll-target="#day-16---use-step_other-to-collapse-low-occurring-categorical-levels-into-other">Day 16 - Use <code>step_other()</code> to collapse low occurring categorical levels into <code>other</code></a></li>
  <li><a href="#day-17---convert-date-data-into-factor-or-numeric-variables-with-step_date" id="toc-day-17---convert-date-data-into-factor-or-numeric-variables-with-step_date" class="nav-link" data-scroll-target="#day-17---convert-date-data-into-factor-or-numeric-variables-with-step_date">Day 17 - Convert date data into factor or numeric variables with <code>step_date()</code></a></li>
  <li><a href="#day-18---create-a-lagged-variable-using-step_lag" id="toc-day-18---create-a-lagged-variable-using-step_lag" class="nav-link" data-scroll-target="#day-18---create-a-lagged-variable-using-step_lag">Day 18 - Create a lagged variable using <code>step_lag()</code></a></li>
  <li><a href="#day-19---use-step_log-to-log-transform-variables" id="toc-day-19---use-step_log-to-log-transform-variables" class="nav-link" data-scroll-target="#day-19---use-step_log-to-log-transform-variables">Day 19 - Use <code>step_log()</code> to log transform variables</a></li>
  <li><a href="#day-20---use-step_sqrt-to-apply-a-square-root-transformation" id="toc-day-20---use-step_sqrt-to-apply-a-square-root-transformation" class="nav-link" data-scroll-target="#day-20---use-step_sqrt-to-apply-a-square-root-transformation">Day 20 - Use <code>step_sqrt()</code> to apply a square root transformation</a></li>
  <li><a href="#day-21---apply-the-box-cox-transformation-using-step_boxcox" id="toc-day-21---apply-the-box-cox-transformation-using-step_boxcox" class="nav-link" data-scroll-target="#day-21---apply-the-box-cox-transformation-using-step_boxcox">Day 21 - Apply the Box-Cox transformation using <code>step_BoxCox()</code></a></li>
  <li><a href="#day-22---apply-an-inverse-transformation-using-step_inverse" id="toc-day-22---apply-an-inverse-transformation-using-step_inverse" class="nav-link" data-scroll-target="#day-22---apply-an-inverse-transformation-using-step_inverse">Day 22 - Apply an inverse transformation using <code>step_inverse()</code></a></li>
  <li><a href="#day-23---use-extension-packages-to-get-even-more-steps" id="toc-day-23---use-extension-packages-to-get-even-more-steps" class="nav-link" data-scroll-target="#day-23---use-extension-packages-to-get-even-more-steps">Day 23 - Use extension packages to get even more steps</a></li>
  <li><a href="#day-24---use-step_tokenize-from-textrecipes-to-convert-a-character-predictor-into-a-token-variable" id="toc-day-24---use-step_tokenize-from-textrecipes-to-convert-a-character-predictor-into-a-token-variable" class="nav-link" data-scroll-target="#day-24---use-step_tokenize-from-textrecipes-to-convert-a-character-predictor-into-a-token-variable">Day 24 - Use <code>step_tokenize()</code> from <code>textrecipes</code> to convert a character predictor into a <code>token</code> variable</a></li>
  <li><a href="#day-25---use-step_clean_level-to-clean-categorical-levels" id="toc-day-25---use-step_clean_level-to-clean-categorical-levels" class="nav-link" data-scroll-target="#day-25---use-step_clean_level-to-clean-categorical-levels">Day 25 - Use <code>step_clean_level()</code> to clean categorical levels</a></li>
  <li><a href="#day-26---use-over-sampling-and-under-sampling-methods-with-the-themis-package" id="toc-day-26---use-over-sampling-and-under-sampling-methods-with-the-themis-package" class="nav-link" data-scroll-target="#day-26---use-over-sampling-and-under-sampling-methods-with-the-themis-package">Day 26 - Use over-sampling and under-sampling methods with the <code>themis</code> package</a></li>
  <li><a href="#day-27---use-step_ts_pad-from-timetk-to-pad-timeseries-data" id="toc-day-27---use-step_ts_pad-from-timetk-to-pad-timeseries-data" class="nav-link" data-scroll-target="#day-27---use-step_ts_pad-from-timetk-to-pad-timeseries-data">Day 27 - Use <code>step_ts_pad()</code> from <code>timetk</code> to pad timeseries data</a></li>
  <li><a href="#day-28---specify-an-interaction-variable-using-step_interact" id="toc-day-28---specify-an-interaction-variable-using-step_interact" class="nav-link" data-scroll-target="#day-28---specify-an-interaction-variable-using-step_interact">Day 28 - Specify an interaction variable using <code>step_interact()</code></a></li>
  <li><a href="#day-29---use-recipes-check_-functions-to-validate-steps" id="toc-day-29---use-recipes-check_-functions-to-validate-steps" class="nav-link" data-scroll-target="#day-29---use-recipes-check_-functions-to-validate-steps">Day 29 - Use <code>recipes</code>’ <code>check_*()</code> functions to validate steps</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">30 day tidymodels <code>recipes</code> challenge</h1>
  <div class="quarto-categories">
    <div class="quarto-category">machine learning</div>
    <div class="quarto-category">feature engineering</div>
    <div class="quarto-category">tidymodels</div>
    <div class="quarto-category">data wrangling</div>
  </div>
  </div>

<div>
  <div class="description">
    Learning how to use the <code>recipes</code> package, one day at a time
  </div>
</div>


<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Collin K. Berke, Ph.D. </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 1, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="thumbnail-wide.jpg" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Photo by <a href="https://unsplash.com/photos/assorted-cookware-set-UiGsP8TvOJQ">Nicolas Gras</a></figcaption>
</figure>
</div>
<section id="background" class="level1">
<h1>Background</h1>
<p>Before the holidays, I came across <a href="https://www.linkedin.com/in/emilhvitfeldt/">Emil Hvitfeldt’s</a> <code>#adventofsteps</code> LinkedIn <a href="https://www.linkedin.com/feed/hashtag/?keywords=adventofsteps">posts</a>. Following a model popularized by <a href="https://adventofcode.com/2023/about">advent of code</a>–an annual tradition of online programming puzzles based on the theme of an <a href="https://en.wikipedia.org/wiki/Advent_calendar">advent calendar</a>–these posts provided daily examples on the use of various <code>step_*</code> functions from the <code>tidymodels</code>’ <a href="https://recipes.tidymodels.org/index.html"><code>recipes</code></a> package. This post, with a slight spin, is inspired by these posts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(here)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(corrr)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(skimr)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(janitor)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(textrecipes)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(themis)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(timetk)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="fu">tidymodels_prefer</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="my-spin-on-this" class="level1">
<h1>My spin on this</h1>
<p>One of my personal goals this coming year is to learn and practice using the different tidymodels’ packages. To complete this goal, I thought a 30 day <code>recipes</code> challenge would be a good start. Each day during this 30 day personal challenge, I will focus on learning and creating some daily notes about one functionality of the <code>recipes</code> package. First, I start with the basics (e.g., how to create a recipe object). Then, I’ll focus on describing the various <code>step_*</code> functions.</p>
<p>To keep me on track, while also avoiding making this a chore, I’m going to place a 1-hour a day stopgap on studying, practicing, and documenting what I’ve learned. Depending on my schedule and motivation, I may work ahead on some material, but I will strive to update this post once a day.</p>
<p>Given the time constraint I’m imposing on myself, some of my daily notes or examples may result in an incomplete description of functionality. In cases like this, I’ll try to link to relevant documentation for you to follow up and learn more. Please be flexible with any grammar and spelling errors during this challenge, as I’ll likely edit very little until the end of the 30 days, if at all.</p>
<p>Since the aim of this post is to document what I’m learning, all errors are completely mine. I highly suggest following up with the <code>recipes</code> package’s <a href="https://recipes.tidymodels.org/">documentation</a> and the <a href="https://www.tmwr.org/">Tidy Modeling with R</a> book following a review of these notes. Both do a more thorough job overviewing the package’s functionality.</p>
</section>
<section id="what-i-intend-to-get-out-of-this-challenge" class="level1">
<h1>What I intend to get out of this challenge</h1>
<p>By the end of this challenge, I hope to have pushed myself to learn more about how to use <code>tidymodels</code>’s <code>recipe</code> package, and to create several example use cases of different functionality.</p>
</section>
<section id="day-01---create-a-recipe" class="level1">
<h1>Day 01 - Create a recipe</h1>
<p>First off, what is a recipe? According to the docs:</p>
<blockquote class="blockquote">
<p>A recipe is a description of the steps to be applied to a data set in order to prepare it for data analysis.</p>
</blockquote>
<p>So, I start this personal challenge by overviewing how to create a recipe object with the <code>recipes</code> package. The <code>recipe()</code> function is used to create a recipe object.</p>
<p>When creating a recipe, we need to consider what <strong>roles</strong> variables take. In simple modeling tasks, you’ll just have outcomes and predictors. However, variables may take on other roles (i.e., IDs). As such, the <code>recipe()</code> function provides multiple means for specifying the role of a variable:</p>
<ol type="1">
<li>The formula</li>
<li>Manually updating roles using the <code>update_role()</code> function.</li>
</ol>
<p>Let’s use the <code>credit_data</code> from tidymodels’ <code>modeldata</code> package. You can get more information about this data by running <code>?credit_data</code> in your console.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(credit_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,454
Columns: 14
$ Status    &lt;fct&gt; good, good, bad, good, good, good, good, good, good, bad, good, good, good, good…
$ Seniority &lt;int&gt; 9, 17, 10, 0, 0, 1, 29, 9, 0, 0, 6, 7, 8, 19, 0, 0, 15, 33, 0, 1, 2, 5, 1, 27, 2…
$ Home      &lt;fct&gt; rent, rent, owner, rent, rent, owner, owner, parents, owner, parents, owner, own…
$ Time      &lt;int&gt; 60, 60, 36, 60, 36, 60, 60, 12, 60, 48, 48, 36, 60, 36, 18, 24, 24, 24, 48, 60, …
$ Age       &lt;int&gt; 30, 58, 46, 24, 26, 36, 44, 27, 32, 41, 34, 29, 30, 37, 21, 68, 52, 68, 36, 31, …
$ Marital   &lt;fct&gt; married, widow, married, single, single, married, married, single, married, marr…
$ Records   &lt;fct&gt; no, no, yes, no, no, no, no, no, no, no, no, no, no, no, yes, no, no, no, no, no…
$ Job       &lt;fct&gt; freelance, fixed, freelance, fixed, fixed, fixed, fixed, fixed, freelance, parti…
$ Expenses  &lt;int&gt; 73, 48, 90, 63, 46, 75, 75, 35, 90, 90, 60, 60, 75, 75, 35, 75, 35, 65, 45, 35, …
$ Income    &lt;int&gt; 129, 131, 200, 182, 107, 214, 125, 80, 107, 80, 125, 121, 199, 170, 50, 131, 330…
$ Assets    &lt;int&gt; 0, 0, 3000, 2500, 0, 3500, 10000, 0, 15000, 0, 4000, 3000, 5000, 3500, 0, 4162, …
$ Debt      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2500, 260, 0, 0, 0, 2000, 0, 0, 0, 0, 500, 0…
$ Amount    &lt;int&gt; 800, 1000, 2000, 900, 310, 650, 1600, 200, 1200, 1200, 1150, 650, 1500, 600, 400…
$ Price     &lt;int&gt; 846, 1658, 2985, 1325, 910, 1645, 1800, 1093, 1957, 1468, 1577, 915, 1650, 940, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducibility</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> Status)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create splits for examples</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No outcome variable, `.` is a shortcut for **all** variables</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_train)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Outcome with specific variables to be included within model</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> credit_train</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Recipe uses `data` only as a template, all the data is not needed</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Useful in cases when you're working with large data</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> <span class="fu">head</span>(credit_train)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use `update_role()` to specify variable roles</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>credit_rec_update <span class="ot">&lt;-</span> <span class="fu">recipe</span>(credit_train) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(Status, <span class="at">new_role =</span> <span class="st">"outcome"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    Seniority, Home, Time, Age, Marital, Records, </span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    Job, Expenses, Income, Assets, Debt, Amount, </span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    Price, <span class="at">new_role =</span> <span class="st">"predictor"</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>credit_rec_update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 13</code></pre>
</div>
</div>
<p>The <code>update_role()</code> function is useful in cases where you might have an ID variable you don’t want to include within your model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>credit_data_id <span class="ot">&lt;-</span> credit_data <span class="sc">|&gt;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">.before =</span> <span class="dv">1</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>credit_id_split <span class="ot">&lt;-</span> </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">initial_split</span>(credit_data_id, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> Status)</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>credit_id_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_id_split)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>credit_id_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_id_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually add an 'id' role to a variable</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>credit_id_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(credit_id_train) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(Status, <span class="at">new_role =</span> <span class="st">"outcome"</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    Seniority, Home, Time, Age, Marital, Records, </span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    Job, Expenses, Income, Assets, Debt, Amount, </span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    Price, <span class="at">new_role =</span> <span class="st">"predictor"</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>credit_id_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 13
id:         1</code></pre>
</div>
</div>
<p>In case you ever need to remove a role, you can use <code>remove_role()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>credit_no_id_rec <span class="ot">&lt;-</span> credit_id_rec <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">remove_role</span>(id, <span class="at">old_role =</span> <span class="st">"id"</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># id will be assigned and 'undeclared' role</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>credit_no_id_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:          1
predictor:       13
undeclared role:  1</code></pre>
</div>
</div>
<p>Each recipe has its own summary method. We can wrap the recipe object within <code>summary()</code> to output more information about each variable and its assigned role.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Formula specified recipe</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(credit_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  variable type      role      source  
  &lt;chr&gt;    &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
1 Debt     &lt;chr [2]&gt; predictor original
2 Income   &lt;chr [2]&gt; predictor original
3 Assets   &lt;chr [2]&gt; predictor original
4 Status   &lt;chr [3]&gt; outcome   original</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manually specified using `update_role()`</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(credit_rec_update)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 4
   variable  type      role      source  
   &lt;chr&gt;     &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
 1 Status    &lt;chr [3]&gt; outcome   original
 2 Seniority &lt;chr [2]&gt; predictor original
 3 Home      &lt;chr [3]&gt; predictor original
 4 Time      &lt;chr [2]&gt; predictor original
 5 Age       &lt;chr [2]&gt; predictor original
 6 Marital   &lt;chr [3]&gt; predictor original
 7 Records   &lt;chr [3]&gt; predictor original
 8 Job       &lt;chr [3]&gt; predictor original
 9 Expenses  &lt;chr [2]&gt; predictor original
10 Income    &lt;chr [2]&gt; predictor original
11 Assets    &lt;chr [2]&gt; predictor original
12 Debt      &lt;chr [2]&gt; predictor original
13 Amount    &lt;chr [2]&gt; predictor original
14 Price     &lt;chr [2]&gt; predictor original</code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recipe with a variable holding the 'id' role</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(credit_id_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 4
   variable  type      role      source  
   &lt;chr&gt;     &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
 1 id        &lt;chr [2]&gt; id        original
 2 Status    &lt;chr [3]&gt; outcome   original
 3 Seniority &lt;chr [2]&gt; predictor original
 4 Home      &lt;chr [3]&gt; predictor original
 5 Time      &lt;chr [2]&gt; predictor original
 6 Age       &lt;chr [2]&gt; predictor original
 7 Marital   &lt;chr [3]&gt; predictor original
 8 Records   &lt;chr [3]&gt; predictor original
 9 Job       &lt;chr [3]&gt; predictor original
10 Expenses  &lt;chr [2]&gt; predictor original
11 Income    &lt;chr [2]&gt; predictor original
12 Assets    &lt;chr [2]&gt; predictor original
13 Debt      &lt;chr [2]&gt; predictor original
14 Amount    &lt;chr [2]&gt; predictor original
15 Price     &lt;chr [2]&gt; predictor original</code></pre>
</div>
</div>
</section>
<section id="day-02---how-to-use-prep-and-bake" class="level1">
<h1>Day 02 - How to use <code>prep()</code> and <code>bake()</code></h1>
<p>Let’s stick with the credit data for today’s examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same code from day 01</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(credit_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,454
Columns: 14
$ Status    &lt;fct&gt; good, good, bad, good, good, good, good, good, good, bad, good, good, good, good…
$ Seniority &lt;int&gt; 9, 17, 10, 0, 0, 1, 29, 9, 0, 0, 6, 7, 8, 19, 0, 0, 15, 33, 0, 1, 2, 5, 1, 27, 2…
$ Home      &lt;fct&gt; rent, rent, owner, rent, rent, owner, owner, parents, owner, parents, owner, own…
$ Time      &lt;int&gt; 60, 60, 36, 60, 36, 60, 60, 12, 60, 48, 48, 36, 60, 36, 18, 24, 24, 24, 48, 60, …
$ Age       &lt;int&gt; 30, 58, 46, 24, 26, 36, 44, 27, 32, 41, 34, 29, 30, 37, 21, 68, 52, 68, 36, 31, …
$ Marital   &lt;fct&gt; married, widow, married, single, single, married, married, single, married, marr…
$ Records   &lt;fct&gt; no, no, yes, no, no, no, no, no, no, no, no, no, no, no, yes, no, no, no, no, no…
$ Job       &lt;fct&gt; freelance, fixed, freelance, fixed, fixed, fixed, fixed, fixed, freelance, parti…
$ Expenses  &lt;int&gt; 73, 48, 90, 63, 46, 75, 75, 35, 90, 90, 60, 60, 75, 75, 35, 75, 35, 65, 45, 35, …
$ Income    &lt;int&gt; 129, 131, 200, 182, 107, 214, 125, 80, 107, 80, 125, 121, 199, 170, 50, 131, 330…
$ Assets    &lt;int&gt; 0, 0, 3000, 2500, 0, 3500, 10000, 0, 15000, 0, 4000, 3000, 5000, 3500, 0, 4162, …
$ Debt      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2500, 260, 0, 0, 0, 2000, 0, 0, 0, 0, 500, 0…
$ Amount    &lt;int&gt; 800, 1000, 2000, 900, 310, 650, 1600, 200, 1200, 1200, 1150, 650, 1500, 600, 400…
$ Price     &lt;int&gt; 846, 1658, 2985, 1325, 910, 1645, 1800, 1093, 1957, 1468, 1577, 915, 1650, 940, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducibility</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> Status)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Create splits for our day 2 examples</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’re going to continue to use the previously specified limited model from day 01 for our examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> credit_train</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we know how to specify a recipe, we need to learn how to use <code>recipes</code>’ <code>prep()</code> and <code>bake()</code> functions. <code>prep()</code> calculates any intermediate values required for preprocessing. <code>bake()</code> applies the preprocessing steps–using any intermediate values–to our testing and training data.</p>
<p><code>prep()</code> and <code>bake()</code> <a href="https://stackoverflow.com/questions/62189885/what-is-the-difference-among-prep-bake-juice-in-the-r-package-recipes">can be confusing</a> at first. However, I like the following analogy from the <a href="https://youtu.be/xygnYlku-w4?feature=shared&amp;t=1822">R4DS learning community’s Q&amp;A</a> with the authors of the <a href="https://www.tmwr.org/">Tidy Modeling with R book</a>:</p>
<blockquote class="blockquote">
<p>They’re analogous to <code>fit()</code> and <code>predict()</code> … <code>prep()</code> is like fitting where you’re estimating stuff and <code>bake()</code> is like you’re applying it.</p>
<p>- Max Kuhn</p>
</blockquote>
<p>For a more formal treatment, the <code>prep()</code> docs state:</p>
<blockquote class="blockquote">
<p>For a recipe with at least one preprocessing operation, estimate the required parameters from a training set that can be later applied to other data sets.</p>
</blockquote>
<p>The <code>bake()</code> docs state:</p>
<blockquote class="blockquote">
<p>For a recipe with at least one preprocessing operation that has been trained by <code>prep()</code>, apply the computations to new data.</p>
</blockquote>
<p>Why two separate functions? Some preprocessing steps need an <em>intermediate calculation</em> step to be performed before applying the recipe to the data (e.g., <code>step_normalize()</code> and <code>step_center()</code>; more on this later). To better articulate this point, I’m going to fast-forward a bit in our challenge and apply the <code>step_center()</code> function to our recipe. <code>step_center()</code> is used to center variables.</p>
<p>When centering a variable, we need to make an intermediate calculation (i.e., <code>prep()</code>) before applying the calculation to perform the centering to our data (i.e., <code>bake()</code>).</p>
<p>For our example, say we want to center the <code>Debt</code> variable. To do this, we can simply add <code>step_center(Debt)</code> to our recipe. When we pipe the recipe object to <code>prep()</code>, the mean is calculated in the background to perform the preprocessing step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> credit_train</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(Debt) <span class="sc">|&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see this calculated value by using the <code>number</code> argument in the <code>tidy.recipe()</code> method.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print a summary of the recipe steps to be performed</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type   trained skip  id          
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;       
1      1 step      center TRUE    FALSE center_lw98c</code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print additional information about the first recipe step</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms value id          
  &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;       
1 Debt   337. center_lw98c</code></pre>
</div>
</div>
<p>Take note, though, the <code>Debt</code> variable has not been centered yet, and we are still working with a recipe object.</p>
<p>We then apply the centering transformation to the data by piping the prepped recipe to <code>bake()</code>. We can apply the preprocessing to the training data by passing the <code>NULL</code> to the <code>new_data</code> argument. <code>bake()</code> returns a tibble with our transformed variable using our training data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>credit_baked <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> credit_train</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(Debt) <span class="sc">|&gt;</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>credit_baked</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,563 × 4
    Debt Income Assets Status
   &lt;dbl&gt;  &lt;int&gt;  &lt;int&gt; &lt;fct&gt; 
 1 -337.     80      0 bad   
 2 -337.     50      0 bad   
 3 -337.    107      0 bad   
 4  163.    112   2000 bad   
 5 -337.     85   5000 bad   
 6   NA      NA     NA bad   
 7 -337.     90      0 bad   
 8 -337.     71   3000 bad   
 9 -337.    128      0 bad   
10 -337.    100      0 bad   
# ℹ 3,553 more rows</code></pre>
</div>
</div>
<p>Most likely, you won’t use <code>prep()</code> and <code>bake()</code> for other modeling tasks. However, they’ll be important as we continue exploring the <code>recipes</code> package in the coming days.</p>
</section>
<section id="day-03---selector-functions" class="level1">
<h1>Day 03 - Selector functions</h1>
<p>Remaining consistent, let’s continue using the <code>credit_data</code> data for some of today’s examples. We’ll also use the <code>Chicago</code> data set for a couple additional examples. You can read more about this data by running <code>?Chicago</code> in your console.</p>
<p>Here we’ll get our data and split it into training and testing for both data sets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same code from day 01</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(credit_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,454
Columns: 14
$ Status    &lt;fct&gt; good, good, bad, good, good, good, good, good, good, bad, good, good, good, good…
$ Seniority &lt;int&gt; 9, 17, 10, 0, 0, 1, 29, 9, 0, 0, 6, 7, 8, 19, 0, 0, 15, 33, 0, 1, 2, 5, 1, 27, 2…
$ Home      &lt;fct&gt; rent, rent, owner, rent, rent, owner, owner, parents, owner, parents, owner, own…
$ Time      &lt;int&gt; 60, 60, 36, 60, 36, 60, 60, 12, 60, 48, 48, 36, 60, 36, 18, 24, 24, 24, 48, 60, …
$ Age       &lt;int&gt; 30, 58, 46, 24, 26, 36, 44, 27, 32, 41, 34, 29, 30, 37, 21, 68, 52, 68, 36, 31, …
$ Marital   &lt;fct&gt; married, widow, married, single, single, married, married, single, married, marr…
$ Records   &lt;fct&gt; no, no, yes, no, no, no, no, no, no, no, no, no, no, no, yes, no, no, no, no, no…
$ Job       &lt;fct&gt; freelance, fixed, freelance, fixed, fixed, fixed, fixed, fixed, freelance, parti…
$ Expenses  &lt;int&gt; 73, 48, 90, 63, 46, 75, 75, 35, 90, 90, 60, 60, 75, 75, 35, 75, 35, 65, 45, 35, …
$ Income    &lt;int&gt; 129, 131, 200, 182, 107, 214, 125, 80, 107, 80, 125, 121, 199, 170, 50, 131, 330…
$ Assets    &lt;int&gt; 0, 0, 3000, 2500, 0, 3500, 10000, 0, 15000, 0, 4000, 3000, 5000, 3500, 0, 4162, …
$ Debt      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2500, 260, 0, 0, 0, 2000, 0, 0, 0, 0, 500, 0…
$ Amount    &lt;int&gt; 800, 1000, 2000, 900, 310, 650, 1600, 200, 1200, 1200, 1150, 650, 1500, 600, 400…
$ Price     &lt;int&gt; 846, 1658, 2985, 1325, 910, 1645, 1800, 1093, 1957, 1468, 1577, 915, 1650, 940, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducibility</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.8</span>, <span class="at">strata =</span> Status)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(Chicago, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(Chicago)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 5,698
Columns: 50
$ ridership        &lt;dbl&gt; 15.732, 15.762, 15.872, 15.874, 15.423, 2.425, 1.467, 15.511, 15.927, 15.…
$ Austin           &lt;dbl&gt; 1.463, 1.505, 1.519, 1.490, 1.496, 0.693, 0.408, 0.987, 1.551, 1.588, 1.5…
$ Quincy_Wells     &lt;dbl&gt; 8.371, 8.351, 8.359, 7.852, 7.621, 0.911, 0.414, 4.807, 8.227, 8.246, 8.0…
$ Belmont          &lt;dbl&gt; 4.599, 4.725, 4.684, 4.769, 4.720, 2.274, 1.631, 3.517, 4.707, 4.774, 4.8…
$ Archer_35th      &lt;dbl&gt; 2.009, 2.088, 2.108, 2.166, 2.058, 0.624, 0.378, 1.339, 2.221, 2.227, 2.1…
$ Oak_Park         &lt;dbl&gt; 1.421, 1.429, 1.488, 1.445, 1.415, 0.426, 0.225, 0.879, 1.457, 1.475, 1.4…
$ Western          &lt;dbl&gt; 3.319, 3.344, 3.363, 3.359, 3.271, 1.111, 0.567, 1.937, 3.457, 3.511, 3.4…
$ Clark_Lake       &lt;dbl&gt; 15.561, 15.720, 15.558, 15.745, 15.602, 2.413, 1.374, 9.017, 16.003, 15.8…
$ Clinton          &lt;dbl&gt; 2.403, 2.402, 2.367, 2.415, 2.416, 0.814, 0.583, 1.501, 2.437, 2.457, 2.4…
$ Merchandise_Mart &lt;dbl&gt; 6.481, 6.477, 6.405, 6.489, 5.798, 0.858, 0.268, 4.193, 6.378, 6.458, 6.2…
$ Irving_Park      &lt;dbl&gt; 3.744, 3.853, 3.861, 3.843, 3.878, 1.735, 1.164, 2.903, 3.828, 3.869, 3.8…
$ Washington_Wells &lt;dbl&gt; 7.560, 7.576, 7.620, 7.364, 7.089, 0.786, 0.298, 4.731, 7.479, 7.547, 7.2…
$ Harlem           &lt;dbl&gt; 2.655, 2.760, 2.789, 2.812, 2.732, 1.034, 0.642, 1.958, 2.742, 2.753, 2.7…
$ Monroe           &lt;dbl&gt; 5.672, 6.013, 5.786, 5.959, 5.769, 1.044, 0.530, 3.165, 5.935, 5.829, 5.9…
$ Polk             &lt;dbl&gt; 2.481, 2.436, 2.526, 2.450, 2.573, 0.006, 0.000, 1.065, 2.533, 2.566, 2.4…
$ Ashland          &lt;dbl&gt; 1.319, 1.314, 1.324, 1.350, 1.355, 0.566, 0.347, 0.852, 1.400, 1.358, 1.4…
$ Kedzie           &lt;dbl&gt; 3.013, 3.020, 2.982, 3.013, 3.085, 1.130, 0.635, 1.969, 3.149, 3.099, 3.1…
$ Addison          &lt;dbl&gt; 2.500, 2.570, 2.587, 2.528, 2.557, 0.800, 0.487, 1.560, 2.574, 2.618, 2.5…
$ Jefferson_Park   &lt;dbl&gt; 6.595, 6.750, 6.967, 7.013, 6.922, 2.765, 1.856, 4.928, 6.817, 6.853, 6.8…
$ Montrose         &lt;dbl&gt; 1.836, 1.915, 1.977, 1.979, 1.953, 0.772, 0.475, 1.325, 2.040, 2.038, 2.0…
$ California       &lt;dbl&gt; 0.756, 0.781, 0.812, 0.776, 0.789, 0.370, 0.274, 0.473, 0.844, 0.835, 0.8…
$ temp_min         &lt;dbl&gt; 15.1, 25.0, 19.0, 15.1, 21.0, 19.0, 15.1, 26.6, 34.0, 33.1, 23.0, 0.0, 10…
$ temp             &lt;dbl&gt; 19.45, 30.45, 25.00, 22.45, 27.00, 24.80, 18.00, 32.00, 37.40, 34.00, 28.…
$ temp_max         &lt;dbl&gt; 30.0, 36.0, 28.9, 27.0, 32.0, 30.0, 28.9, 41.0, 43.0, 36.0, 33.1, 21.2, 3…
$ temp_change      &lt;dbl&gt; 14.9, 11.0, 9.9, 11.9, 11.0, 11.0, 13.8, 14.4, 9.0, 2.9, 10.1, 21.2, 20.0…
$ dew              &lt;dbl&gt; 13.45, 25.00, 18.00, 10.90, 21.90, 15.10, 10.90, 30.20, 35.60, 30.90, 21.…
$ humidity         &lt;dbl&gt; 78.0, 79.0, 81.0, 66.5, 84.0, 71.0, 74.0, 93.0, 93.0, 89.0, 80.0, 66.5, 7…
$ pressure         &lt;dbl&gt; 30.430, 30.190, 30.160, 30.440, 29.910, 30.280, 30.330, 30.040, 29.400, 2…
$ pressure_change  &lt;dbl&gt; 0.12, 0.18, 0.23, 0.16, 0.65, 0.49, 0.10, 0.78, 0.16, 0.48, 0.23, 0.28, 0…
$ wind             &lt;dbl&gt; 5.20, 8.10, 10.40, 9.80, 12.70, 12.70, 8.10, 8.10, 9.20, 11.50, 11.50, 12…
$ wind_max         &lt;dbl&gt; 10.4, 11.5, 19.6, 16.1, 19.6, 17.3, 13.8, 17.3, 23.0, 16.1, 16.1, 19.6, 1…
$ gust             &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ gust_max         &lt;dbl&gt; 0.0, 0.0, 0.0, 0.0, 25.3, 26.5, 0.0, 26.5, 31.1, 0.0, 0.0, 23.0, 26.5, 0.…
$ percip           &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0…
$ percip_max       &lt;dbl&gt; 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.07, 0.11, 0.01, 0.00, 0.00, 0…
$ weather_rain     &lt;dbl&gt; 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0.00000000, 0…
$ weather_snow     &lt;dbl&gt; 0.00000000, 0.00000000, 0.21428571, 0.00000000, 0.51612903, 0.04000000, 0…
$ weather_cloud    &lt;dbl&gt; 0.7083333, 1.0000000, 0.3571429, 0.2916667, 0.4516129, 0.6400000, 0.52000…
$ weather_storm    &lt;dbl&gt; 0.00000000, 0.20833333, 0.07142857, 0.04166667, 0.45161290, 0.24000000, 0…
$ Blackhawks_Away  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Blackhawks_Home  &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Bulls_Away       &lt;dbl&gt; 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Bulls_Home       &lt;dbl&gt; 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0…
$ Bears_Away       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Bears_Home       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ WhiteSox_Away    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ WhiteSox_Home    &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Cubs_Away        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ Cubs_Home        &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
$ date             &lt;date&gt; 2001-01-22, 2001-01-23, 2001-01-24, 2001-01-25, 2001-01-26, 2001-01-27, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># For reproducibility</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>chicago_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(Chicago, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>chicago_train <span class="ot">&lt;-</span> <span class="fu">training</span>(chicago_split)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>chicago_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(chicago_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When using <code>recipes</code>, we often need to select a group of variables (e.g., all predictors, all numeric variables, all categorical variables, etc.) to apply preprocessing steps. Indeed, we certainly could just explicitly specify each variable by name within our recipe. There’s a better way, though. Use <a href="https://recipes.tidymodels.org/reference/has_role.html"><em>selector functions</em></a>.</p>
<p>Selector functions can be used to choose variables based on:</p>
<ol type="1">
<li>Variable names</li>
<li>Current role</li>
<li>Data type</li>
<li>Any combination of the above three</li>
</ol>
<p>The first set of selectors comes from the <a href="https://tidyselect.r-lib.org"><code>tidyselect</code></a> package, which allows you to make selections based on variable names. Some common ones include:</p>
<ul>
<li><code>tidyselect::starts_with()</code></li>
<li><code>tidyselect::ends_with()</code></li>
<li><code>tidyselect::contains()</code></li>
<li><code>tidyselect::everything()</code></li>
</ul>
<p>Check out <code>recipes</code>’ <code>?selections</code> and the <code>tidyselect</code> <a href="https://tidyselect.r-lib.org">docs</a> for a more exhaustive list of available selection functions. Included above are the ones I commonly use. Here are a few examples of how to use these selector functions to center variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply the centering to variables that start with the *weather* prefix</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>chicago_rec <span class="ot">&lt;-</span> </span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(ridership <span class="sc">~</span> ., <span class="at">data =</span> chicago_train) <span class="sc">|&gt;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">starts_with</span>(<span class="st">"weather"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>chicago_rec <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"weather"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,558 × 4
   weather_rain weather_snow weather_cloud weather_storm
          &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
 1      -0.0803      -0.0529       0.0973        -0.0518
 2      -0.0386       0.572       -0.403          0.0315
 3      -0.0803       0.147       -0.00272        0.0398
 4      -0.0803      -0.0529       0.264          0.198 
 5      -0.0803      -0.0529       0.193          0.0612
 6      -0.0803      -0.0529       0.264          0.323 
 7      -0.0803      -0.0529       0.264          0.201 
 8      -0.0803       0.614       -0.403         -0.236 
 9      -0.0803      -0.0529       0.144         -0.100 
10       0.0678      -0.0529      -0.0694        -0.112 
# ℹ 4,548 more rows</code></pre>
</div>
</div>
<p>Selections also allows us to use the <code>-</code> to exclude specific variables or groupings of variables while using selector functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>chicago_rec <span class="ot">&lt;-</span> </span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(ridership <span class="sc">~</span> ., <span class="at">data =</span> chicago_train) <span class="sc">|&gt;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="sc">-</span>date, <span class="sc">-</span><span class="fu">starts_with</span>(<span class="st">"weather"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>chicago_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,558 × 50
     Austin Quincy_Wells Belmont Archer_35th Oak_Park Western Clark_Lake Clinton Merchandise_Mart
      &lt;dbl&gt;        &lt;dbl&gt;   &lt;dbl&gt;       &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;      &lt;dbl&gt;   &lt;dbl&gt;            &lt;dbl&gt;
 1  0.756          2.49    1.44        0.914   0.645    0.903       6.57   0.972            1.29 
 2  0.279          0.222   1.54        0.577   0.316    1.35        3.80   1.34             0.379
 3  0.579          2.96    1.64        0.949   0.537    1.20        6.12   1.45             3.52 
 4  0.584          1.91    0.686       0.768   0.470    0.849       5.65   0.504            1.21 
 5  0.616          2.41    1.47        0.964   0.569    0.831       6.15   0.995            1.92 
 6  0.660          2.68    1.42        0.982   0.532    0.981       6.02   1.20             2.32 
 7 -1.04          -5.56   -2.33       -1.61   -0.852   -2.25      -10.7   -1.55            -3.60 
 8 -0.00927        0.699   0.483       0.217   0.0441   0.209       1.63   0.999            0.262
 9 -1.06          -4.55   -2.45       -1.50   -1.05    -2.00      -10.9   -1.58            -4.26 
10  0.536          2.03    0.500       0.372   0.560    0.345       5.71   0.557            1.36 
# ℹ 4,548 more rows
# ℹ 41 more variables: Irving_Park &lt;dbl&gt;, Washington_Wells &lt;dbl&gt;, Harlem &lt;dbl&gt;, Monroe &lt;dbl&gt;,
#   Polk &lt;dbl&gt;, Ashland &lt;dbl&gt;, Kedzie &lt;dbl&gt;, Addison &lt;dbl&gt;, Jefferson_Park &lt;dbl&gt;, Montrose &lt;dbl&gt;,
#   California &lt;dbl&gt;, temp_min &lt;dbl&gt;, temp &lt;dbl&gt;, temp_max &lt;dbl&gt;, temp_change &lt;dbl&gt;, dew &lt;dbl&gt;,
#   humidity &lt;dbl&gt;, pressure &lt;dbl&gt;, pressure_change &lt;dbl&gt;, wind &lt;dbl&gt;, wind_max &lt;dbl&gt;, gust &lt;dbl&gt;,
#   gust_max &lt;dbl&gt;, percip &lt;dbl&gt;, percip_max &lt;dbl&gt;, weather_rain &lt;dbl&gt;, weather_snow &lt;dbl&gt;,
#   weather_cloud &lt;dbl&gt;, weather_storm &lt;dbl&gt;, Blackhawks_Away &lt;dbl&gt;, Blackhawks_Home &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To show centering was not applied to variables with the *weather* prefix</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>chicago_rec <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"weather"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,558 × 4
   weather_rain weather_snow weather_cloud weather_storm
          &lt;dbl&gt;        &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;
 1       0             0             0.833        0.208 
 2       0.0417        0.625         0.333        0.292 
 3       0             0.2           0.733        0.3   
 4       0             0             1            0.458 
 5       0             0             0.929        0.321 
 6       0             0             1            0.583 
 7       0             0             1            0.462 
 8       0             0.667         0.333        0.0238
 9       0             0             0.88         0.16  
10       0.148         0             0.667        0.148 
# ℹ 4,548 more rows</code></pre>
</div>
</div>
<p><code>recipes</code> provides functions to select variables based on role and type. This includes the <a href="https://recipes.tidymodels.org/reference/has_role.html"><code>has_role()</code></a> and <a href="https://recipes.tidymodels.org/reference/has_role.html"><code>has_type()</code></a> functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simplified recipe, applying centering to variables with predictor role </span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> credit_train</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>)  <span class="sc">|&gt;</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">has_role</span>(<span class="st">"predictor"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,563 × 4
    Debt Income Assets Status
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt; 
 1 -337.  -60.7 -5233. bad   
 2 -337.  -90.7 -5233. bad   
 3 -337.  -33.7 -5233. bad   
 4  163.  -28.7 -3233. bad   
 5 -337.  -55.7  -233. bad   
 6   NA    NA      NA  bad   
 7 -337.  -50.7 -5233. bad   
 8 -337.  -69.7 -2233. bad   
 9 -337.  -12.7 -5233. bad   
10 -337.  -40.7 -5233. bad   
# ℹ 3,553 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Applying centering to variables with type numeric</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>credit_rec_type <span class="ot">&lt;-</span> <span class="fu">recipe</span>(Status <span class="sc">~</span> ., <span class="at">data =</span> credit_train) <span class="sc">|&gt;</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">has_type</span>(<span class="at">match =</span> <span class="st">"numeric"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>credit_rec_type</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,563 × 14
   Seniority Home    Time      Age Marital Records Job   Expenses Income Assets  Debt Amount   Price
       &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1     -7.91 pare…   1.54   3.94   married no      part…    34.6   -60.7 -5233. -337.  159.    -2.20
 2     -7.91 other -28.5  -16.1    single  yes     part…   -20.4   -90.7 -5233. -337. -641.  -970.  
 3     -5.91 rent   13.5  -12.1    single  no      fixed    -9.42  -33.7 -5233. -337.  459.   719.  
 4     -6.91 owner  13.5    7.94   married no      part…    49.6   -28.7 -3233.  163. -441.  -138.  
 5     -4.91 owner -22.5  -14.1    married no      fixed    19.6   -55.7  -233. -337. -441.   130.  
 6     -7.91 &lt;NA&gt;    1.54  -0.0589 single  no      &lt;NA&gt;    -20.4    NA      NA    NA   459.   380.  
 7     -2.91 rent    1.54  -6.06   single  no      fixed   -11.4   -50.7 -5233. -337.  259.   230.  
 8     -5.91 owner  13.5    5.94   married no      part…    19.6   -69.7 -2233. -337.  459.    81.8 
 9     -5.91 rent  -10.5  -10.1    separa… no      fixed    -7.42  -12.7 -5233. -337. -591.  -925.  
10     -6.91 rent    1.54  -8.06   married yes     free…    29.6   -40.7 -5233. -337.  -41.1 -125.  
# ℹ 3,553 more rows
# ℹ 1 more variable: Status &lt;fct&gt;</code></pre>
</div>
</div>
<p>Although <code>has_role()</code> and <code>has_type()</code> are available, you’ll most likely rely on functions that are more specific. The docs state (<code>?has_role</code>):</p>
<blockquote class="blockquote">
<p><strong>In most cases</strong>, the right approach for users will be to use the predictor-specific selectors such as <code>all_numeric_predictors()</code> and <code>all_nominal_predictors()</code>.</p>
</blockquote>
<p>These include functions to select variables based on type:</p>
<ul>
<li><code>all_numeric()</code> - includes all numeric variables.</li>
<li><code>all_nominal()</code> - includes both character and factor variables.</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Center **all** numeric variables</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>credit_rec_type <span class="ot">&lt;-</span> <span class="fu">recipe</span>(</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>  Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets,</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> credit_train</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>()) <span class="sc">|&gt;</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>credit_rec_type </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,563 × 4
    Debt Income Assets Status
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt; 
 1 -337.  -60.7 -5233. bad   
 2 -337.  -90.7 -5233. bad   
 3 -337.  -33.7 -5233. bad   
 4  163.  -28.7 -3233. bad   
 5 -337.  -55.7  -233. bad   
 6   NA    NA      NA  bad   
 7 -337.  -50.7 -5233. bad   
 8 -337.  -69.7 -2233. bad   
 9 -337.  -12.7 -5233. bad   
10 -337.  -40.7 -5233. bad   
# ℹ 3,553 more rows</code></pre>
</div>
</div>
<p>Functions to select by role:</p>
<ul>
<li><code>all_predictors()</code></li>
<li><code>all_outcomes()</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Center all predictors</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>credit_rec_role <span class="ot">&lt;-</span> </span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    Status <span class="sc">~</span> Debt <span class="sc">+</span> Income <span class="sc">+</span> Assets, </span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> credit_train</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>credit_rec_role</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,563 × 4
    Debt Income Assets Status
   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;fct&gt; 
 1 -337.  -60.7 -5233. bad   
 2 -337.  -90.7 -5233. bad   
 3 -337.  -33.7 -5233. bad   
 4  163.  -28.7 -3233. bad   
 5 -337.  -55.7  -233. bad   
 6   NA    NA      NA  bad   
 7 -337.  -50.7 -5233. bad   
 8 -337.  -69.7 -2233. bad   
 9 -337.  -12.7 -5233. bad   
10 -337.  -40.7 -5233. bad   
# ℹ 3,553 more rows</code></pre>
</div>
</div>
<p>Functions to select variables that intersect by role and type:</p>
<ul>
<li><code>all_numeric_predictors()</code></li>
<li><code>all_nominal_predictors()</code></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>credit_rec_num_pred <span class="ot">&lt;-</span> </span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(Status <span class="sc">~</span> ., <span class="at">data =</span> credit_train) <span class="sc">|&gt;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>credit_rec_num_pred</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,563 × 14
   Seniority Home    Time      Age Marital Records Job   Expenses Income Assets  Debt Amount   Price
       &lt;dbl&gt; &lt;fct&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;    &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1     -7.91 pare…   1.54   3.94   married no      part…    34.6   -60.7 -5233. -337.  159.    -2.20
 2     -7.91 other -28.5  -16.1    single  yes     part…   -20.4   -90.7 -5233. -337. -641.  -970.  
 3     -5.91 rent   13.5  -12.1    single  no      fixed    -9.42  -33.7 -5233. -337.  459.   719.  
 4     -6.91 owner  13.5    7.94   married no      part…    49.6   -28.7 -3233.  163. -441.  -138.  
 5     -4.91 owner -22.5  -14.1    married no      fixed    19.6   -55.7  -233. -337. -441.   130.  
 6     -7.91 &lt;NA&gt;    1.54  -0.0589 single  no      &lt;NA&gt;    -20.4    NA      NA    NA   459.   380.  
 7     -2.91 rent    1.54  -6.06   single  no      fixed   -11.4   -50.7 -5233. -337.  259.   230.  
 8     -5.91 owner  13.5    5.94   married no      part…    19.6   -69.7 -2233. -337.  459.    81.8 
 9     -5.91 rent  -10.5  -10.1    separa… no      fixed    -7.42  -12.7 -5233. -337. -591.  -925.  
10     -6.91 rent    1.54  -8.06   married yes     free…    29.6   -40.7 -5233. -337.  -41.1 -125.  
# ℹ 3,553 more rows
# ℹ 1 more variable: Status &lt;fct&gt;</code></pre>
</div>
</div>
<p>Selector functions will become useful as we continue to explore the <code>step_*</code> functions within the <code>recipes</code> package.</p>
</section>
<section id="day-04---create-dummy-variables-using-step_dummy" class="level1">
<h1>Day 04 - Create dummy variables using <code>step_dummy()</code></h1>
<p>Before starting our overview of <code>recipes</code>’ <code>step_*</code> functions, we need a bit of direction on what preprocessing steps might be required or beneficial to apply. <strong>The type of data preprocessing is determined by the model being fit.</strong> As a starting point, the <a href="https://www.tmwr.org/pre-proc-table">Tidy Modeling with R</a> book provides an <a href="https://www.tmwr.org/pre-proc-table">appendix</a> with a table of preprocessing recommendations based on the types of models being used. This table is separate from the types of feature engineering that may be applied, but it’s a good baseline for determining the initial <code>step_*</code> functions to be included within a recipe.</p>
<p><a href="https://en.wikipedia.org/wiki/Dummy_variable_(statistics)">Dummy variables</a> is the first preprocessing method highlighted in this appendix. That is, the encoding of qualitative predictors into numeric predictors. Closely related is <a href="https://en.wikipedia.org/wiki/One-hot#Machine_learning_and_statistics">one-hot encoding</a>. When dummy variables are created, most commonly, nominal variable columns are converted into separate columns of 1’s and 0’s. <code>recipes</code>’ <a href="https://recipes.tidymodels.org/reference/step_dummy.html"><code>step_dummy()</code></a> function performs these preprocessing operations.</p>
<p>Let’s continue using the <code>credit_data</code> for today’s examples. Take note, this data contains some <code>NA</code>‘s. To address this issue, I’m just going to drop any cases with a missing value using dplyr’s <code>drop_na()</code> function. Indeed, this issue could be addressed with <a href="https://en.wikipedia.org/wiki/Imputation_(statistics)">imputation</a> through the use of <code>recipes</code>’ <code>step_impute_*</code> functions (more on this in the coming days).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Same code as day 01</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(credit_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,454
Columns: 14
$ Status    &lt;fct&gt; good, good, bad, good, good, good, good, good, good, bad, good, good, good, good…
$ Seniority &lt;int&gt; 9, 17, 10, 0, 0, 1, 29, 9, 0, 0, 6, 7, 8, 19, 0, 0, 15, 33, 0, 1, 2, 5, 1, 27, 2…
$ Home      &lt;fct&gt; rent, rent, owner, rent, rent, owner, owner, parents, owner, parents, owner, own…
$ Time      &lt;int&gt; 60, 60, 36, 60, 36, 60, 60, 12, 60, 48, 48, 36, 60, 36, 18, 24, 24, 24, 48, 60, …
$ Age       &lt;int&gt; 30, 58, 46, 24, 26, 36, 44, 27, 32, 41, 34, 29, 30, 37, 21, 68, 52, 68, 36, 31, …
$ Marital   &lt;fct&gt; married, widow, married, single, single, married, married, single, married, marr…
$ Records   &lt;fct&gt; no, no, yes, no, no, no, no, no, no, no, no, no, no, no, yes, no, no, no, no, no…
$ Job       &lt;fct&gt; freelance, fixed, freelance, fixed, fixed, fixed, fixed, fixed, freelance, parti…
$ Expenses  &lt;int&gt; 73, 48, 90, 63, 46, 75, 75, 35, 90, 90, 60, 60, 75, 75, 35, 75, 35, 65, 45, 35, …
$ Income    &lt;int&gt; 129, 131, 200, 182, 107, 214, 125, 80, 107, 80, 125, 121, 199, 170, 50, 131, 330…
$ Assets    &lt;int&gt; 0, 0, 3000, 2500, 0, 3500, 10000, 0, 15000, 0, 4000, 3000, 5000, 3500, 0, 4162, …
$ Debt      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2500, 260, 0, 0, 0, 2000, 0, 0, 0, 0, 500, 0…
$ Amount    &lt;int&gt; 800, 1000, 2000, 900, 310, 650, 1600, 200, 1200, 1200, 1150, 650, 1500, 600, 400…
$ Price     &lt;int&gt; 846, 1658, 2985, 1325, 910, 1645, 1800, 1093, 1957, 1468, 1577, 915, 1650, 940, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>credit_data <span class="ot">&lt;-</span> credit_data <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create the split, training and testing data</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20230104</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>credit_train <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>credit_test <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s the recipe we’ll use. I’m gonna keep it simple, so it’s easier to observe the results of adding <code>step_dummy()</code> to our recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>    Status <span class="sc">~</span> Job <span class="sc">+</span> Home <span class="sc">+</span> Marital, </span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> credit_train</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create dummy variables from the <code>Job</code> column. But first, let’s take a look at how many different variable levels there are.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">unique</span>(credit_data<span class="sc">$</span>Job)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] freelance fixed     partime   others   
Levels: fixed freelance others partime</code></pre>
</div>
</div>
<p>Since we have four levels (<code>freelance</code>, <code>fixed</code>, <code>partime</code>, <code>others</code>), the <code>step_dummy()</code> function will create three columns. The <code>fixed</code> <code>Job</code> level will be the reference group, since it’s the first level specified for the factor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="sc">|&gt;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(Job) <span class="sc">|&gt;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 6
   Home    Marital Status Job_freelance Job_others Job_partime
   &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;
 1 owner   married good               0          0           0
 2 other   married bad                0          1           0
 3 owner   married good               0          0           0
 4 owner   married good               1          0           0
 5 parents single  good               0          0           0
 6 rent    single  good               0          0           0
 7 parents single  good               0          0           0
 8 other   widow   good               0          0           0
 9 priv    single  good               1          0           0
10 owner   married bad                0          0           0
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<p>Take note of the naming conventions applied to the new dummy columns. <code>step_dummy()</code> uses the following naming convention <code>variable-name_variable-level</code>. This makes it easier to know what variable the dummy variables originated.</p>
<p>Say you don’t want to drop the original column when the dummy variables are created. We can pass <code>TRUE</code> to the <code>keep_original_cols</code> argument. This will retain the original column, while also creating the dummy variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="sc">|&gt;</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(Job, <span class="at">keep_original_cols =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 7
   Job       Home    Marital Status Job_freelance Job_others Job_partime
   &lt;fct&gt;     &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;
 1 fixed     owner   married good               0          0           0
 2 others    other   married bad                0          1           0
 3 fixed     owner   married good               0          0           0
 4 freelance owner   married good               1          0           0
 5 fixed     parents single  good               0          0           0
 6 fixed     rent    single  good               0          0           0
 7 fixed     parents single  good               0          0           0
 8 fixed     other   widow   good               0          0           0
 9 freelance priv    single  good               1          0           0
10 fixed     owner   married bad                0          0           0
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<p>What about one-hot encoding? To apply one-hot encoding we specify <code>FALSE</code> to the <code>one_hot</code> argument within the function. The preprocessed, baked data will now contain four columns. One column for each level of the source column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="sc">|&gt;</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(Job, <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 7
   Home    Marital Status Job_fixed Job_freelance Job_others Job_partime
   &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;      &lt;dbl&gt;         &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;
 1 owner   married good           1             0          0           0
 2 other   married bad            0             0          1           0
 3 owner   married good           1             0          0           0
 4 owner   married good           0             1          0           0
 5 parents single  good           1             0          0           0
 6 rent    single  good           1             0          0           0
 7 parents single  good           1             0          0           0
 8 other   widow   good           1             0          0           0
 9 priv    single  good           0             1          0           0
10 owner   married bad            1             0          0           0
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<p>We can scale this preprocessing to all nominal predictors by using, you guessed it, selector functions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="sc">|&gt;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 13
   Status Job_freelance Job_others Job_partime Home_other Home_owner Home_parents Home_priv
   &lt;fct&gt;          &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt;      &lt;dbl&gt;        &lt;dbl&gt;     &lt;dbl&gt;
 1 good               0          0           0          0          1            0         0
 2 bad                0          1           0          1          0            0         0
 3 good               0          0           0          0          1            0         0
 4 good               1          0           0          0          1            0         0
 5 good               0          0           0          0          0            1         0
 6 good               0          0           0          0          0            0         0
 7 good               0          0           0          0          0            1         0
 8 good               0          0           0          1          0            0         0
 9 good               1          0           0          0          0            0         1
10 bad                0          0           0          0          1            0         0
# ℹ 3,221 more rows
# ℹ 5 more variables: Home_rent &lt;dbl&gt;, Marital_married &lt;dbl&gt;, Marital_separated &lt;dbl&gt;,
#   Marital_single &lt;dbl&gt;, Marital_widow &lt;dbl&gt;</code></pre>
</div>
</div>
<p>That’s a lot of additional columns. How can we keep track of all these additional columns and how they were preprocessed? We can <code>summary</code> and <code>tidy</code> our prepped recipe. Summarizing the prepped recipe is useful because of the <code>source</code> column that gets outputted. In our example, the source column of the returned tibble contains two values: original (i.e., the column was an original column in the data set) and derived (i.e., a column created from the preprocessing step). When we <code>tidy()</code> the recipe object returned from <code>step_dummy()</code>, a tibble with two columns is returned: <code>terms</code> and <code>columns</code>. <code>terms</code> represents the original variable the dummy variables were created from. <code>columns</code> represents the newly preprocessed dummy variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prep our dummy variables</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> </span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>  credit_rec <span class="sc">|&gt;</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(credit_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 4
   variable          type      role      source  
   &lt;chr&gt;             &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
 1 Status            &lt;chr [3]&gt; outcome   original
 2 Job_freelance     &lt;chr [2]&gt; predictor derived 
 3 Job_others        &lt;chr [2]&gt; predictor derived 
 4 Job_partime       &lt;chr [2]&gt; predictor derived 
 5 Home_other        &lt;chr [2]&gt; predictor derived 
 6 Home_owner        &lt;chr [2]&gt; predictor derived 
 7 Home_parents      &lt;chr [2]&gt; predictor derived 
 8 Home_priv         &lt;chr [2]&gt; predictor derived 
 9 Home_rent         &lt;chr [2]&gt; predictor derived 
10 Marital_married   &lt;chr [2]&gt; predictor derived 
11 Marital_separated &lt;chr [2]&gt; predictor derived 
12 Marital_single    &lt;chr [2]&gt; predictor derived 
13 Marital_widow     &lt;chr [2]&gt; predictor derived </code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View what preprocessing steps are applied</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type  trained skip  id         
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;      
1      1 step      dummy TRUE    FALSE dummy_9a72e</code></pre>
</div>
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drill down and view what was done in during this specific step </span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 3
   terms   columns   id         
   &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;      
 1 Job     freelance dummy_9a72e
 2 Job     others    dummy_9a72e
 3 Job     partime   dummy_9a72e
 4 Home    other     dummy_9a72e
 5 Home    owner     dummy_9a72e
 6 Home    parents   dummy_9a72e
 7 Home    priv      dummy_9a72e
 8 Home    rent      dummy_9a72e
 9 Marital married   dummy_9a72e
10 Marital separated dummy_9a72e
11 Marital single    dummy_9a72e
12 Marital widow     dummy_9a72e</code></pre>
</div>
</div>
<p>When it comes to specifying interactions within a model, there are some special considerations when using dummy variables. I don’t have much time to discuss this today, but I hope to address it on a future day of this challenge. I suggest reviewing the ‘Interactions with Dummy Variables’ section from the ‘Dummies’ vignette (<code>vignettes("Dummies", package = "recipes")</code>) for more information.</p>
<p>One more thing, <code>step_dummy()</code> is useful for straight forward dummy variable creation. However, <code>recipes</code> also has some other closely related <code>step_*</code> functions. Here is a list of a few from the ‘Dummies’ vignette:</p>
<ul>
<li><code>step_other()</code> - collapses infrequently occurring levels into an ‘other’ category.</li>
<li><code>step_holiday()</code> - creates dummy variables from dates to capture holidays. Useful when working with time series data.</li>
<li><code>step_zv()</code> - removes dummy variables that are zero-variance.</li>
</ul>
<p>I look to highlight the use of some of these <code>step_*</code> functions in the coming days.</p>
</section>
<section id="day-05---create-a-binary-indicator-variable-for-holidays-using-step_holiday" class="level1">
<h1>Day 05 - Create a binary indicator variable for holidays using <code>step_holiday()</code></h1>
<p>Staying on the topic of dummy variables, I wanted to take a day to focus on the use of <code>recipes</code>’ <code>step_holiday()</code> function. It seems to be pretty useful when working with time series data.</p>
<p>For today’s example, I’m going to use some obfuscated, simulated <a href="https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset">Google Analytics ecommerce data</a>. This emulates data closely related to what would be collected for the <a href="https://shop.googlemerchandisestore.com/">Google Merchandise Store</a>. You can learn more about this data by clicking on the previously linked docs. Let’s do some data wrangling.</p>
<p>Some notes about what wrangling was done:</p>
<ul>
<li>Parse the <code>event_date</code> column into a date variable.</li>
<li>Calculate the revenue generated from the purchase of items based on quantity.</li>
<li>Retain only relevant columns.</li>
</ul>
<p>For simplicity, I’m not going to create a testing training split for this data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> </span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_date =</span> <span class="fu">ymd</span>(event_date),</span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> price_in_usd <span class="sc">*</span> quantity</span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(event_date, transaction_id, item_category, revenue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
<p>Let’s start on our recipe. Since we have an id variable, <code>transaction_id</code>, let’s update the recipe to change it’s role to <code>id</code>. Once we do that, we can pass the <code>event_date</code> to the <code>step_holiday()</code> function. Before we bake our recipe, I wanna <code>prep()</code> and summarise the preprocessing to see what columns will get added.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(revenue <span class="sc">~</span> ., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(transaction_id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() </span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 4
  variable                type      role      source  
  &lt;chr&gt;                   &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
1 event_date              &lt;chr [1]&gt; predictor original
2 transaction_id          &lt;chr [2]&gt; id        original
3 item_category           &lt;chr [3]&gt; predictor original
4 revenue                 &lt;chr [2]&gt; outcome   original
5 event_date_LaborDay     &lt;chr [2]&gt; predictor derived 
6 event_date_NewYearsDay  &lt;chr [2]&gt; predictor derived 
7 event_date_ChristmasDay &lt;chr [2]&gt; predictor derived </code></pre>
</div>
</div>
<p>Note, three new columns will be added once the recipe is baked. This includes:</p>
<ul>
<li><code>event_date_LaborDay</code> - a dummy variable to represent an item purchases on <a href="https://en.wikipedia.org/wiki/Labor_Day">Labor Day</a>.</li>
<li><code>event_date_NewYearsDay</code> - a dummy variable to represent item purchases on New Years Day.</li>
<li><code>event_date_ChristmasDay</code> - a dummy variable to represent item purchases made on Christmas Day.</li>
</ul>
<p>You can see the variables that get added by baking the recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,365 × 7
   event_date transaction_id item_category       revenue event_date_LaborDay event_date_NewYearsDay
   &lt;date&gt;              &lt;dbl&gt; &lt;fct&gt;                 &lt;dbl&gt;               &lt;int&gt;                  &lt;int&gt;
 1 2020-12-01          10648 Clearance                12                   0                      0
 2 2020-12-01          10648 Accessories               2                   0                      0
 3 2020-12-01          10648 Drinkware                 4                   0                      0
 4 2020-12-01          10648 Small Goods               2                   0                      0
 5 2020-12-01          10648 Office                    3                   0                      0
 6 2020-12-01          10648 Accessories               3                   0                      0
 7 2020-12-01          10648 Apparel                  14                   0                      0
 8 2020-12-01         171491 Apparel                  48                   0                      0
 9 2020-12-01         171491 Drinkware                14                   0                      0
10 2020-12-01         174748 Uncategorized Items      44                   0                      0
# ℹ 9,355 more rows
# ℹ 1 more variable: event_date_ChristmasDay &lt;int&gt;</code></pre>
</div>
</div>
<p>Labor Day, New Years Day, and Christmas Day are the default holidays preprocessed by the function. You can modify this by passing a character vector of holidays to <code>step_holiday()</code>’s <code>holidays</code> argument. For instance, say we wanted to create dummy variables for <a href="https://en.wikipedia.org/wiki/Boxing_Day">Boxing Day</a> and the <a href="https://en.wikipedia.org/wiki/Thanksgiving_(United_States)">United State’s Thanksgiving Day</a> holiday, while excluding Labor Day. The following code will specify this preprocessing step for us:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>ga_rec_holidays <span class="ot">&lt;-</span> <span class="fu">recipe</span>(revenue <span class="sc">~</span> ., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(transaction_id, <span class="at">new_role =</span> <span class="st">"transaction_id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    event_date, </span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">holidays =</span> <span class="fu">c</span>(<span class="st">"USThanksgivingDay"</span>, <span class="st">"ChristmasDay"</span>, <span class="st">"BoxingDay"</span>, <span class="st">"NewYearsDay"</span>)</span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ga_rec_holidays)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
  variable                     type      role           source  
  &lt;chr&gt;                        &lt;list&gt;    &lt;chr&gt;          &lt;chr&gt;   
1 event_date                   &lt;chr [1]&gt; predictor      original
2 transaction_id               &lt;chr [2]&gt; transaction_id original
3 item_category                &lt;chr [3]&gt; predictor      original
4 revenue                      &lt;chr [2]&gt; outcome        original
5 event_date_USThanksgivingDay &lt;chr [2]&gt; predictor      derived 
6 event_date_ChristmasDay      &lt;chr [2]&gt; predictor      derived 
7 event_date_BoxingDay         &lt;chr [2]&gt; predictor      derived 
8 event_date_NewYearsDay       &lt;chr [2]&gt; predictor      derived </code></pre>
</div>
</div>
<p>Now we have a dummy variable for all four of these holidays. Let’s bake our recipe and see the final result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec_holidays, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,365 × 8
   event_date transaction_id item_category     revenue event_date_USThanksg…¹ event_date_Christmas…²
   &lt;date&gt;              &lt;dbl&gt; &lt;fct&gt;               &lt;dbl&gt;                  &lt;int&gt;                  &lt;int&gt;
 1 2020-12-01          10648 Clearance              12                      0                      0
 2 2020-12-01          10648 Accessories             2                      0                      0
 3 2020-12-01          10648 Drinkware               4                      0                      0
 4 2020-12-01          10648 Small Goods             2                      0                      0
 5 2020-12-01          10648 Office                  3                      0                      0
 6 2020-12-01          10648 Accessories             3                      0                      0
 7 2020-12-01          10648 Apparel                14                      0                      0
 8 2020-12-01         171491 Apparel                48                      0                      0
 9 2020-12-01         171491 Drinkware              14                      0                      0
10 2020-12-01         174748 Uncategorized It…      44                      0                      0
# ℹ 9,355 more rows
# ℹ abbreviated names: ¹​event_date_USThanksgivingDay, ²​event_date_ChristmasDay
# ℹ 2 more variables: event_date_BoxingDay &lt;int&gt;, event_date_NewYearsDay &lt;int&gt;</code></pre>
</div>
</div>
<p>Indeed, there are many holidays that could be specified for dummy variable creation. All the available holidays can be seen by running <code>timeDate::listHolidays()</code> in your console. Last time I checked, there were 118 available holidays.</p>
</section>
<section id="day-06---use-step_zv-to-drop-variables-with-one-value" class="level1">
<h1>Day 06 - Use <code>step_zv()</code> to drop variables with one value</h1>
<p>For today, I’m focusing on <code>recipes</code>’ <code>step_zv()</code> function. This function is a filter function, which drops variables that only contain one value.</p>
<p>At first, I didn’t really understand why <code>step_zv()</code> was made available. Why would you want a step to drop variables within a recipe? Then it clicked working on yesterday’s example using the obfuscated <a href="https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset">Google Analytics data</a> for the <a href="https://shop.googlemerchandisestore.com/">Google Merchandise store</a>.</p>
<p>But first, let’s get our data again and specify our recipe. I’m going to keep things simple here. First, I’m just going to use <code>data_ga</code>, which was previously wrangled in yesterday’s post (check it out if you want more info). Second, I’m going to skip creating a testing and training split. Lastly, I’m going to create dummy variables using <code>step_holiday()</code>, just to show how <code>step_zv()</code> can be useful.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(revenue <span class="sc">~</span> ., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(event_date)</span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  variable       type      role      source  
  &lt;chr&gt;          &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
1 event_date     &lt;chr [1]&gt; predictor original
2 transaction_id &lt;chr [2]&gt; predictor original
3 item_category  &lt;chr [3]&gt; predictor original
4 revenue        &lt;chr [2]&gt; outcome   original</code></pre>
</div>
</div>
<p>Let’s take a closer look at our data. You’ll notice the range of the <code>event_date</code> is a subset of data. <code>data_ga</code>’s <code>event_date</code> ranges between the US holiday season. It starts right before Christmas and moves into the first month of the new year.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_date =</span> <span class="fu">min</span>(data_ga<span class="sc">$</span>event_date), </span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_date =</span> <span class="fu">max</span>(data_ga<span class="sc">$</span>event_date)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    min_date     max_date 
"2020-12-01" "2021-01-30" </code></pre>
</div>
</div>
<p>If you remember from yesterday’s post, one of the default holidays for <code>step_holiday()</code> is Labor Day. As such, a dummy variable with all <code>0</code>’s will be created for the Labor Day holiday. Purchases made on these dates were not included within this data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>ga_prep <span class="ot">&lt;-</span> <span class="fu">prep</span>(ga_rec)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_prep, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  terms      holiday      id           
  &lt;chr&gt;      &lt;chr&gt;        &lt;chr&gt;        
1 event_date LaborDay     holiday_cClNx
2 event_date NewYearsDay  holiday_cClNx
3 event_date ChristmasDay holiday_cClNx</code></pre>
</div>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the unique values</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_prep, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span> </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(event_date_LaborDay) <span class="sc">|&gt;</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(event_date_LaborDay)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  event_date_LaborDay
                &lt;int&gt;
1                   0</code></pre>
</div>
</div>
<p>As such, this variable is not very useful and should be dropped before being applied within our model. This is why <code>step_zv()</code> can be handy, especially in situations where you have a lot of variables that could only have one value. <code>step_zv()</code> makes it easy to drop all unnecessary variables in one step, while allowing you to continue working with a recipe object.</p>
<p>Indeed, keen observers might note this step could be mitigated by modifying the <code>holiday</code> argument in <code>step_holiday()</code>. However, the function’s utility extends beyond just <code>step_holiday()</code>. You might even consider useful as a final step you apply to every recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>ga_rec_drop <span class="ot">&lt;-</span> <span class="fu">recipe</span>(revenue <span class="sc">~</span> ., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>ga_rec_drop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:   1
predictor: 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 9365 data points and 164 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Holiday features from: event_date | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Zero variance filter removed: event_date_LaborDay | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec_drop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  number operation type    trained skip  id           
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;   &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;        
1      1 step      holiday TRUE    FALSE holiday_FpWeG
2      2 step      zv      TRUE    FALSE zv_3cDmc     </code></pre>
</div>
</div>
<p>Take note, the <code>prep()</code> output informs us of the variables that were dropped when the step was applied. This is something to keep an eye on, just in case you need to explore situations where many variables are dropped, and you need to explore what your recipe is actually doing.</p>
<p>For completeness, lets <code>bake()</code> our final recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(revenue <span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_holiday</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9,365 × 6
   event_date transaction_id item_category     revenue event_date_NewYearsDay event_date_Christmas…¹
   &lt;date&gt;              &lt;dbl&gt; &lt;fct&gt;               &lt;dbl&gt;                  &lt;int&gt;                  &lt;int&gt;
 1 2020-12-01          10648 Clearance              12                      0                      0
 2 2020-12-01          10648 Accessories             2                      0                      0
 3 2020-12-01          10648 Drinkware               4                      0                      0
 4 2020-12-01          10648 Small Goods             2                      0                      0
 5 2020-12-01          10648 Office                  3                      0                      0
 6 2020-12-01          10648 Accessories             3                      0                      0
 7 2020-12-01          10648 Apparel                14                      0                      0
 8 2020-12-01         171491 Apparel                48                      0                      0
 9 2020-12-01         171491 Drinkware              14                      0                      0
10 2020-12-01         174748 Uncategorized It…      44                      0                      0
# ℹ 9,355 more rows
# ℹ abbreviated name: ¹​event_date_ChristmasDay</code></pre>
</div>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 9,365
Columns: 6
$ event_date              &lt;date&gt; 2020-12-01, 2020-12-01, 2020-12-01, 2020-12-01, 2020-12-01, 2020-…
$ transaction_id          &lt;dbl&gt; 10648, 10648, 10648, 10648, 10648, 10648, 10648, 171491, 171491, 1…
$ item_category           &lt;fct&gt; Clearance, Accessories, Drinkware, Small Goods, Office, Accessorie…
$ revenue                 &lt;dbl&gt; 12, 2, 4, 2, 3, 3, 14, 48, 14, 44, 14, 14, 1, 4, 16, 14, 92, 371, …
$ event_date_NewYearsDay  &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …
$ event_date_ChristmasDay &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, …</code></pre>
</div>
</div>
</section>
<section id="day-07---use-step_impute_-functions-for-imputation" class="level1">
<h1>Day 07 - Use <code>step_impute_*()</code> functions for imputation</h1>
<p>The <code>recipes</code> package makes it easy to perform <a href="https://en.wikipedia.org/wiki/Imputation_(statistics)">imputation</a> tasks. As of this writing, <code>recipes</code> had the following functions to perform different methods of imputation:</p>
<ul>
<li><code>step_impute_bag()</code></li>
<li><code>step_impute_knn()</code></li>
<li><code>step_impute_linear()</code></li>
<li><code>step_impute_lower()</code></li>
<li><code>step_impute_mean()</code></li>
<li><code>step_impute_median()</code></li>
<li><code>step_impute_mode()</code></li>
<li><code>step_impute_roll()</code></li>
</ul>
<p>For today’s examples, I’m going to highlight the use of <code>step_impute_mean()</code>, <code>step_input_median()</code>, and <code>step_input_mode()</code>. First, though, we need some data with missing values. Let’s switch it up a bit and use the <a href="https://github.com/allisonhorst/palmerpenguins">Palmer Station penguin data</a> (run ?penguins in your console to get more information about the data). In brief, these data represent different measurements of various <a href="https://en.wikipedia.org/wiki/Penguin">penguin</a> species in Antarctica.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(penguins, <span class="at">package =</span> <span class="st">"modeldata"</span>) </span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add an id column</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>penguins <span class="ot">&lt;-</span> </span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>  penguins <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">.before =</span> <span class="fu">everything</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This data set contains some missing values that could be addressed using imputation methods. Let’s take a moment and explore the data a little further.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(penguins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 344
Columns: 8
$ id                &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 2…
$ species           &lt;fct&gt; Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, …
$ island            &lt;fct&gt; Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torger…
$ bill_length_mm    &lt;dbl&gt; 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, 42.0, 37.8, 37.8, 41…
$ bill_depth_mm     &lt;dbl&gt; 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, 20.2, 17.1, 17.3, 17…
$ flipper_length_mm &lt;int&gt; 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186, 180, 182, 191, 198…
$ body_mass_g       &lt;int&gt; 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, 4250, 3300, 3700, 32…
$ sex               &lt;fct&gt; male, female, female, NA, female, male, female, male, NA, NA, NA, NA, fe…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What columns have missing data?</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(penguins, \(x) <span class="fu">any</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  id    species island bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex  
  &lt;lgl&gt; &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;          &lt;lgl&gt;         &lt;lgl&gt;             &lt;lgl&gt;       &lt;lgl&gt;
1 FALSE FALSE   FALSE  TRUE           TRUE          TRUE              TRUE        TRUE </code></pre>
</div>
<div class="sourceCode cell-code" id="cb131"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># What percentage of data is missing in each column?</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(penguins, \(x) <span class="fu">mean</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$id
[1] 0

$species
[1] 0

$island
[1] 0

$bill_length_mm
[1] 0.005813953

$bill_depth_mm
[1] 0.005813953

$flipper_length_mm
[1] 0.005813953

$body_mass_g
[1] 0.005813953

$sex
[1] 0.03197674</code></pre>
</div>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Missing data examples</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a>missing_examples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">69</span>, <span class="dv">272</span>)</span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> <span class="fu">slice</span>(missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           NA            NA                  NA          NA &lt;NA&gt;  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt;  
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              NA            NA                  NA          NA &lt;NA&gt;  </code></pre>
</div>
</div>
<p>The following columns contain missing data (included are the variable types):</p>
<ul>
<li><code>bill_length_mm</code> - double</li>
<li><code>bill_depth_mm</code> - double</li>
<li><code>flipper_length_mm</code> - integer</li>
<li><code>body_mass_g</code> - integer</li>
<li><code>sex</code> - factor</li>
</ul>
<p>You’ll also notice some of these variables are of various types (i.e.&nbsp;factor, double, or integer). Indeed, the variable type will determine the method of imputation applied.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240107</span>)</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>penguins_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(penguins, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>penguins_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(penguins_split)</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>penguins_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(penguins_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start by highlighting how to apply <a href="https://en.wikipedia.org/wiki/Imputation_(statistics)#Mean_substitution">mean substitution</a> as our imputation method. Specifically, let’s apply this step to our first numeric variable with missing values, <code>bill_length_mm</code>.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Take note of the importance of the use of <code>prep()</code> here. Remember, some recipe steps need to calculate an intermediate value before applying it to the final baked data. This is highlighted with the <code>tidy(penquin_rec, number = 1)</code> in the code below.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>penguins_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mean</span>(bill_length_mm) <span class="sc">|&gt;</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(penguins_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
  variable          type      role      source  
  &lt;chr&gt;             &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
1 id                &lt;chr [2]&gt; id        original
2 species           &lt;chr [3]&gt; predictor original
3 island            &lt;chr [3]&gt; predictor original
4 bill_length_mm    &lt;chr [2]&gt; predictor original
5 bill_depth_mm     &lt;chr [2]&gt; predictor original
6 flipper_length_mm &lt;chr [2]&gt; predictor original
7 body_mass_g       &lt;chr [2]&gt; predictor original
8 sex               &lt;chr [3]&gt; predictor original</code></pre>
</div>
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms          value id               
  &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;            
1 bill_length_mm  43.7 impute_mean_yJPI2</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>penguins_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguins_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>penguins_baked</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1    35 Adelie    Dream               36.4          17                 195        3325 female
 2   111 Adelie    Biscoe              38.1          16.5               198        3825 female
 3   245 Gentoo    Biscoe              45.5          14.5               212        4750 female
 4    75 Adelie    Torgersen           35.5          17.5               190        3700 female
 5     1 Adelie    Torgersen           39.1          18.7               181        3750 male  
 6    96 Adelie    Dream               40.8          18.9               208        4300 male  
 7   338 Chinstrap Dream               46.8          16.5               189        3650 female
 8    24 Adelie    Biscoe              38.2          18.1               185        3950 male  
 9    20 Adelie    Torgersen           46            21.5               194        4200 male  
10    40 Adelie    Dream               39.8          19.1               184        4650 male  
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Imputation should result in a complete column of data</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a><span class="fu">any</span>(<span class="fu">is.na</span>(penguins_baked<span class="sc">$</span>bill_length_mm))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The missing values have now been substituted</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a>penguins_baked <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex  
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt;
1   272 Gentoo  Biscoe              43.7          NA                  NA          NA &lt;NA&gt; 
2     4 Adelie  Torgersen           43.7          NA                  NA          NA &lt;NA&gt; 
3    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt; </code></pre>
</div>
</div>
<p><code>step_impute_mean()</code> also includes a <code>trim</code> argument, which trims observations from the end of the variable before the mean is computed. This is also a tuning parameter, which can be used in any <a href="https://www.tmwr.org/tuning">hyperparameter tuning</a> applied within your modeling. I would like to explore this more, but it’s outside the scope of this post. Just to highlight the use of the <code>trim</code> argument, here’s some example code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a>penguin_mean_trim_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mean</span>(bill_length_mm, <span class="at">trim =</span> .<span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Notice how the intermediate calculation changed because</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a><span class="co"># we trimmed the observations used to make the mean calculation</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguin_mean_trim_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms          value id               
  &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;            
1 bill_length_mm    44 impute_mean_sGprM</code></pre>
</div>
</div>
<p>Let’s bake this recipe for completeness.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a>penguins_mean_trim_baked <span class="ot">&lt;-</span> </span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(penguin_mean_trim_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a>penguins_mean_trim_baked</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1    35 Adelie    Dream               36.4          17                 195        3325 female
 2   111 Adelie    Biscoe              38.1          16.5               198        3825 female
 3   245 Gentoo    Biscoe              45.5          14.5               212        4750 female
 4    75 Adelie    Torgersen           35.5          17.5               190        3700 female
 5     1 Adelie    Torgersen           39.1          18.7               181        3750 male  
 6    96 Adelie    Dream               40.8          18.9               208        4300 male  
 7   338 Chinstrap Dream               46.8          16.5               189        3650 female
 8    24 Adelie    Biscoe              38.2          18.1               185        3950 male  
 9    20 Adelie    Torgersen           46            21.5               194        4200 male  
10    40 Adelie    Dream               39.8          19.1               184        4650 male  
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The missing values have now been imputed</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a>penguins_mean_trim_baked <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex  
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt;
1   272 Gentoo  Biscoe              44            NA                  NA          NA &lt;NA&gt; 
2     4 Adelie  Torgersen           44            NA                  NA          NA &lt;NA&gt; 
3    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt; </code></pre>
</div>
</div>
<p>Mean substitution is just one imputation step. The <code>recipes</code> package also includes the <code>step_impute_median()</code> and <code>step_impute_mode()</code>. These step functions have similar syntax, just a different calculated metric is applied in the background. Let’s apply <code>step_impute_median()</code> to <code>bill_depth_mm</code>, <code>flipper_length_mm</code>, and <code>body_mass_g</code>.</p>
<p>In addition, we’ll apply <code>step_impute_mode()</code> to impute values for the missing data within the <code>sex</code> variable. Take note, the docs for this function state:</p>
<blockquote class="blockquote">
<p>Impute nominal data using the most common value.</p>
</blockquote>
<p>So, it only seems <code>step_impute_mode()</code> can only be used to impute missing values for nominal variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mean</span>(bill_length_mm) <span class="sc">|&gt;</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_median</span>(</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    bill_depth_mm, </span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    flipper_length_mm, </span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    body_mass_g</span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(sex) <span class="sc">|&gt;</span></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a>penguin_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 8</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 275 data points and 11 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Mean imputation for: bill_length_mm | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Median imputation for: bill_depth_mm, flipper_length_mm, body_mass_g | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Mode imputation for: sex | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb167-1"><a href="#cb167-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguin_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  number operation type          trained skip  id                 
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;         &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;              
1      1 step      impute_mean   TRUE    FALSE impute_mean_fOycb  
2      2 step      impute_median TRUE    FALSE impute_median_zocWX
3      3 step      impute_mode   TRUE    FALSE impute_mode_PGohX  </code></pre>
</div>
</div>
<p>Let’s take a look at the calculated values for all these steps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, \(x) <span class="fu">tidy</span>(penguin_rec, <span class="at">number =</span> x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
# A tibble: 1 × 3
  terms          value id               
  &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;            
1 bill_length_mm  43.7 impute_mean_fOycb

[[2]]
# A tibble: 3 × 3
  terms              value id                 
  &lt;chr&gt;              &lt;dbl&gt; &lt;chr&gt;              
1 bill_depth_mm       17.3 impute_median_zocWX
2 flipper_length_mm  196   impute_median_zocWX
3 body_mass_g       4050   impute_median_zocWX

[[3]]
# A tibble: 1 × 3
  terms value  id               
  &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;            
1 sex   female impute_mode_PGohX</code></pre>
</div>
</div>
<p>As always, let’s bake this recipe and look at the final data, which should now contain no missing data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>baked_penguin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1    35 Adelie    Dream               36.4          17                 195        3325 female
 2   111 Adelie    Biscoe              38.1          16.5               198        3825 female
 3   245 Gentoo    Biscoe              45.5          14.5               212        4750 female
 4    75 Adelie    Torgersen           35.5          17.5               190        3700 female
 5     1 Adelie    Torgersen           39.1          18.7               181        3750 male  
 6    96 Adelie    Dream               40.8          18.9               208        4300 male  
 7   338 Chinstrap Dream               46.8          16.5               189        3650 female
 8    24 Adelie    Biscoe              38.2          18.1               185        3950 male  
 9    20 Adelie    Torgersen           46            21.5               194        4200 male  
10    40 Adelie    Dream               39.8          19.1               184        4650 male  
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(baked_penguin, \(x) <span class="fu">any</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  id    species island bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex  
  &lt;lgl&gt; &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;          &lt;lgl&gt;         &lt;lgl&gt;             &lt;lgl&gt;       &lt;lgl&gt;
1 FALSE FALSE   FALSE  FALSE          FALSE         FALSE             FALSE       FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb175"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb175-1"><a href="#cb175-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1   272 Gentoo  Biscoe              43.7          17.3               196        4050 female
2     4 Adelie  Torgersen           43.7          17.3               196        4050 female
3    12 Adelie  Torgersen           37.8          17.3               180        3700 female</code></pre>
</div>
</div>
<p>That’s all the time I have for today. Tomorrow I’ll pick up exploring some more of the other <code>step_impute_*</code> functions.</p>
</section>
<section id="day-08---use-bagged-tree-models-to-impute-missing-data-with-step_impute_bag" class="level1">
<h1>Day 08 - Use bagged tree models to impute missing data with <code>step_impute_bag()</code></h1>
<p>To start, I wanted to highlight a really good, simplified definition of imputation from the <a href="https://bookdown.org/max/FES/">Feature Engineering and Selection: A Practical Approach for Predictive Models</a> book by Max Kuhn and Kjell Johnson.</p>
<blockquote class="blockquote">
<p>Imputation uses information and relationships among the non-missing predictors to provide an estimate to fill in the missing values.</p>
</blockquote>
<p>Yesterday we used the <code>step_impute_mean()</code>, <code>step_impute_median()</code>, and <code>step_impute_mode()</code> functions to calculate missing values. However, we can also use tree-based methods, which uses information from different variables rather than just values in rows, to perform our imputation step.</p>
<p>To be honest, this imputation method was beyond my current knowledge set. Thus, my explanation of what is happening on the backend may be quite general. However, check out the <a href="https://bookdown.org/max/FES/imputation-methods.html">‘Trees’ section</a> from the <a href="https://bookdown.org/max/FES/">Feature Engineering and Selection: A Practical Approach for Predictive Models</a> book for a good starting point to learn more. The book does suggest using bagged models can produce reasonable outputs, which results in values to be produced within the range of the training data. Such methods also retains all predictors, unlike when case-wise deletion is used to manage missing data.</p>
<p><code>recipes</code>’ <code>step_impute_bag()</code> function is used to impute missing data using bagged tree models. To highlight the use of this step, let’s go back to using the <code>penguins</code> data from yesterday.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb177"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb177-1"><a href="#cb177-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(penguins, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb177-2"><a href="#cb177-2" aria-hidden="true" tabindex="-1"></a>missing_examples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">69</span>, <span class="dv">272</span>)</span>
<span id="cb177-3"><a href="#cb177-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-4"><a href="#cb177-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an id variable</span></span>
<span id="cb177-5"><a href="#cb177-5" aria-hidden="true" tabindex="-1"></a>penguins <span class="ot">&lt;-</span> </span>
<span id="cb177-6"><a href="#cb177-6" aria-hidden="true" tabindex="-1"></a>  penguins <span class="sc">|&gt;</span> </span>
<span id="cb177-7"><a href="#cb177-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">.before =</span> <span class="fu">everything</span>())</span>
<span id="cb177-8"><a href="#cb177-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb177-9"><a href="#cb177-9" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(penguins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 344
Columns: 8
$ id                &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 2…
$ species           &lt;fct&gt; Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, …
$ island            &lt;fct&gt; Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torger…
$ bill_length_mm    &lt;dbl&gt; 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, 42.0, 37.8, 37.8, 41…
$ bill_depth_mm     &lt;dbl&gt; 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, 20.2, 17.1, 17.3, 17…
$ flipper_length_mm &lt;int&gt; 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186, 180, 182, 191, 198…
$ body_mass_g       &lt;int&gt; 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, 4250, 3300, 3700, 32…
$ sex               &lt;fct&gt; male, female, female, NA, female, male, female, male, NA, NA, NA, NA, fe…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb179"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb179-1"><a href="#cb179-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the missing examples</span></span>
<span id="cb179-2"><a href="#cb179-2" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           NA            NA                  NA          NA &lt;NA&gt;  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt;  
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              NA            NA                  NA          NA &lt;NA&gt;  </code></pre>
</div>
</div>
<p>We’ll now create our training and testing split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb181"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb181-1"><a href="#cb181-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240108</span>)</span>
<span id="cb181-2"><a href="#cb181-2" aria-hidden="true" tabindex="-1"></a>penguins_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(penguins, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb181-3"><a href="#cb181-3" aria-hidden="true" tabindex="-1"></a>penguins_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(penguins_split)</span>
<span id="cb181-4"><a href="#cb181-4" aria-hidden="true" tabindex="-1"></a>penguins_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(penguins_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To start small, let’s use a bagged tree model to impute values for the missing data in the <code>bill_length_mm</code> variable. The syntax is pretty straightforward:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb182-1"><a href="#cb182-1" aria-hidden="true" tabindex="-1"></a>penguins_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span> (<span class="sc">~</span> ., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb182-2"><a href="#cb182-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb182-3"><a href="#cb182-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(bill_length_mm) <span class="sc">|&gt;</span></span>
<span id="cb182-4"><a href="#cb182-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb182-5"><a href="#cb182-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb182-6"><a href="#cb182-6" aria-hidden="true" tabindex="-1"></a>penguins_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 7
id:        1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 275 data points and 9 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Bagged tree imputation for: bill_length_mm | Trained</code></pre>
</div>
</div>
<p>Before we <code>bake()</code> our recipe, let’s <code>tidy()</code> our prepped recipe a bit to see what’s happening under the hood.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb195"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb195-1"><a href="#cb195-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type       trained skip  id              
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;      &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;           
1      1 step      impute_bag TRUE    FALSE impute_bag_OQalP</code></pre>
</div>
<div class="sourceCode cell-code" id="cb197"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb197-1"><a href="#cb197-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms          model     id              
  &lt;chr&gt;          &lt;list&gt;    &lt;chr&gt;           
1 bill_length_mm &lt;regbagg&gt; impute_bag_OQalP</code></pre>
</div>
</div>
<p>Tidying down to the bagging step, you’ll see this step outputs a tibble with three columns:</p>
<ol type="1">
<li><code>terms</code> - the selectors or variables selected.</li>
<li><code>model</code> - the bagged tree model object.</li>
<li><code>id</code> - a unique id for the step being applied in the recipe.</li>
</ol>
<p>Let’s bake the recipe and see the result of our imputation step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb199-3"><a href="#cb199-3" aria-hidden="true" tabindex="-1"></a>baked_penguin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1    35 Adelie    Dream               36.4          17                 195        3325 female
 2   111 Adelie    Biscoe              38.1          16.5               198        3825 female
 3   245 Gentoo    Biscoe              45.5          14.5               212        4750 female
 4    75 Adelie    Torgersen           35.5          17.5               190        3700 female
 5     1 Adelie    Torgersen           39.1          18.7               181        3750 male  
 6    96 Adelie    Dream               40.8          18.9               208        4300 male  
 7   338 Chinstrap Dream               46.8          16.5               189        3650 female
 8    24 Adelie    Biscoe              38.2          18.1               185        3950 male  
 9    20 Adelie    Torgersen           46            21.5               194        4200 male  
10    40 Adelie    Dream               39.8          19.1               184        4650 male  
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb201"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb201-1"><a href="#cb201-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1   272 Gentoo  Biscoe              43.7          17.3               196        4050 female
2     4 Adelie  Torgersen           43.7          17.3               196        4050 female
3    12 Adelie  Torgersen           37.8          17.3               180        3700 female</code></pre>
</div>
</div>
<p><code>step_impute_bagged()</code> also has several options to modify the imputation method. First, it has an <code>impute_with</code> argument that allows you to be selective about what variables are used as predictors in the bagged tree model. We’ll specify these variables by passing them into the <code>imp_vars()</code> function to the argument.</p>
<p>This argument accepts the various <a href="https://recipes.tidymodels.org/articles/Selecting_Variables.html">selector functions</a> as well. For instance, the default for the argument is the <code>all_predictors()</code> function. The following code uses this argument to limit the imputation to the <code>bill_depth_mm</code> and <code>sex</code> variables (I’m not a biologist, so I have no idea if this is actually a good approach).</p>
<p>I did come across a cryptic warning when first doing this, though. This warning also resulted in the imputation step to not be applied.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb203"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb203-1"><a href="#cb203-1" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span> ., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb203-2"><a href="#cb203-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb203-3"><a href="#cb203-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(</span>
<span id="cb203-4"><a href="#cb203-4" aria-hidden="true" tabindex="-1"></a>    bill_length_mm,</span>
<span id="cb203-5"><a href="#cb203-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(bill_depth_mm, sex)</span>
<span id="cb203-6"><a href="#cb203-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb203-7"><a href="#cb203-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: All predictors are missing; cannot impute</code></pre>
</div>
</div>
<p>I assumed this was because all the predictors used to create the model for imputation had missing values. So, I applied some imputation to these first before applying the <code>step_impute_bag()</code> and the warning went away. However, I’m unsure if this was the initial problem. I might submit an issue to the <a href="https://github.com/tidymodels/recipes"><code>recipes</code> GitHub repo</a> to which I’ll link later. Nevertheless, I got the example to work. Here’s the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb205"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb205-1"><a href="#cb205-1" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb205-2"><a href="#cb205-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb205-3"><a href="#cb205-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mean</span>(bill_depth_mm) <span class="sc">|&gt;</span></span>
<span id="cb205-4"><a href="#cb205-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_mode</span>(sex) <span class="sc">|&gt;</span></span>
<span id="cb205-5"><a href="#cb205-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(</span>
<span id="cb205-6"><a href="#cb205-6" aria-hidden="true" tabindex="-1"></a>    bill_length_mm,</span>
<span id="cb205-7"><a href="#cb205-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(bill_depth_mm)</span>
<span id="cb205-8"><a href="#cb205-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb205-9"><a href="#cb205-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() </span>
<span id="cb205-10"><a href="#cb205-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-11"><a href="#cb205-11" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb205-12"><a href="#cb205-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-13"><a href="#cb205-13" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           41.0          17.2                NA          NA male  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 male  
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              41.0          17.2                NA          NA male  </code></pre>
</div>
</div>
<p>Given we’re using a bagged tree model to perform imputation, we can modify the number of bagged trees used in each model in the <code>step_impute_bag()</code> function. To do this, we just pass a value to the <code>trees</code> argument. Indeed, its suggested to keep this value <a href="https://bookdown.org/max/FES/imputation-methods.html">between 25 - 50 trees</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb207"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb207-1"><a href="#cb207-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The default is 25 trees</span></span>
<span id="cb207-2"><a href="#cb207-2" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb207-3"><a href="#cb207-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb207-4"><a href="#cb207-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(bill_length_mm, <span class="at">trees =</span> <span class="dv">50</span>) <span class="sc">|&gt;</span></span>
<span id="cb207-5"><a href="#cb207-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb207-6"><a href="#cb207-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-7"><a href="#cb207-7" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb207-8"><a href="#cb207-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb207-9"><a href="#cb207-9" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           38.3          NA                  NA          NA &lt;NA&gt;  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt;  
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              47.8          NA                  NA          NA &lt;NA&gt;  </code></pre>
</div>
</div>
<p>The last <code>step_impute_bag()</code> argument I’ll highlight is <code>options</code>. <code>ipred::ipredbagg()</code> implements the bagged model used for this imputation step. Thus, the <code>options</code> argument is used to pass arguments to this function. For example, if we want to speed up execution, we can lower the <code>nbagg</code> argument, the number of bootstrap replications applied, and indicate we don’t want to return a data frame of predictors by setting <code>keepX = FALSE</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb209"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb209-1"><a href="#cb209-1" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb209-2"><a href="#cb209-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb209-3"><a href="#cb209-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(</span>
<span id="cb209-4"><a href="#cb209-4" aria-hidden="true" tabindex="-1"></a>    bill_length_mm,</span>
<span id="cb209-5"><a href="#cb209-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">nbagg =</span> <span class="dv">2</span>, <span class="at">keepX =</span> <span class="cn">FALSE</span>)</span>
<span id="cb209-6"><a href="#cb209-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb209-7"><a href="#cb209-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb209-8"><a href="#cb209-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-9"><a href="#cb209-9" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb209-10"><a href="#cb209-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb209-11"><a href="#cb209-11" aria-hidden="true" tabindex="-1"></a>baked_penguin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1   280 Chinstrap Dream               45.4          18.7               188        3525 female
 2   160 Gentoo    Biscoe              46.7          15.3               219        5200 male  
 3    27 Adelie    Biscoe              40.6          18.6               183        3550 male  
 4   274 Gentoo    Biscoe              50.4          15.7               222        5750 male  
 5   288 Chinstrap Dream               51.7          20.3               194        3775 male  
 6    46 Adelie    Dream               39.6          18.8               190        4600 male  
 7   316 Chinstrap Dream               53.5          19.9               205        4500 male  
 8   286 Chinstrap Dream               51.3          19.9               198        3700 male  
 9   164 Gentoo    Biscoe              49            16.1               216        5550 male  
10    79 Adelie    Torgersen           36.2          16.1               187        3550 female
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb211"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb211-1"><a href="#cb211-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           38.1          NA                  NA          NA &lt;NA&gt;  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt;  
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              48.0          NA                  NA          NA &lt;NA&gt;  </code></pre>
</div>
</div>
<p>Just for the heck of it, let’s apply <code>step_impute_bag()</code> to all predictor variables in our recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb213"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb213-1"><a href="#cb213-1" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb213-2"><a href="#cb213-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb213-3"><a href="#cb213-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_bag</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb213-4"><a href="#cb213-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb213-5"><a href="#cb213-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-6"><a href="#cb213-6" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb213-7"><a href="#cb213-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb213-8"><a href="#cb213-8" aria-hidden="true" tabindex="-1"></a>baked_penguin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1   280 Chinstrap Dream               45.4          18.7               188        3525 female
 2   160 Gentoo    Biscoe              46.7          15.3               219        5200 male  
 3    27 Adelie    Biscoe              40.6          18.6               183        3550 male  
 4   274 Gentoo    Biscoe              50.4          15.7               222        5750 male  
 5   288 Chinstrap Dream               51.7          20.3               194        3775 male  
 6    46 Adelie    Dream               39.6          18.8               190        4600 male  
 7   316 Chinstrap Dream               53.5          19.9               205        4500 male  
 8   286 Chinstrap Dream               51.3          19.9               198        3700 male  
 9   164 Gentoo    Biscoe              49            16.1               216        5550 male  
10    79 Adelie    Torgersen           36.2          16.1               187        3550 female
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb215"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb215-1"><a href="#cb215-1" aria-hidden="true" tabindex="-1"></a><span class="co"># There should now be no missing data</span></span>
<span id="cb215-2"><a href="#cb215-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map_df</span>(baked_penguin, \(x) <span class="fu">any</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  id    species island bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex  
  &lt;lgl&gt; &lt;lgl&gt;   &lt;lgl&gt;  &lt;lgl&gt;          &lt;lgl&gt;         &lt;lgl&gt;             &lt;lgl&gt;       &lt;lgl&gt;
1 FALSE FALSE   FALSE  FALSE          FALSE         FALSE             FALSE       FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb217"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb217-1"><a href="#cb217-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           37.9          17.8               188        3546 male  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 female
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              47.9          14.8               214        5028 female</code></pre>
</div>
</div>
<p>That’s it for today. Tomorrow I’ll focus on the use of <code>step_impute_knn()</code>.</p>
</section>
<section id="day-09---impute-missing-values-using-step_impute_knn" class="level1">
<h1>Day 09 - Impute missing values using <code>step_impute_knn()</code></h1>
<p>Today, we’re focusing on imputing missing data using <code>recipes</code>’ <code>step_impute_knn()</code> function. In short, this function uses a k-nearest neighbors approach to impute missing values.</p>
<p>For today’s examples, I’m going to stick with the <code>penguins</code> data we’ve been using the past few days. Given this data is relatively small (n = 344), it’s a <a href="https://bookdown.org/max/FES/imputation-methods.html">good candidate</a> for using a k-nearest neighbor approach to imputation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb219"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb219-1"><a href="#cb219-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(penguins, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb219-2"><a href="#cb219-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-3"><a href="#cb219-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a row id</span></span>
<span id="cb219-4"><a href="#cb219-4" aria-hidden="true" tabindex="-1"></a>penguins <span class="ot">&lt;-</span> penguins <span class="sc">|&gt;</span></span>
<span id="cb219-5"><a href="#cb219-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">n</span>(), <span class="at">.before =</span> <span class="fu">everything</span>())</span>
<span id="cb219-6"><a href="#cb219-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb219-7"><a href="#cb219-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(penguins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 344
Columns: 8
$ id                &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 2…
$ species           &lt;fct&gt; Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, …
$ island            &lt;fct&gt; Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torger…
$ bill_length_mm    &lt;dbl&gt; 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, 42.0, 37.8, 37.8, 41…
$ bill_depth_mm     &lt;dbl&gt; 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, 20.2, 17.1, 17.3, 17…
$ flipper_length_mm &lt;int&gt; 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186, 180, 182, 191, 198…
$ body_mass_g       &lt;int&gt; 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, 4250, 3300, 3700, 32…
$ sex               &lt;fct&gt; male, female, female, NA, female, male, female, male, NA, NA, NA, NA, fe…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb221"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb221-1"><a href="#cb221-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Percent missing for each column</span></span>
<span id="cb221-2"><a href="#cb221-2" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(penguins, \(x) <span class="fu">mean</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$id
[1] 0

$species
[1] 0

$island
[1] 0

$bill_length_mm
[1] 0.005813953

$bill_depth_mm
[1] 0.005813953

$flipper_length_mm
[1] 0.005813953

$body_mass_g
[1] 0.005813953

$sex
[1] 0.03197674</code></pre>
</div>
</div>
<p>Just for a refresher, let’s peek at a few of the missing values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb223"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb223-1"><a href="#cb223-1" aria-hidden="true" tabindex="-1"></a>missing_examples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">4</span>, <span class="dv">12</span>, <span class="dv">69</span>, <span class="dv">272</span>)</span>
<span id="cb223-2"><a href="#cb223-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb223-3"><a href="#cb223-3" aria-hidden="true" tabindex="-1"></a>penguins <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1     4 Adelie  Torgersen           NA            NA                  NA          NA &lt;NA&gt;  
2    12 Adelie  Torgersen           37.8          17.3               180        3700 &lt;NA&gt;  
3    69 Adelie  Torgersen           35.9          16.6               190        3050 female
4   272 Gentoo  Biscoe              NA            NA                  NA          NA &lt;NA&gt;  </code></pre>
</div>
</div>
<p>Let’s create our training and testing split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb225"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb225-1"><a href="#cb225-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240109</span>)</span>
<span id="cb225-2"><a href="#cb225-2" aria-hidden="true" tabindex="-1"></a>penguins_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(penguins, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb225-3"><a href="#cb225-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb225-4"><a href="#cb225-4" aria-hidden="true" tabindex="-1"></a>penguins_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(penguins_split)</span>
<span id="cb225-5"><a href="#cb225-5" aria-hidden="true" tabindex="-1"></a>penguins_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(penguins_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since imputation can be applied to either numeric or nominal data, <code>step_impute_knn()</code> uses <a href="https://www.jstor.org/stable/2528823">Gower’s distance</a> for calculating nearest neighbors (you can learn more by running <code>?step_impute_knn</code> in your console). Once the neighbors are calculated, nominal variables are predicted using the mean, and numeric data is predicted using the mode. The number of neighbors can be set by specifying the <code>neighbors</code> argument of the function, which can also be used for <a href="https://www.tmwr.org/tuning">hyperparameter tuning</a>.</p>
<p>Let’s start by imputing values for our missing data in the <code>sex</code> column. Here’s the code for this initial recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb226"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb226-1"><a href="#cb226-1" aria-hidden="true" tabindex="-1"></a>penguins_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb226-2"><a href="#cb226-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb226-3"><a href="#cb226-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(sex) <span class="sc">|&gt;</span></span>
<span id="cb226-4"><a href="#cb226-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb226-5"><a href="#cb226-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb226-6"><a href="#cb226-6" aria-hidden="true" tabindex="-1"></a>penguins_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 7
id:        1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 275 data points and 10 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• K-nearest neighbor imputation for: sex | Trained</code></pre>
</div>
</div>
<p>Before we bake and examine what the imputation step does, let’s drill down and see what’s occurring at the prep stage. <code>tidy()</code> will be used to do this. Similar to <code>step_impute_bag()</code>, a tibble of <code>terms</code>, <code>predictors</code>, <code>neighbors</code> (specific to k-nearest neighbors), and an <code>id</code> is returned.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type       trained skip  id              
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;      &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;           
1      1 step      impute_knn TRUE    FALSE impute_knn_dK6OX</code></pre>
</div>
<div class="sourceCode cell-code" id="cb241"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb241-1"><a href="#cb241-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Drill down into the specific impute_knn step</span></span>
<span id="cb241-2"><a href="#cb241-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  terms predictors        neighbors id              
  &lt;chr&gt; &lt;chr&gt;                 &lt;dbl&gt; &lt;chr&gt;           
1 sex   species                   5 impute_knn_dK6OX
2 sex   island                    5 impute_knn_dK6OX
3 sex   bill_length_mm            5 impute_knn_dK6OX
4 sex   bill_depth_mm             5 impute_knn_dK6OX
5 sex   flipper_length_mm         5 impute_knn_dK6OX
6 sex   body_mass_g               5 impute_knn_dK6OX</code></pre>
</div>
</div>
<p>Let’s bake our recipe and examine the result of our imputation step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb243"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb243-1"><a href="#cb243-1" aria-hidden="true" tabindex="-1"></a>baked_penguins <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguins_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb243-2"><a href="#cb243-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb243-3"><a href="#cb243-3" aria-hidden="true" tabindex="-1"></a>baked_penguins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 8
      id species   island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1   168 Gentoo    Biscoe              49.3          15.7               217        5850 male  
 2   196 Gentoo    Biscoe              49.6          15                 216        4750 male  
 3   117 Adelie    Torgersen           38.6          17                 188        2900 female
 4    39 Adelie    Dream               37.6          19.3               181        3300 female
 5   299 Chinstrap Dream               43.2          16.6               187        2900 female
 6   207 Gentoo    Biscoe              46.5          14.4               217        4900 female
 7   167 Gentoo    Biscoe              45.8          14.6               210        4200 female
 8   101 Adelie    Biscoe              35            17.9               192        3725 female
 9   339 Chinstrap Dream               45.7          17                 195        3650 female
10   267 Gentoo    Biscoe              46.2          14.1               217        4375 female
# ℹ 265 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb245"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb245-1"><a href="#cb245-1" aria-hidden="true" tabindex="-1"></a>baked_penguins <span class="sc">|&gt;</span> </span>
<span id="cb245-2"><a href="#cb245-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples) <span class="sc">|&gt;</span> </span>
<span id="cb245-3"><a href="#cb245-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(sex, <span class="at">.after =</span> <span class="dv">1</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id sex    species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
  &lt;int&gt; &lt;fct&gt;  &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt;
1   272 male   Gentoo  Biscoe              NA            NA                  NA          NA
2    69 female Adelie  Torgersen           35.9          16.6               190        3050
3     4 male   Adelie  Torgersen           NA            NA                  NA          NA</code></pre>
</div>
</div>
<p>As mentioned before, <code>neighbors</code> is an argument to set the number of neighbors to use in our estimation. The function defaults to five, but we can modify this to any integer value. It is suggested that <a href="https://bookdown.org/max/FES/imputation-methods.html">5 - 10 neighbors is a sensible default</a>. However, this is dependent on the data you are working with. For our next example, let’s constrain this parameter to 3, while also applying our imputation step to all numeric predictors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb247"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb247-1"><a href="#cb247-1" aria-hidden="true" tabindex="-1"></a>penguins_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb247-2"><a href="#cb247-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb247-3"><a href="#cb247-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">neighbors =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb247-4"><a href="#cb247-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb247-5"><a href="#cb247-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb247-6"><a href="#cb247-6" aria-hidden="true" tabindex="-1"></a>penguins_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 7
id:        1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 275 data points and 10 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• K-nearest neighbor imputation for: bill_length_mm and bill_depth_mm, ... | Trained</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb260"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb260-1"><a href="#cb260-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguins_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb260-2"><a href="#cb260-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb260-3"><a href="#cb260-3" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
  &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
1   272 Gentoo  Biscoe              47.2          15.4               214        5217 &lt;NA&gt;  
2    69 Adelie  Torgersen           35.9          16.6               190        3050 female
3     4 Adelie  Torgersen           36.6          18.3               184        3658 &lt;NA&gt;  </code></pre>
</div>
</div>
<p>Just like <code>step_impute_bag()</code>, <code>step_impute_knn()</code> provides both an <code>impute_with</code> and <code>options</code> argument. We can be explicit about the variables to use with our knn calculations by passing a comma-separated list of names to the <code>imp_vars()</code> function to the <code>impute_with</code> arugment. <code>options</code> accepts a list of arguments. These get passed along to the underlying <code>gower::gower_topn()</code> function running under the hood, which performs the k-nearest neighbors calculation using Gower’s distance. According to the docs, the only two options accepted are:</p>
<ol type="1">
<li><code>nthread</code> - specify the number of threads to use for parallelization.</li>
<li><code>eps</code> - optional option for variable ranges (I’m not quite sure what this does).</li>
</ol>
<p>My assumption is these options can be used to optimize the run-time for our calculations. However, I would consult the documentation for the <code>gower::gower_topn()</code> function to verify. The key takeaway here is that <code>step_impute_knn()</code> provides an interface to configure options for the function it wraps.</p>
<p>Here’s an example constraining our <code>sex</code> imputation to the <code>bill_length</code> and <code>bill_depth_mm</code> variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb262"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb262-1"><a href="#cb262-1" aria-hidden="true" tabindex="-1"></a>penguins_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb262-2"><a href="#cb262-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb262-3"><a href="#cb262-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(</span>
<span id="cb262-4"><a href="#cb262-4" aria-hidden="true" tabindex="-1"></a>    sex, </span>
<span id="cb262-5"><a href="#cb262-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(bill_depth_mm, bill_length_mm)</span>
<span id="cb262-6"><a href="#cb262-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb262-7"><a href="#cb262-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb262-8"><a href="#cb262-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb262-9"><a href="#cb262-9" aria-hidden="true" tabindex="-1"></a>penguins_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 7
id:        1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 275 data points and 10 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• K-nearest neighbor imputation for: sex | Trained</code></pre>
</div>
</div>
<p>Let’s bake our final example and examine what happened.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb275"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb275-1"><a href="#cb275-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguins_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb275-2"><a href="#cb275-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb275-3"><a href="#cb275-3" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="sc">|&gt;</span> </span>
<span id="cb275-4"><a href="#cb275-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples) <span class="sc">|&gt;</span></span>
<span id="cb275-5"><a href="#cb275-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(sex, <span class="at">.after =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 8
     id sex    species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
  &lt;int&gt; &lt;fct&gt;  &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt;
1   272 female Gentoo  Biscoe              NA            NA                  NA          NA
2    69 female Adelie  Torgersen           35.9          16.6               190        3050
3     4 female Adelie  Torgersen           NA            NA                  NA          NA</code></pre>
</div>
</div>
<p>So there you have it, another example of a <code>step_impute_*</code> function. Tomorrow I’ll continue exploring imputation steps by highlighting the use of the <code>step_impute_linear()</code> function.</p>
</section>
<section id="day-10---impute-missing-values-using-a-linear-model-with-step_impute_linear" class="level1">
<h1>Day 10 - Impute missing values using a linear model with <code>step_impute_linear()</code></h1>
<p>So here we are, day 10. We continue our overview of <code>recipes</code>’ imputation steps. Specifically, I’m going to highlight the use of <code>step_impute_linear()</code> for today. <code>step_impute_linear()</code> uses linear regression models to impute missing data. Indeed, when there is a strong, linear relationship between a complete predictor variable and one that requires imputation (i.e., contains missing data), <a href="http://www.feat.engineering/imputation-methods">linear methods for imputation may be a good approach</a>. Such a method is also really quick and requires few computational resources to calculate.</p>
<p>For today’s examples, we’re going back to our <code>credit_data</code> data. You can read more about this data by running <code>?credit_data</code> in your console.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb277"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb277-1"><a href="#cb277-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(credit_data, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb277-2"><a href="#cb277-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-3"><a href="#cb277-3" aria-hidden="true" tabindex="-1"></a>credit_data <span class="ot">&lt;-</span> credit_data <span class="sc">|&gt;</span></span>
<span id="cb277-4"><a href="#cb277-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">id =</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(credit_data)), <span class="at">.before =</span> <span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb277-5"><a href="#cb277-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb277-6"><a href="#cb277-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb277-7"><a href="#cb277-7" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(credit_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 4,454
Columns: 15
$ id        &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 2…
$ Status    &lt;fct&gt; good, good, bad, good, good, good, good, good, good, bad, good, good, good, good…
$ Seniority &lt;int&gt; 9, 17, 10, 0, 0, 1, 29, 9, 0, 0, 6, 7, 8, 19, 0, 0, 15, 33, 0, 1, 2, 5, 1, 27, 2…
$ Home      &lt;fct&gt; rent, rent, owner, rent, rent, owner, owner, parents, owner, parents, owner, own…
$ Time      &lt;int&gt; 60, 60, 36, 60, 36, 60, 60, 12, 60, 48, 48, 36, 60, 36, 18, 24, 24, 24, 48, 60, …
$ Age       &lt;int&gt; 30, 58, 46, 24, 26, 36, 44, 27, 32, 41, 34, 29, 30, 37, 21, 68, 52, 68, 36, 31, …
$ Marital   &lt;fct&gt; married, widow, married, single, single, married, married, single, married, marr…
$ Records   &lt;fct&gt; no, no, yes, no, no, no, no, no, no, no, no, no, no, no, yes, no, no, no, no, no…
$ Job       &lt;fct&gt; freelance, fixed, freelance, fixed, fixed, fixed, fixed, fixed, freelance, parti…
$ Expenses  &lt;int&gt; 73, 48, 90, 63, 46, 75, 75, 35, 90, 90, 60, 60, 75, 75, 35, 75, 35, 65, 45, 35, …
$ Income    &lt;int&gt; 129, 131, 200, 182, 107, 214, 125, 80, 107, 80, 125, 121, 199, 170, 50, 131, 330…
$ Assets    &lt;int&gt; 0, 0, 3000, 2500, 0, 3500, 10000, 0, 15000, 0, 4000, 3000, 5000, 3500, 0, 4162, …
$ Debt      &lt;int&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2500, 260, 0, 0, 0, 2000, 0, 0, 0, 0, 500, 0…
$ Amount    &lt;int&gt; 800, 1000, 2000, 900, 310, 650, 1600, 200, 1200, 1200, 1150, 650, 1500, 600, 400…
$ Price     &lt;int&gt; 846, 1658, 2985, 1325, 910, 1645, 1800, 1093, 1957, 1468, 1577, 915, 1650, 940, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb279"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb279-1"><a href="#cb279-1" aria-hidden="true" tabindex="-1"></a><span class="fu">map</span>(credit_data, \(x) <span class="fu">mean</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$id
[1] 0

$Status
[1] 0

$Seniority
[1] 0

$Home
[1] 0.001347104

$Time
[1] 0

$Age
[1] 0

$Marital
[1] 0.0002245173

$Records
[1] 0

$Job
[1] 0.0004490346

$Expenses
[1] 0

$Income
[1] 0.08554109

$Assets
[1] 0.01055231

$Debt
[1] 0.004041311

$Amount
[1] 0

$Price
[1] 0</code></pre>
</div>
</div>
<p>Let’s peek at some missing data examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb281"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb281-1"><a href="#cb281-1" aria-hidden="true" tabindex="-1"></a>missing_examples <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">114</span>, <span class="dv">195</span>, <span class="dv">206</span>, <span class="dv">242</span>, <span class="dv">496</span>)</span>
<span id="cb281-2"><a href="#cb281-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb281-3"><a href="#cb281-3" aria-hidden="true" tabindex="-1"></a>credit_data <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 15
     id Status Seniority Home   Time   Age Marital Records Job   Expenses Income Assets  Debt Amount
  &lt;int&gt; &lt;fct&gt;      &lt;int&gt; &lt;fct&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;    &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;
1   114 bad            0 owner    36    39 single  no      free…       35     NA   4000     0   1000
2   195 bad            0 other    36    48 married yes     free…       45     NA      0     0   1600
3   206 good          10 owner    36    45 married yes     free…       60     NA   9500   250    750
4   242 bad           10 rent     60    43 married no      free…       90     NA      0     0   1350
5   496 bad            3 owner    60    33 separa… no      free…       35     NA   6000     0    950
# ℹ 1 more variable: Price &lt;int&gt;</code></pre>
</div>
</div>
<p>As mentioned before, linear imputation methods are useful in cases where you have a strong, linear relationship between a complete variable (i.e., contains no missing data) and one where imputation is to be applied. For our example, let’s use linear methods to impute values for missing data in the <code>Income</code> variable. The <code>Senority</code> variable is complete, so we’ll use it for our imputation step. Although the relationship between these two variables isn’t a strong, linear one, let’s use it for example sake.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb283"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb283-1"><a href="#cb283-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Use corrr::correlate() to examine correlation among numeric variables</span></span>
<span id="cb283-2"><a href="#cb283-2" aria-hidden="true" tabindex="-1"></a><span class="fu">correlate</span>(credit_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Non-numeric variables removed from input: `Status`, `Home`, `Marital`, `Records`, and `Job`
Correlation computed with
• Method: 'pearson'
• Missing treated using: 'pairwise.complete.obs'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 11
   term            id Seniority     Time     Age Expenses  Income   Assets     Debt   Amount   Price
   &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
 1 id        NA        -0.00362  8.19e-3 -0.0165 -2.71e-1 -0.116  -0.00533 -0.00578  0.0264   0.0266
 2 Seniority -0.00362  NA       -2.14e-2  0.506   1.26e-1  0.122   0.127   -0.0191  -0.00791  0.0409
 3 Time       0.00819  -0.0214  NA       -0.0517 -8.40e-4 -0.0430 -0.0848   0.0577   0.431    0.130 
 4 Age       -0.0165    0.506   -5.17e-2 NA       2.48e-1  0.147   0.185   -0.0459   0.0292   0.0489
 5 Expenses  -0.271     0.126   -8.40e-4  0.248  NA        0.258   0.0184   0.0148   0.0492   0.0403
 6 Income    -0.116     0.122   -4.30e-2  0.147   2.58e-1 NA       0.237    0.151    0.192    0.227 
 7 Assets    -0.00533   0.127   -8.48e-2  0.185   1.84e-2  0.237  NA        0.191    0.147    0.200 
 8 Debt      -0.00578  -0.0191   5.77e-2 -0.0459  1.48e-2  0.151   0.191   NA        0.0525   0.0456
 9 Amount     0.0264   -0.00791  4.31e-1  0.0292  4.92e-2  0.192   0.147    0.0525  NA        0.725 
10 Price      0.0266    0.0409   1.30e-1  0.0489  4.03e-2  0.227   0.200    0.0456   0.725   NA     </code></pre>
</div>
</div>
<p>We start off by creating our testing and training split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb286"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb286-1"><a href="#cb286-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240110</span>)</span>
<span id="cb286-2"><a href="#cb286-2" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> .<span class="dv">80</span>)</span>
<span id="cb286-3"><a href="#cb286-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb286-4"><a href="#cb286-4" aria-hidden="true" tabindex="-1"></a>credit_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb286-5"><a href="#cb286-5" aria-hidden="true" tabindex="-1"></a>credit_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The docs mention imputed variables must be of type <code>numeric</code>. Also, this method requires predictors to be complete cases. As such, the imputation model will only use training set predictors that don’t have any missing values.</p>
</div>
</div>
<p>Just like we did with other imputation methods that use a modeling approach, we can be specific about what variables to use as predictors. We do this by passing them to the <code>impute_with</code> argument, which are wrapped in the <code>imp_vars()</code> function. Here’s what this looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb287"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb287-1"><a href="#cb287-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb287-2"><a href="#cb287-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(id, <span class="at">new_role =</span> <span class="st">"id"</span>) <span class="sc">|&gt;</span></span>
<span id="cb287-3"><a href="#cb287-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_linear</span>(Income, <span class="at">impute_with =</span> <span class="fu">imp_vars</span>(Seniority)) <span class="sc">|&gt;</span></span>
<span id="cb287-4"><a href="#cb287-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(credit_tr)</span>
<span id="cb287-5"><a href="#cb287-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb287-6"><a href="#cb287-6" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14
id:         1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 3563 data points and 319 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Linear regression imputation for: Income | Trained</code></pre>
</div>
</div>
<p>Before we bake our recipe, let’s take a look at what’s happening under the hood with <code>tidy()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb300"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb300-1"><a href="#cb300-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type          trained skip  id                 
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;         &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;              
1      1 step      impute_linear TRUE    FALSE impute_linear_5l9Ot</code></pre>
</div>
<div class="sourceCode cell-code" id="cb302"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb302-1"><a href="#cb302-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms  model  id                 
  &lt;chr&gt;  &lt;list&gt; &lt;chr&gt;              
1 Income &lt;lm&gt;   impute_linear_5l9Ot</code></pre>
</div>
</div>
<p>A tibble is outputted with three columns:</p>
<ol type="1">
<li><code>terms</code> - the variable we’re seeking to replace missing values with imputed values.</li>
<li><code>model</code> - the model object used to calculate the imputed value. Note, the model object is <code>lm</code>.</li>
<li><code>id</code> - a unique id for the step being performed.</li>
</ol>
<p>Ready, get set, bake.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb304"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb304-1"><a href="#cb304-1" aria-hidden="true" tabindex="-1"></a>credit_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb304-2"><a href="#cb304-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb304-3"><a href="#cb304-3" aria-hidden="true" tabindex="-1"></a><span class="co"># View some of the imputed values</span></span>
<span id="cb304-4"><a href="#cb304-4" aria-hidden="true" tabindex="-1"></a>credit_baked <span class="sc">|&gt;</span> <span class="fu">filter</span>(id <span class="sc">%in%</span> missing_examples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 15
     id Status Seniority Home   Time   Age Marital Records Job   Expenses Income Assets  Debt Amount
  &lt;int&gt; &lt;fct&gt;      &lt;int&gt; &lt;fct&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;    &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;
1   496 bad            3 owner    60    33 separa… no      free…       35    135   6000     0    950
2   242 bad           10 rent     60    43 married no      free…       90    143      0     0   1350
3   206 good          10 owner    36    45 married yes     free…       60    143   9500   250    750
# ℹ 1 more variable: Price &lt;int&gt;</code></pre>
</div>
</div>
<p>The <code>recipes</code>’ <code>step_impute_linear()</code> documentation also has a really good example of how to visualize the imputed data, using a dataset with complete values. It’s purpose is to show a comparison between the original values and the newly imputed values.</p>
<p>The following code is adapted from this example. Here I show the regression line used for the imputed <code>Income</code> values based on <code>Seniority</code>. It’s just a linear regression. If you’re interested in seeing the full example, run <code>?step_impute_linear()</code> in your console, and scroll down to the examples section.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb306"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb306-1"><a href="#cb306-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(credit_baked, <span class="fu">aes</span>(<span class="at">x =</span> Seniority, <span class="at">y =</span> Income)) <span class="sc">+</span></span>
<span id="cb306-2"><a href="#cb306-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">col =</span> <span class="st">"green"</span>) <span class="sc">+</span></span>
<span id="cb306-3"><a href="#cb306-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">alpha =</span> .<span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb306-4"><a href="#cb306-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Imputed Values"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-10-show-impute-model-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Again, this relationship is not a strong, linear one. Therefore, a linear imputation method of estimation may not be the best approach for this data. Nevertheless, it serves as an example of how to do it using the <code>recipes</code> package.</p>
<p>Day 10, check. Another 20 to go. Tomorrow I’ll continue my exploration of <code>step_impute_*()</code> functions by highlighting the use of the <code>step_impute_lower()</code> function.</p>
</section>
<section id="day-11---impute-values-using-step_impute_lower" class="level1">
<h1>Day 11 - Impute values using <code>step_impute_lower()</code></h1>
<p><code>step_impute_lower()</code> is our focus for today. According to the docs, <code>step_impute_lower()</code> calculates a variable’s minimum, simulates a value between zero and the minimum, and imputes this value for any cases at the minimum value. This imputation method is useful when we have non-negative numeric data, where values cannot be measured below a known value.</p>
<p>For today’s examples, I’m going to use the <code>modeldata</code> package’s <code>crickets</code> data. This data comes from a study examining the relationship between chirp rates and temperature for two different cricket species (run ?crickets in your console to learn more).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb307"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb307-1"><a href="#cb307-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(crickets, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb307-2"><a href="#cb307-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb307-3"><a href="#cb307-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(crickets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 31
Columns: 3
$ species &lt;fct&gt; O. exclamationis, O. exclamationis, O. exclamationis, O. exclamationis, O. exclama…
$ temp    &lt;dbl&gt; 20.8, 20.8, 24.0, 24.0, 24.0, 24.0, 26.2, 26.2, 26.2, 26.2, 28.4, 29.0, 30.4, 30.4…
$ rate    &lt;dbl&gt; 67.9, 65.1, 77.3, 78.7, 79.4, 80.4, 85.8, 86.6, 87.5, 89.1, 98.6, 100.8, 99.3, 101…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb309"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb309-1"><a href="#cb309-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(crickets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">crickets</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">2</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 11%">
<col style="width: 12%">
<col style="width: 23%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">species</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">O. : 17, O. : 14</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 11%">
<col style="width: 16%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">temp</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23.76</td>
<td style="text-align: right;">3.82</td>
<td style="text-align: right;">17.2</td>
<td style="text-align: right;">20.80</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">26.35</td>
<td style="text-align: right;">30.4</td>
<td style="text-align: left;">▆▆▆▇▅</td>
</tr>
<tr class="even">
<td style="text-align: left;">rate</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">72.89</td>
<td style="text-align: right;">16.91</td>
<td style="text-align: right;">44.3</td>
<td style="text-align: right;">59.45</td>
<td style="text-align: right;">76.2</td>
<td style="text-align: right;">85.25</td>
<td style="text-align: right;">101.7</td>
<td style="text-align: left;">▅▅▇▆▃</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We’re also going to modify the data a bit to better highlight what <code>step_impute_lower()</code> is doing. Here I’m just truncating all temp values less than or equal to 21 to 21.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb310"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb310-1"><a href="#cb310-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a floor at temp = 21</span></span>
<span id="cb310-2"><a href="#cb310-2" aria-hidden="true" tabindex="-1"></a>crickets <span class="ot">&lt;-</span> crickets <span class="sc">|&gt;</span> </span>
<span id="cb310-3"><a href="#cb310-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">temp =</span> <span class="fu">case_when</span>(</span>
<span id="cb310-4"><a href="#cb310-4" aria-hidden="true" tabindex="-1"></a>    temp <span class="sc">&lt;=</span> <span class="dv">21</span> <span class="sc">~</span> <span class="dv">21</span>,</span>
<span id="cb310-5"><a href="#cb310-5" aria-hidden="true" tabindex="-1"></a>    <span class="cn">TRUE</span> <span class="sc">~</span> <span class="fu">as.double</span>(temp)</span>
<span id="cb310-6"><a href="#cb310-6" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb310-7"><a href="#cb310-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb310-8"><a href="#cb310-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(crickets, <span class="at">n =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 3
   species           temp  rate
   &lt;fct&gt;            &lt;dbl&gt; &lt;dbl&gt;
 1 O. exclamationis  21    67.9
 2 O. exclamationis  21    65.1
 3 O. exclamationis  24    77.3
 4 O. exclamationis  24    78.7
 5 O. exclamationis  24    79.4
 6 O. exclamationis  24    80.4
 7 O. exclamationis  26.2  85.8
 8 O. exclamationis  26.2  86.6
 9 O. exclamationis  26.2  87.5
10 O. exclamationis  26.2  89.1
11 O. exclamationis  28.4  98.6
12 O. exclamationis  29   101. 
13 O. exclamationis  30.4  99.3
14 O. exclamationis  30.4 102. 
15 O. niveus         21    44.3
16 O. niveus         21    47.2
17 O. niveus         21    47.6
18 O. niveus         21    49.6
19 O. niveus         21    50.3
20 O. niveus         21    51.8
21 O. niveus         21    60  
22 O. niveus         21    58.5
23 O. niveus         21    58.9
24 O. niveus         22.1  60.7
25 O. niveus         23.5  69.8
26 O. niveus         24.2  70.9
27 O. niveus         25.9  76.2
28 O. niveus         26.5  76.1
29 O. niveus         26.5  77  
30 O. niveus         26.5  77.7
31 O. niveus         28.6  84.7</code></pre>
</div>
</div>
<p>For simplicity, I’m not going to create a testing and training split and will use the full data for our example. Let’s start with our recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb312"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb312-1"><a href="#cb312-1" aria-hidden="true" tabindex="-1"></a>crickets_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> crickets) <span class="sc">|&gt;</span></span>
<span id="cb312-2"><a href="#cb312-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_lower</span>(temp) <span class="sc">|&gt;</span></span>
<span id="cb312-3"><a href="#cb312-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb312-4"><a href="#cb312-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb312-5"><a href="#cb312-5" aria-hidden="true" tabindex="-1"></a>crickets_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 31 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Lower bound imputation for: temp | Trained</code></pre>
</div>
</div>
<p>Let’s take a quick peek at what’s happening under the hood by tidying our recipe object.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb325"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb325-1"><a href="#cb325-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(crickets_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type         trained skip  id                
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;        &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;             
1      1 step      impute_lower TRUE    FALSE impute_lower_h7llz</code></pre>
</div>
<div class="sourceCode cell-code" id="cb327"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb327-1"><a href="#cb327-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(crickets_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms value id                
  &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;             
1 temp     21 impute_lower_h7llz</code></pre>
</div>
</div>
<p>You’ll notice the <code>value</code> column in the tibble represents the minimum value within the column. Using this value, <code>step_impute_lower()</code> will replace these values with any value between 0 and 21. Let’s bake this recipe and verify this is the case.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb329"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb329-1"><a href="#cb329-1" aria-hidden="true" tabindex="-1"></a>baked_crickets <span class="ot">&lt;-</span> <span class="fu">bake</span>(crickets_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb329-2"><a href="#cb329-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb329-3"><a href="#cb329-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(baked_crickets, <span class="at">n =</span> <span class="dv">50</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 31 × 3
   species             temp  rate
   &lt;fct&gt;              &lt;dbl&gt; &lt;dbl&gt;
 1 O. exclamationis  7.84    67.9
 2 O. exclamationis 20.1     65.1
 3 O. exclamationis 24       77.3
 4 O. exclamationis 24       78.7
 5 O. exclamationis 24       79.4
 6 O. exclamationis 24       80.4
 7 O. exclamationis 26.2     85.8
 8 O. exclamationis 26.2     86.6
 9 O. exclamationis 26.2     87.5
10 O. exclamationis 26.2     89.1
11 O. exclamationis 28.4     98.6
12 O. exclamationis 29      101. 
13 O. exclamationis 30.4     99.3
14 O. exclamationis 30.4    102. 
15 O. niveus         5.51    44.3
16 O. niveus         7.75    47.2
17 O. niveus         6.99    47.6
18 O. niveus         8.92    49.6
19 O. niveus        15.2     50.3
20 O. niveus         0.0919  51.8
21 O. niveus        13.6     60  
22 O. niveus        12.0     58.5
23 O. niveus        10.0     58.9
24 O. niveus        22.1     60.7
25 O. niveus        23.5     69.8
26 O. niveus        24.2     70.9
27 O. niveus        25.9     76.2
28 O. niveus        26.5     76.1
29 O. niveus        26.5     77  
30 O. niveus        26.5     77.7
31 O. niveus        28.6     84.7</code></pre>
</div>
</div>
<p>Great! All values of 21 have now been imputed with a value between 0 and the minimum value for the column, 21.</p>
<p>We can also create a plot to highlight what <code>step_impute_lower()</code> is doing. This approach is adapted from the example in the docs (<code>?step_impute_lower()</code>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb331"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb331-1"><a href="#cb331-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(baked_crickets<span class="sc">$</span>temp, crickets<span class="sc">$</span>temp,</span>
<span id="cb331-2"><a href="#cb331-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">ylab =</span> <span class="st">"pre-imputation"</span>, <span class="at">xlab =</span> <span class="st">"imputed"</span></span>
<span id="cb331-3"><a href="#cb331-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-11-rec-plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><code>step_impute_lower()</code> is pretty straightforward in my opinion. Give it a try. That’s it for today. A short one. Tomorrow is our final <code>step_impute_*()</code> function, <code>step_impute_roll()</code>.</p>
</section>
<section id="day-12---impute-values-using-a-rolling-window-via-step_impute_roll" class="level1">
<h1>Day 12 - Impute values using a rolling window via <code>step_impute_roll()</code></h1>
<p>We’re going to round out our discussion of <code>step_impute_*()</code> functions by highlighting the use of <code>step_impute_roll()</code>. <code>step_impute_roll()</code> utilizes window functions to calculate missing values. At first, I had trouble understanding how window functions are utilized. However, seeing a simplified example helped me better understand what was occurring.</p>
<p>Let’s get some data for today’s examples. I’m going back to our obfuscated <a href="https://developers.google.com/analytics/bigquery/web-ecommerce-demo-dataset">Google Analytics data</a> from the <a href="https://shop.googlemerchandisestore.com/">Google Merchandise store</a> for today’s examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb332"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb332-1"><a href="#cb332-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> </span>
<span id="cb332-2"><a href="#cb332-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(</span>
<span id="cb332-3"><a href="#cb332-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb332-4"><a href="#cb332-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb332-5"><a href="#cb332-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb332-6"><a href="#cb332-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">event_date =</span> <span class="fu">ymd</span>(event_date),</span>
<span id="cb332-7"><a href="#cb332-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> price_in_usd <span class="sc">*</span> quantity</span>
<span id="cb332-8"><a href="#cb332-8" aria-hidden="true" tabindex="-1"></a>  ) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb334"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb334-1"><a href="#cb334-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 9,365
Columns: 15
$ event_date              &lt;date&gt; 2020-12-01, 2020-12-01, 2020-12-01, 2020-12-01, 2020-12-01, 2020-…
$ purchase_revenue_in_usd &lt;dbl&gt; 40, 40, 40, 40, 40, 40, 40, 62, 62, 44, 28, 28, 36, 36, 36, 36, 92…
$ transaction_id          &lt;dbl&gt; 10648, 10648, 10648, 10648, 10648, 10648, 10648, 171491, 171491, 1…
$ item_name               &lt;chr&gt; "Google Hemp Tote", "Android SM S/F18 Sticker Sheet", "Android Buo…
$ item_category           &lt;chr&gt; "Clearance", "Accessories", "Drinkware", "Small Goods", "Office", …
$ price_in_usd            &lt;dbl&gt; 12, 2, 4, 2, 3, 3, 14, 48, 14, 44, 14, 14, 1, 4, 16, 7, 92, 7, 14,…
$ quantity                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 53, 1, 1, 1, 1,…
$ item_revenue_in_usd     &lt;dbl&gt; 12, 2, 4, 2, 3, 3, 14, 48, 14, 44, 14, 14, 1, 4, 16, 14, 92, 371, …
$ shipping_tier           &lt;chr&gt; "FedEx Ground", "FedEx Ground", "FedEx Ground", "FedEx Ground", "F…
$ payment_type            &lt;chr&gt; "Pay with credit card", "Pay with credit card", "Pay with credit c…
$ category                &lt;chr&gt; "mobile", "mobile", "mobile", "mobile", "mobile", "mobile", "mobil…
$ country                 &lt;chr&gt; "United States", "United States", "United States", "United States"…
$ region                  &lt;chr&gt; "California", "California", "California", "California", "Californi…
$ city                    &lt;chr&gt; "San Jose", "San Jose", "San Jose", "San Jose", "San Jose", "San J…
$ revenue                 &lt;dbl&gt; 12, 2, 4, 2, 3, 3, 14, 48, 14, 44, 14, 14, 1, 4, 16, 14, 92, 371, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb336"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb336-1"><a href="#cb336-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(data_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">data_ga</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">9365</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Date</td>
<td style="text-align: left;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="odd">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">item_name</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">385</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_category</td>
<td style="text-align: right;">164</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">shipping_tier</td>
<td style="text-align: right;">109</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">payment_type</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">category</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">country</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">96</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">289</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">city</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">434</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: Date</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 12%">
<col style="width: 17%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 13%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">min</th>
<th style="text-align: left;">max</th>
<th style="text-align: left;">median</th>
<th style="text-align: right;">n_unique</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">event_date</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">2020-12-01</td>
<td style="text-align: left;">2021-01-30</td>
<td style="text-align: left;">2020-12-16</td>
<td style="text-align: right;">61</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 22%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 9%">
<col style="width: 9%">
<col style="width: 3%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">purchase_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">101.84</td>
<td style="text-align: right;">118.06</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">125</td>
<td style="text-align: right;">1530</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">transaction_id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">487977.44</td>
<td style="text-align: right;">282873.71</td>
<td style="text-align: right;">546</td>
<td style="text-align: right;">249662</td>
<td style="text-align: right;">479506</td>
<td style="text-align: right;">724658</td>
<td style="text-align: right;">999850</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="odd">
<td style="text-align: left;">price_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19.52</td>
<td style="text-align: right;">18.74</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">120</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">quantity</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">2.77</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">160</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">item_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23.26</td>
<td style="text-align: right;">28.61</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">704</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">revenue</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23.26</td>
<td style="text-align: right;">28.58</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">704</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>To make it clear what <code>step_impute_roll()</code> is doing, I’m going to wrangle the data to only look at total revenue for <code>Clearance</code> item purchases for a specific date range (2 weeks). Since this data is complete, I will introduce some missing values into the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb337"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb337-1"><a href="#cb337-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga <span class="sc">|&gt;</span></span>
<span id="cb337-2"><a href="#cb337-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(event_date, transaction_id, item_category, revenue) <span class="sc">|&gt;</span></span>
<span id="cb337-3"><a href="#cb337-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(item_category <span class="sc">==</span> <span class="st">"Clearance"</span>) <span class="sc">|&gt;</span></span>
<span id="cb337-4"><a href="#cb337-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb337-5"><a href="#cb337-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">total_rev =</span> <span class="fu">sum</span>(revenue))  <span class="sc">|&gt;</span></span>
<span id="cb337-6"><a href="#cb337-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb337-7"><a href="#cb337-7" aria-hidden="true" tabindex="-1"></a>    event_date <span class="sc">&gt;=</span> <span class="fu">as_date</span>(<span class="st">'2020-12-14'</span>) <span class="sc">&amp;</span> </span>
<span id="cb337-8"><a href="#cb337-8" aria-hidden="true" tabindex="-1"></a>    event_date <span class="sc">&lt;=</span> <span class="fu">as_date</span>(<span class="st">'2020-12-27'</span>)</span>
<span id="cb337-9"><a href="#cb337-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb337-10"><a href="#cb337-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb337-11"><a href="#cb337-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Introduce some NAs for the example</span></span>
<span id="cb337-12"><a href="#cb337-12" aria-hidden="true" tabindex="-1"></a>data_ga<span class="sc">$</span>total_rev[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">6</span>, <span class="dv">7</span>, <span class="dv">8</span>, <span class="dv">14</span>)] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s get our recipe set up to the point of prepping it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb338"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb338-1"><a href="#cb338-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb338-2"><a href="#cb338-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"data_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb338-3"><a href="#cb338-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_roll</span>(total_rev, <span class="at">window =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb338-4"><a href="#cb338-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb338-5"><a href="#cb338-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb338-6"><a href="#cb338-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 1
data_ref:  1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 14 data points and 5 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Rolling imputation for: total_rev | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb351"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb351-1"><a href="#cb351-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type        trained skip  id               
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;       &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;            
1      1 step      impute_roll TRUE    FALSE impute_roll_6HJg3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb353"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb353-1"><a href="#cb353-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms     window id               
  &lt;chr&gt;      &lt;int&gt; &lt;chr&gt;            
1 total_rev      3 impute_roll_6HJg3</code></pre>
</div>
</div>
<p>Not too much useful information here. Let’s move forward with bake and see the imputed values. Take note, we will still have a missing value (more on this later).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb355"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb355-1"><a href="#cb355-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 2
   event_date total_rev
   &lt;date&gt;         &lt;dbl&gt;
 1 2020-12-14      324.
 2 2020-12-15      323 
 3 2020-12-16      324 
 4 2020-12-17      203 
 5 2020-12-18      215 
 6 2020-12-19      215 
 7 2020-12-20       NA 
 8 2020-12-21       55 
 9 2020-12-22       55 
10 2020-12-23      256 
11 2020-12-24       32 
12 2020-12-25       73 
13 2020-12-26       19 
14 2020-12-27       46 </code></pre>
</div>
</div>
<p>We now have a complete data set. But, how were these imputed values calculated? If you peek at <code>step_impute_roll()</code>’s arguments, you’ll notice it contains a <code>statistic</code> argument set to <code>median</code>. It should be pretty intuitive that we are calculating the median here, but the median of what? It’s the median of our window we set in the function, which was <code>window = 3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb357"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb357-1"><a href="#cb357-1" aria-hidden="true" tabindex="-1"></a><span class="fu">args</span>(step_impute_roll)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>function (recipe, ..., role = NA, trained = FALSE, columns = NULL, 
    statistic = median, window = 5, skip = FALSE, id = rand_id("impute_roll")) 
NULL</code></pre>
</div>
</div>
<p>We need to be aware of some important notes regarding our calcuation of the median here. Let’s put our baked data side-by-side with our old data, just so it’s easier to see what was imputed and how it was calculated.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb359"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb359-1"><a href="#cb359-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb359-2"><a href="#cb359-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">new_rev =</span> total_rev) <span class="sc">|&gt;</span></span>
<span id="cb359-3"><a href="#cb359-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb359-4"><a href="#cb359-4" aria-hidden="true" tabindex="-1"></a>    data_ga <span class="sc">|&gt;</span> <span class="fu">rename</span>(<span class="at">old_rev =</span> total_rev)</span>
<span id="cb359-5"><a href="#cb359-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(event_date)`</code></pre>
</div>
</div>
<p>Let’s start with the tails, the missing values at row 1 and 14. Since these values lack a value above and below, they default to using the series <code>1:3</code> and <code>12:14</code> for imputation. When making the calculation for the window, only complete values are passed to the calculation. Take for example the missing value at row 1. The 324 imputed value comes from calculating the median between 323 and 324.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb361"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb361-1"><a href="#cb361-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We're rounding up here for the imputed value </span></span>
<span id="cb361-2"><a href="#cb361-2" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(<span class="fu">c</span>(<span class="dv">323</span>, <span class="dv">324</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 323.5</code></pre>
</div>
</div>
<p>The same calculation is being done for the 14th value, which looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb363"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb363-1"><a href="#cb363-1" aria-hidden="true" tabindex="-1"></a><span class="fu">median</span>(<span class="fu">c</span>(<span class="dv">73</span>, <span class="dv">19</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 46</code></pre>
</div>
</div>
<p>This brings up the interesting case for the imputed NA value at row 7, or the lack there of. Since all the values within the window are <code>NA</code>, an <code>NA</code> is imputed (i.e., you can’t calculate a median with no known values). To fix this, we would need to expand our window to include more values. We do this by setting <code>window = 5</code> within the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb365"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb365-1"><a href="#cb365-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb365-2"><a href="#cb365-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb365-3"><a href="#cb365-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_roll</span>(total_rev, <span class="at">window =</span> <span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb365-4"><a href="#cb365-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb365-5"><a href="#cb365-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb365-6"><a href="#cb365-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb365-7"><a href="#cb365-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Now we have complete values, since we expanded the window</span></span>
<span id="cb365-8"><a href="#cb365-8" aria-hidden="true" tabindex="-1"></a>baked_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 2
   event_date total_rev
   &lt;date&gt;         &lt;dbl&gt;
 1 2020-12-14     269  
 2 2020-12-15     323  
 3 2020-12-16     324  
 4 2020-12-17     203  
 5 2020-12-18     215  
 6 2020-12-19     209  
 7 2020-12-20     135  
 8 2020-12-21     156. 
 9 2020-12-22      55  
10 2020-12-23     256  
11 2020-12-24      32  
12 2020-12-25      73  
13 2020-12-26      19  
14 2020-12-27      52.5</code></pre>
</div>
</div>
<p>What about other functions to calculate values? To do this, <code>step_impute_roll()</code> has the <code>statistic</code> argument. Say instead of the median we want to calculate our imputed value using the mean. We just do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb367"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb367-1"><a href="#cb367-1" aria-hidden="true" tabindex="-1"></a>ga_mean_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., data_ga) <span class="sc">|&gt;</span></span>
<span id="cb367-2"><a href="#cb367-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"ref_date"</span>) <span class="sc">|&gt;</span></span>
<span id="cb367-3"><a href="#cb367-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_roll</span>(total_rev, <span class="at">window =</span> <span class="dv">5</span>, <span class="at">statistic =</span> mean) <span class="sc">|&gt;</span></span>
<span id="cb367-4"><a href="#cb367-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb367-5"><a href="#cb367-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb367-6"><a href="#cb367-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb367-7"><a href="#cb367-7" aria-hidden="true" tabindex="-1"></a>ga_mean_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 2
   event_date total_rev
   &lt;date&gt;         &lt;dbl&gt;
 1 2020-12-14      266.
 2 2020-12-15      323 
 3 2020-12-16      324 
 4 2020-12-17      203 
 5 2020-12-18      215 
 6 2020-12-19      209 
 7 2020-12-20      135 
 8 2020-12-21      156.
 9 2020-12-22       55 
10 2020-12-23      256 
11 2020-12-24       32 
12 2020-12-25       73 
13 2020-12-26       19 
14 2020-12-27       95 </code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>According to the docs, the statistic function you use should:</p>
<ol type="1">
<li>contain a single argument for the data to compute the imputed value.</li>
<li>return a double precision value.</li>
</ol>
<p>They also note only complete values will be passed to the functions specified with the <code>statistic</code> argument.</p>
</div>
</div>
<p>That’s a wrap for <code>step_imputation_*()</code> functions. Next we’re going to focus on step functions to decorrelate predictors.</p>
</section>
<section id="day-13---use-step_corr-to-remove-highly-correlated-predictors" class="level1">
<h1>Day 13 - Use <code>step_corr()</code> to remove highly correlated predictors</h1>
<p>Starting today, I’m going to begin highlighting <code>step_*()</code> functions useful for performing decorrelation preprocessing steps. These include steps to filter out highly correlated predictors, using principal component analysis, or other model-based methods.</p>
<p>I’m starting out simple here by focusing on the use of <code>step_corr()</code>. According to the docs, <code>step_corr()</code> will</p>
<blockquote class="blockquote">
<p>potentially remove variables that have large absolute correations with other variables.</p>
</blockquote>
<p>Using some threshold value, <code>step_corr()</code> will identify column combinations where a minimum number of columns are removed and all the absolute correlations between columns are below a specified threshold.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Important
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>step_corr()</code> will potentially remove columns.</p>
</div>
</div>
<p>Before using <code>step_corr()</code> let’s highlight some of the important arguments of the function.</p>
<ul>
<li><code>threshold</code> - used as the absolute correlation cut off value. The function defaults to .9. This is the only tuning parameter for the function.</li>
<li><code>method</code> - the method used to make correlation calculations, defaults to <code>pearson</code>.</li>
</ul>
<p>Let’s get our data together. For today’s example, I’m going back to our <code>penguins</code> data. You can learn more about this data by running <code>?penguins</code> in your console or by reviewing my past examples using this data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb369"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb369-1"><a href="#cb369-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(penguins, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb369-2"><a href="#cb369-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb369-3"><a href="#cb369-3" aria-hidden="true" tabindex="-1"></a>penguins</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 344 × 7
   species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex   
   &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;             &lt;int&gt;       &lt;int&gt; &lt;fct&gt; 
 1 Adelie  Torgersen           39.1          18.7               181        3750 male  
 2 Adelie  Torgersen           39.5          17.4               186        3800 female
 3 Adelie  Torgersen           40.3          18                 195        3250 female
 4 Adelie  Torgersen           NA            NA                  NA          NA &lt;NA&gt;  
 5 Adelie  Torgersen           36.7          19.3               193        3450 female
 6 Adelie  Torgersen           39.3          20.6               190        3650 male  
 7 Adelie  Torgersen           38.9          17.8               181        3625 female
 8 Adelie  Torgersen           39.2          19.6               195        4675 male  
 9 Adelie  Torgersen           34.1          18.1               193        3475 &lt;NA&gt;  
10 Adelie  Torgersen           42            20.2               190        4250 &lt;NA&gt;  
# ℹ 334 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb371"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb371-1"><a href="#cb371-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(penguins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 344
Columns: 7
$ species           &lt;fct&gt; Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, Adelie, …
$ island            &lt;fct&gt; Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torgersen, Torger…
$ bill_length_mm    &lt;dbl&gt; 39.1, 39.5, 40.3, NA, 36.7, 39.3, 38.9, 39.2, 34.1, 42.0, 37.8, 37.8, 41…
$ bill_depth_mm     &lt;dbl&gt; 18.7, 17.4, 18.0, NA, 19.3, 20.6, 17.8, 19.6, 18.1, 20.2, 17.1, 17.3, 17…
$ flipper_length_mm &lt;int&gt; 181, 186, 195, NA, 193, 190, 181, 195, 193, 190, 186, 180, 182, 191, 198…
$ body_mass_g       &lt;int&gt; 3750, 3800, 3250, NA, 3450, 3650, 3625, 4675, 3475, 4250, 3300, 3700, 32…
$ sex               &lt;fct&gt; male, female, female, NA, female, male, female, male, NA, NA, NA, NA, fe…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb373"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb373-1"><a href="#cb373-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(penguins)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">penguins</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">344</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">7</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">3</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 16%">
<col style="width: 12%">
<col style="width: 16%">
<col style="width: 9%">
<col style="width: 10%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">species</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Ade: 152, Gen: 124, Chi: 68</td>
</tr>
<tr class="even">
<td style="text-align: left;">island</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">Bis: 168, Dre: 124, Tor: 52</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sex</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">mal: 168, fem: 165</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 17%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">bill_length_mm</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">43.92</td>
<td style="text-align: right;">5.46</td>
<td style="text-align: right;">32.1</td>
<td style="text-align: right;">39.23</td>
<td style="text-align: right;">44.45</td>
<td style="text-align: right;">48.5</td>
<td style="text-align: right;">59.6</td>
<td style="text-align: left;">▃▇▇▆▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">bill_depth_mm</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">17.15</td>
<td style="text-align: right;">1.97</td>
<td style="text-align: right;">13.1</td>
<td style="text-align: right;">15.60</td>
<td style="text-align: right;">17.30</td>
<td style="text-align: right;">18.7</td>
<td style="text-align: right;">21.5</td>
<td style="text-align: left;">▅▅▇▇▂</td>
</tr>
<tr class="odd">
<td style="text-align: left;">flipper_length_mm</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">200.92</td>
<td style="text-align: right;">14.06</td>
<td style="text-align: right;">172.0</td>
<td style="text-align: right;">190.00</td>
<td style="text-align: right;">197.00</td>
<td style="text-align: right;">213.0</td>
<td style="text-align: right;">231.0</td>
<td style="text-align: left;">▂▇▃▅▂</td>
</tr>
<tr class="even">
<td style="text-align: left;">body_mass_g</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">4201.75</td>
<td style="text-align: right;">801.95</td>
<td style="text-align: right;">2700.0</td>
<td style="text-align: right;">3550.00</td>
<td style="text-align: right;">4050.00</td>
<td style="text-align: right;">4750.0</td>
<td style="text-align: right;">6300.0</td>
<td style="text-align: left;">▃▇▆▃▂</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Now we create our testing training split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb374"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb374-1"><a href="#cb374-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240113</span>)</span>
<span id="cb374-2"><a href="#cb374-2" aria-hidden="true" tabindex="-1"></a>penguins_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(penguins, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb374-3"><a href="#cb374-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb374-4"><a href="#cb374-4" aria-hidden="true" tabindex="-1"></a>penguins_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(penguins_split)</span>
<span id="cb374-5"><a href="#cb374-5" aria-hidden="true" tabindex="-1"></a>penguins_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(penguins_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Quickly, let’s use <code>corrr::correlate()</code> to explore correlations between variables in our training data. The code looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb375"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb375-1"><a href="#cb375-1" aria-hidden="true" tabindex="-1"></a><span class="fu">correlate</span>(penguins_tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Non-numeric variables removed from input: `species`, `island`, and `sex`
Correlation computed with
• Method: 'pearson'
• Missing treated using: 'pairwise.complete.obs'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 5
  term              bill_length_mm bill_depth_mm flipper_length_mm body_mass_g
  &lt;chr&gt;                      &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;       &lt;dbl&gt;
1 bill_length_mm            NA            -0.229             0.646       0.591
2 bill_depth_mm             -0.229        NA                -0.582      -0.477
3 flipper_length_mm          0.646        -0.582            NA           0.872
4 body_mass_g                0.591        -0.477             0.872      NA    </code></pre>
</div>
</div>
<p>You’ll notice a highly positive correlation between <code>flipper_length_mm</code> and <code>body_mass_g</code> (.872). Although I’m not making a causal argument here, it would seem feasible to assume that as a penguin’s flippers get longer, their body mass would increase. The question now is, if we were using this data to train a model, would the inclusion of both these variables improve our model? Or, could we simplify model estimation by eliminating one of these variables? Perhaps we can achieve the same amount of accuracy while also specifying the most parsimonious model.</p>
<p>Here we’ll create our recipe to address these two, highly correlated variables within our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb378"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb378-1"><a href="#cb378-1" aria-hidden="true" tabindex="-1"></a>penguins_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb378-2"><a href="#cb378-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">8</span>) <span class="sc">|&gt;</span></span>
<span id="cb378-3"><a href="#cb378-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb378-4"><a href="#cb378-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb378-5"><a href="#cb378-5" aria-hidden="true" tabindex="-1"></a>penguins_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 7</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 275 data points and 11 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Correlation filter on: flipper_length_mm | Trained</code></pre>
</div>
</div>
<p>The prepped recipe now tells us the <code>flipper_length_mm</code> variable will be removed once we bake the data. This is a good thing to keep an eye on, verifying the step removed expected columns.</p>
<p>When you drill down into the step using <code>tidy()</code>, you’ll notice a tibble that highlights what column will be removed once we <code>bake()</code> the recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb391"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb391-1"><a href="#cb391-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type  trained skip  id        
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;     
1      1 step      corr  TRUE    FALSE corr_q9cC1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb393"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb393-1"><a href="#cb393-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(penguins_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  terms             id        
  &lt;chr&gt;             &lt;chr&gt;     
1 flipper_length_mm corr_q9cC1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb395"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb395-1"><a href="#cb395-1" aria-hidden="true" tabindex="-1"></a>baked_penguin <span class="ot">&lt;-</span> <span class="fu">bake</span>(penguins_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb395-2"><a href="#cb395-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb395-3"><a href="#cb395-3" aria-hidden="true" tabindex="-1"></a>baked_penguin</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 275 × 6
   species island    bill_length_mm bill_depth_mm body_mass_g sex   
   &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;       &lt;int&gt; &lt;fct&gt; 
 1 Gentoo  Biscoe              50.5          15.9        5400 male  
 2 Gentoo  Biscoe              NA            NA            NA &lt;NA&gt;  
 3 Gentoo  Biscoe              50            15.3        5550 male  
 4 Adelie  Torgersen           40.2          17          3450 female
 5 Adelie  Biscoe              40.5          17.9        3200 female
 6 Adelie  Torgersen           37.8          17.1        3300 &lt;NA&gt;  
 7 Gentoo  Biscoe              48.2          14.3        4600 female
 8 Gentoo  Biscoe              55.1          16          5850 male  
 9 Adelie  Dream               37.2          18.1        3900 male  
10 Gentoo  Biscoe              48.7          15.7        5350 male  
# ℹ 265 more rows</code></pre>
</div>
</div>
<p>You can verify this highly correlated variable is mitigated by checking out the correlations between variables in our baked data set:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb397"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb397-1"><a href="#cb397-1" aria-hidden="true" tabindex="-1"></a><span class="fu">correlate</span>(baked_penguin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Non-numeric variables removed from input: `species`, `island`, and `sex`
Correlation computed with
• Method: 'pearson'
• Missing treated using: 'pairwise.complete.obs'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  term           bill_length_mm bill_depth_mm body_mass_g
  &lt;chr&gt;                   &lt;dbl&gt;         &lt;dbl&gt;       &lt;dbl&gt;
1 bill_length_mm         NA            -0.229       0.591
2 bill_depth_mm          -0.229        NA          -0.477
3 body_mass_g             0.591        -0.477      NA    </code></pre>
</div>
</div>
<p>So there you have it, our first <code>step_*()</code> function to perform decorrelation preprocessing. Tomorrow I’ll be focusing on <code>step_pca()</code>, which will use principal components analysis to manage correlations among predictors.</p>
</section>
<section id="day-14---perform-dimension-reduction-with-step_pca" class="level1">
<h1>Day 14 - Perform dimension reduction with <code>step_pca()</code></h1>
<p>For today, I’m overviewing <code>step_pca()</code>. <code>step_pca()</code> performs dimension reduction using <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">principal components analysis</a>. Dimension reduction seeks to combine predictors into latent predictors, while also <a href="http://www.feat.engineering/numeric-many-to-many">retaining as much information</a> from the full data set as possible. Principal component analysis can seem like an advanced topic, but the <a href="https://www.youtube.com/channel/UCtYLUTtgS3k1Fg4y5tAhLbw"><span class="citation" data-cites="statquest">@statquest</span> YouTube channel</a> has a good step-by-step <a href="https://www.youtube.com/watch?v=FgakZw6K1QQ">video</a> on how it’s performed, in general terms.</p>
<p>We’ll use the <code>mlc_churn</code> data from the ‘modeldata’ package for today’s examples. This data is an artificial data set representing <a href="https://en.wikipedia.org/wiki/Customer_attrition">customer churn</a> (i.e., the loss of customers to a service). You can learn more about this data by running <code>?mlc_churn</code> within your console. But here’s some basic data exploration code to get a sense of what’s included within the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb400"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb400-1"><a href="#cb400-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mlc_churn, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb400-2"><a href="#cb400-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb400-3"><a href="#cb400-3" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(mlc_churn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 5,000
Columns: 20
$ state                         &lt;fct&gt; KS, OH, NJ, OH, OK, AL, MA, MO, LA, WV, IN, RI, IA, MT, IA, …
$ account_length                &lt;int&gt; 128, 107, 137, 84, 75, 118, 121, 147, 117, 141, 65, 74, 168,…
$ area_code                     &lt;fct&gt; area_code_415, area_code_415, area_code_415, area_code_408, …
$ international_plan            &lt;fct&gt; no, no, no, yes, yes, yes, no, yes, no, yes, no, no, no, no,…
$ voice_mail_plan               &lt;fct&gt; yes, yes, no, no, no, no, yes, no, no, yes, no, no, no, no, …
$ number_vmail_messages         &lt;int&gt; 25, 26, 0, 0, 0, 0, 24, 0, 0, 37, 0, 0, 0, 0, 0, 0, 27, 0, 3…
$ total_day_minutes             &lt;dbl&gt; 265.1, 161.6, 243.4, 299.4, 166.7, 223.4, 218.2, 157.0, 184.…
$ total_day_calls               &lt;int&gt; 110, 123, 114, 71, 113, 98, 88, 79, 97, 84, 137, 127, 96, 88…
$ total_day_charge              &lt;dbl&gt; 45.07, 27.47, 41.38, 50.90, 28.34, 37.98, 37.09, 26.69, 31.3…
$ total_eve_minutes             &lt;dbl&gt; 197.4, 195.5, 121.2, 61.9, 148.3, 220.6, 348.5, 103.1, 351.6…
$ total_eve_calls               &lt;int&gt; 99, 103, 110, 88, 122, 101, 108, 94, 80, 111, 83, 148, 71, 7…
$ total_eve_charge              &lt;dbl&gt; 16.78, 16.62, 10.30, 5.26, 12.61, 18.75, 29.62, 8.76, 29.89,…
$ total_night_minutes           &lt;dbl&gt; 244.7, 254.4, 162.6, 196.9, 186.9, 203.9, 212.6, 211.8, 215.…
$ total_night_calls             &lt;int&gt; 91, 103, 104, 89, 121, 118, 118, 96, 90, 97, 111, 94, 128, 1…
$ total_night_charge            &lt;dbl&gt; 11.01, 11.45, 7.32, 8.86, 8.41, 9.18, 9.57, 9.53, 9.71, 14.6…
$ total_intl_minutes            &lt;dbl&gt; 10.0, 13.7, 12.2, 6.6, 10.1, 6.3, 7.5, 7.1, 8.7, 11.2, 12.7,…
$ total_intl_calls              &lt;int&gt; 3, 3, 5, 7, 3, 6, 7, 6, 4, 5, 6, 5, 2, 5, 6, 9, 4, 3, 5, 2, …
$ total_intl_charge             &lt;dbl&gt; 2.70, 3.70, 3.29, 1.78, 2.73, 1.70, 2.03, 1.92, 2.35, 3.02, …
$ number_customer_service_calls &lt;int&gt; 1, 1, 0, 2, 3, 0, 3, 0, 1, 0, 4, 0, 1, 3, 4, 4, 1, 3, 1, 1, …
$ churn                         &lt;fct&gt; no, no, no, no, no, no, no, no, no, no, yes, no, no, no, no,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb402"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb402-1"><a href="#cb402-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(mlc_churn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">mlc_churn</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">5000</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">20</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">factor</td>
<td style="text-align: left;">5</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">15</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: factor</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 20%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 36%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: left;">ordered</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: left;">top_counts</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">state</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">51</td>
<td style="text-align: left;">WV: 158, MN: 125, AL: 124, ID: 119</td>
</tr>
<tr class="even">
<td style="text-align: left;">area_code</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">are: 2495, are: 1259, are: 1246</td>
</tr>
<tr class="odd">
<td style="text-align: left;">international_plan</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 4527, yes: 473</td>
</tr>
<tr class="even">
<td style="text-align: left;">voice_mail_plan</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 3677, yes: 1323</td>
</tr>
<tr class="odd">
<td style="text-align: left;">churn</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">FALSE</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">no: 4293, yes: 707</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 28%">
<col style="width: 9%">
<col style="width: 13%">
<col style="width: 6%">
<col style="width: 5%">
<col style="width: 2%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 5%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">account_length</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100.26</td>
<td style="text-align: right;">39.69</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">73.00</td>
<td style="text-align: right;">100.00</td>
<td style="text-align: right;">127.00</td>
<td style="text-align: right;">243.00</td>
<td style="text-align: left;">▂▇▇▂▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">number_vmail_messages</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7.76</td>
<td style="text-align: right;">13.55</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">17.00</td>
<td style="text-align: right;">52.00</td>
<td style="text-align: left;">▇▁▂▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_day_minutes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">180.29</td>
<td style="text-align: right;">53.89</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">143.70</td>
<td style="text-align: right;">180.10</td>
<td style="text-align: right;">216.20</td>
<td style="text-align: right;">351.50</td>
<td style="text-align: left;">▁▃▇▅▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_day_calls</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100.03</td>
<td style="text-align: right;">19.83</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">87.00</td>
<td style="text-align: right;">100.00</td>
<td style="text-align: right;">113.00</td>
<td style="text-align: right;">165.00</td>
<td style="text-align: left;">▁▁▇▇▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_day_charge</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">30.65</td>
<td style="text-align: right;">9.16</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">24.43</td>
<td style="text-align: right;">30.62</td>
<td style="text-align: right;">36.75</td>
<td style="text-align: right;">59.76</td>
<td style="text-align: left;">▁▃▇▅▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_eve_minutes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">200.64</td>
<td style="text-align: right;">50.55</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">166.38</td>
<td style="text-align: right;">201.00</td>
<td style="text-align: right;">234.10</td>
<td style="text-align: right;">363.70</td>
<td style="text-align: left;">▁▂▇▅▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_eve_calls</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">100.19</td>
<td style="text-align: right;">19.83</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">87.00</td>
<td style="text-align: right;">100.00</td>
<td style="text-align: right;">114.00</td>
<td style="text-align: right;">170.00</td>
<td style="text-align: left;">▁▁▇▇▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_eve_charge</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">17.05</td>
<td style="text-align: right;">4.30</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">14.14</td>
<td style="text-align: right;">17.09</td>
<td style="text-align: right;">19.90</td>
<td style="text-align: right;">30.91</td>
<td style="text-align: left;">▁▂▇▅▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_night_minutes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">200.39</td>
<td style="text-align: right;">50.53</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">166.90</td>
<td style="text-align: right;">200.40</td>
<td style="text-align: right;">234.70</td>
<td style="text-align: right;">395.00</td>
<td style="text-align: left;">▁▃▇▃▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_night_calls</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">99.92</td>
<td style="text-align: right;">19.96</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">87.00</td>
<td style="text-align: right;">100.00</td>
<td style="text-align: right;">113.00</td>
<td style="text-align: right;">175.00</td>
<td style="text-align: left;">▁▁▇▆▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_night_charge</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">9.02</td>
<td style="text-align: right;">2.27</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">7.51</td>
<td style="text-align: right;">9.02</td>
<td style="text-align: right;">10.56</td>
<td style="text-align: right;">17.77</td>
<td style="text-align: left;">▁▃▇▃▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_intl_minutes</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">10.26</td>
<td style="text-align: right;">2.76</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">8.50</td>
<td style="text-align: right;">10.30</td>
<td style="text-align: right;">12.00</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: left;">▁▃▇▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">total_intl_calls</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">4.44</td>
<td style="text-align: right;">2.46</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3.00</td>
<td style="text-align: right;">4.00</td>
<td style="text-align: right;">6.00</td>
<td style="text-align: right;">20.00</td>
<td style="text-align: left;">▇▅▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">total_intl_charge</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2.77</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">2.30</td>
<td style="text-align: right;">2.78</td>
<td style="text-align: right;">3.24</td>
<td style="text-align: right;">5.40</td>
<td style="text-align: left;">▁▃▇▃▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">number_customer_service_calls</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.57</td>
<td style="text-align: right;">1.31</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">2.00</td>
<td style="text-align: right;">9.00</td>
<td style="text-align: left;">▇▅▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s create our training and testing split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb403"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb403-1"><a href="#cb403-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240114</span>)</span>
<span id="cb403-2"><a href="#cb403-2" aria-hidden="true" tabindex="-1"></a>churn_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(mlc_churn, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb403-3"><a href="#cb403-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb403-4"><a href="#cb403-4" aria-hidden="true" tabindex="-1"></a>churn_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(churn_split)</span>
<span id="cb403-5"><a href="#cb403-5" aria-hidden="true" tabindex="-1"></a>churn_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(churn_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before we apply the <code>step_pca()</code> function, we need to first center and scale our data. To do this, we’ll first use <code>step_normalize()</code> on all numeric variables within the data set. Normalizing will place all numeric data on the same scale, which is required step to complete before performing principal components analysis.</p>
<p>Post center and scaling of our variables, we’ll use <code>step_pca()</code> on <code>all_numeric()</code> predictors. We use the <code>num_comp = 3</code> argument to specify how many components will be outputted from our principal components analysis.</p>
<p>Let’s <code>prep()</code> and <code>tidy()</code> our recipe to peek under the hood to get a better sense of what’s happening with this recipe step.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb404"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb404-1"><a href="#cb404-1" aria-hidden="true" tabindex="-1"></a>churn_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(churn <span class="sc">~</span> ., <span class="at">data =</span> churn_tr) <span class="sc">|&gt;</span></span>
<span id="cb404-2"><a href="#cb404-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(state, area_code, <span class="at">new_role =</span> <span class="st">"ref_var"</span>) <span class="sc">|&gt;</span></span>
<span id="cb404-3"><a href="#cb404-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="fu">ends_with</span>(<span class="st">"plan"</span>), <span class="at">new_role =</span> <span class="st">"plan_var"</span>) <span class="sc">|&gt;</span></span>
<span id="cb404-4"><a href="#cb404-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>()) <span class="sc">|&gt;</span></span>
<span id="cb404-5"><a href="#cb404-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">num_comp =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb404-6"><a href="#cb404-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb404-7"><a href="#cb404-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb404-8"><a href="#cb404-8" aria-hidden="true" tabindex="-1"></a>churn_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 15
plan_var:   2
ref_var:    2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 4000 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering and scaling for: account_length and number_vmail_messages, ... | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• PCA extraction with: account_length, number_vmail_messages, total_day_minutes, ... | Trained</code></pre>
</div>
</div>
<p>It’s also important to point out that the <code>tidy()</code> method for <code>step_pca()</code> has two type options:</p>
<ol type="1">
<li><code>type = "coef"</code></li>
<li><code>type = "variance"</code></li>
</ol>
<p>Each of these options modify what gets printed to the console. I’ve added some comments below on what gets outputted for each.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb418"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb418-1"><a href="#cb418-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(churn_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  number operation type      trained skip  id             
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;          
1      1 step      normalize TRUE    FALSE normalize_7hokR
2      2 step      pca       TRUE    FALSE pca_BXk23      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb420"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb420-1"><a href="#cb420-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the variable loadings for each component</span></span>
<span id="cb420-2"><a href="#cb420-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(churn_rec, <span class="at">number =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="st">"coef"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 225 × 4
   terms                     value component id       
   &lt;chr&gt;                     &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;    
 1 account_length         0.0192   PC1       pca_BXk23
 2 number_vmail_messages -0.00296  PC1       pca_BXk23
 3 total_day_minutes      0.312    PC1       pca_BXk23
 4 total_day_calls       -0.000110 PC1       pca_BXk23
 5 total_day_charge       0.312    PC1       pca_BXk23
 6 total_eve_minutes     -0.462    PC1       pca_BXk23
 7 total_eve_calls        0.0230   PC1       pca_BXk23
 8 total_eve_charge      -0.462    PC1       pca_BXk23
 9 total_night_minutes    0.426    PC1       pca_BXk23
10 total_night_calls      0.00724  PC1       pca_BXk23
# ℹ 215 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb422"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb422-1"><a href="#cb422-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Output the variance each component accounts for</span></span>
<span id="cb422-2"><a href="#cb422-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(churn_rec, <span class="at">number =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="st">"variance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 4
   terms    value component id       
   &lt;chr&gt;    &lt;dbl&gt;     &lt;int&gt; &lt;chr&gt;    
 1 variance 2.07          1 pca_BXk23
 2 variance 2.02          2 pca_BXk23
 3 variance 1.98          3 pca_BXk23
 4 variance 1.94          4 pca_BXk23
 5 variance 1.06          5 pca_BXk23
 6 variance 1.04          6 pca_BXk23
 7 variance 1.01          7 pca_BXk23
 8 variance 0.988         8 pca_BXk23
 9 variance 0.977         9 pca_BXk23
10 variance 0.965        10 pca_BXk23
# ℹ 50 more rows</code></pre>
</div>
</div>
<p>Great, let’s bake our recipe. You’ll notice <code>step_pca()</code> reduced all numeric data into our three components, <code>PC1</code>, <code>PC2</code>, and <code>PC3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb424"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb424-1"><a href="#cb424-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(churn_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,000 × 8
   state area_code     international_plan voice_mail_plan churn    PC1     PC2    PC3
   &lt;fct&gt; &lt;fct&gt;         &lt;fct&gt;              &lt;fct&gt;           &lt;fct&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;
 1 IN    area_code_408 no                 no              no    -0.358  1.03   -1.30 
 2 AZ    area_code_415 no                 yes             no     3.04   2.20   -1.28 
 3 IL    area_code_415 no                 no              no     1.17  -2.36    0.697
 4 IN    area_code_415 no                 no              no    -0.127  0.811   1.14 
 5 FL    area_code_415 no                 no              no     0.248  2.06   -0.311
 6 NM    area_code_510 yes                no              no    -1.28   0.0720  1.02 
 7 DE    area_code_415 no                 no              no    -1.95   0.250  -0.553
 8 SD    area_code_408 no                 no              no     0.624  1.36   -0.344
 9 DE    area_code_510 no                 no              no    -1.13  -0.663  -0.804
10 CT    area_code_415 no                 yes             no    -2.60   0.817   0.939
# ℹ 3,990 more rows</code></pre>
</div>
</div>
<p>Constraining by component works, but <code>step_pca()</code> also provides a <code>threshold</code> argument. In other words, we can specify the total variance that should be covered by components, and <code>step_pca()</code> will create the required number of components based on this threshold. Let’s say we want our PCA to create a number of components to cover 70% of the variability in our variables. We can do this by using the following recipe code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb426"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb426-1"><a href="#cb426-1" aria-hidden="true" tabindex="-1"></a>churn_rec_thresh <span class="ot">&lt;-</span> <span class="fu">recipe</span>(churn <span class="sc">~</span> ., <span class="at">data =</span> churn_tr) <span class="sc">|&gt;</span></span>
<span id="cb426-2"><a href="#cb426-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(state, area_code, <span class="at">new_role =</span> <span class="st">"ref_var"</span>) <span class="sc">|&gt;</span></span>
<span id="cb426-3"><a href="#cb426-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="fu">ends_with</span>(<span class="st">"plan"</span>), <span class="at">new_role =</span> <span class="st">"plan_var"</span>) <span class="sc">|&gt;</span></span>
<span id="cb426-4"><a href="#cb426-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_numeric</span>()) <span class="sc">|&gt;</span></span>
<span id="cb426-5"><a href="#cb426-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_pca</span>(<span class="fu">all_numeric_predictors</span>(), <span class="at">threshold =</span> .<span class="dv">7</span>) <span class="sc">|&gt;</span></span>
<span id="cb426-6"><a href="#cb426-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb426-7"><a href="#cb426-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb426-8"><a href="#cb426-8" aria-hidden="true" tabindex="-1"></a>churn_rec_thresh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:    1
predictor: 15
plan_var:   2
ref_var:    2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 4000 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Centering and scaling for: account_length and number_vmail_messages, ... | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• PCA extraction with: account_length, number_vmail_messages, total_day_minutes, ... | Trained</code></pre>
</div>
</div>
<p>Let’s <code>tidy()</code> our recipe to see what’s happening here.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb440"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb440-1"><a href="#cb440-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(churn_rec_thresh)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 6
  number operation type      trained skip  id             
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;          
1      1 step      normalize TRUE    FALSE normalize_8WvPy
2      2 step      pca       TRUE    FALSE pca_Aj4UJ      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb442"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb442-1"><a href="#cb442-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variable loadings</span></span>
<span id="cb442-2"><a href="#cb442-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(churn_rec_thresh, <span class="at">number =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="st">"coef"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 225 × 4
   terms                     value component id       
   &lt;chr&gt;                     &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;    
 1 account_length         0.0192   PC1       pca_Aj4UJ
 2 number_vmail_messages -0.00296  PC1       pca_Aj4UJ
 3 total_day_minutes      0.312    PC1       pca_Aj4UJ
 4 total_day_calls       -0.000110 PC1       pca_Aj4UJ
 5 total_day_charge       0.312    PC1       pca_Aj4UJ
 6 total_eve_minutes     -0.462    PC1       pca_Aj4UJ
 7 total_eve_calls        0.0230   PC1       pca_Aj4UJ
 8 total_eve_charge      -0.462    PC1       pca_Aj4UJ
 9 total_night_minutes    0.426    PC1       pca_Aj4UJ
10 total_night_calls      0.00724  PC1       pca_Aj4UJ
# ℹ 215 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb444"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb444-1"><a href="#cb444-1" aria-hidden="true" tabindex="-1"></a><span class="co"># variance accounted for</span></span>
<span id="cb444-2"><a href="#cb444-2" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(churn_rec_thresh, <span class="at">number =</span> <span class="dv">2</span>, <span class="at">type =</span> <span class="st">"variance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 60 × 4
   terms    value component id       
   &lt;chr&gt;    &lt;dbl&gt;     &lt;int&gt; &lt;chr&gt;    
 1 variance 2.07          1 pca_Aj4UJ
 2 variance 2.02          2 pca_Aj4UJ
 3 variance 1.98          3 pca_Aj4UJ
 4 variance 1.94          4 pca_Aj4UJ
 5 variance 1.06          5 pca_Aj4UJ
 6 variance 1.04          6 pca_Aj4UJ
 7 variance 1.01          7 pca_Aj4UJ
 8 variance 0.988         8 pca_Aj4UJ
 9 variance 0.977         9 pca_Aj4UJ
10 variance 0.965        10 pca_Aj4UJ
# ℹ 50 more rows</code></pre>
</div>
</div>
<p>Now, we’ll bake our <code>churn_rec_thresh</code> recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb446"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb446-1"><a href="#cb446-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(churn_rec_thresh, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,000 × 12
   state area_code     international_plan voice_mail_plan churn    PC1     PC2    PC3    PC4    PC5
   &lt;fct&gt; &lt;fct&gt;         &lt;fct&gt;              &lt;fct&gt;           &lt;fct&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 IN    area_code_408 no                 no              no    -0.358  1.03   -1.30   0.613  0.402
 2 AZ    area_code_415 no                 yes             no     3.04   2.20   -1.28   1.06   1.04 
 3 IL    area_code_415 no                 no              no     1.17  -2.36    0.697  1.05   0.218
 4 IN    area_code_415 no                 no              no    -0.127  0.811   1.14   1.14   0.177
 5 FL    area_code_415 no                 no              no     0.248  2.06   -0.311 -2.28  -1.20 
 6 NM    area_code_510 yes                no              no    -1.28   0.0720  1.02   1.05  -1.12 
 7 DE    area_code_415 no                 no              no    -1.95   0.250  -0.553  1.80  -0.712
 8 SD    area_code_408 no                 no              no     0.624  1.36   -0.344 -0.717 -1.42 
 9 DE    area_code_510 no                 no              no    -1.13  -0.663  -0.804 -0.993 -0.159
10 CT    area_code_415 no                 yes             no    -2.60   0.817   0.939 -1.09   2.53 
# ℹ 3,990 more rows
# ℹ 2 more variables: PC6 &lt;dbl&gt;, PC7 &lt;dbl&gt;</code></pre>
</div>
</div>
<p>To meet our threshold, the <code>step_pca()</code> recipes step calculated and returned seven principal components, <code>PC1</code> - <code>PC7</code>.</p>
<p><code>step_pca()</code> makes it pretty easy to do dimension reduction utilizing principal components analysis. Give it a try.</p>
<p>Another day down. See you tomorrow.</p>
</section>
<section id="day-15---use-step_ica-for-signal-extraction" class="level1">
<h1>Day 15 - Use <code>step_ica()</code> for signal extraction</h1>
<p>Here we are, the halfway point <span class="emoji" data-emoji="tada">🎉</span>.</p>
<p>Today, I’m overviewing the use of <code>step_ica()</code>. This step is used to make transformations in signal processing. In general terms, <a href="https://en.wikipedia.org/wiki/Independent_component_analysis">independent component analysis (ICA)</a> is a dimensionality reduction technique that attempts to isolate signal from noise.</p>
<p>Before reviewing this step, I had to do some research on what ICA is and how it is used. Here are a few sources I found useful to gain an intuitive sense of this step:</p>
<ul>
<li><a href="https://stats.stackexchange.com/questions/162288/making-sense-of-independent-component-analysis">Making sense of independent component analysis</a> <a href="https://stats.stackexchange.com/">Cross Validated</a> post.</li>
<li><a href="https://towardsdatascience.com/introduction-to-ica-independent-component-analysis-b2c3c4720cd9">Introduction to ICA: Independent Component Analysis</a> by <a href="https://medium.com/@jonas_dieckmann">Jonas Dieckmann</a></li>
<li><a href="https://betterprogramming.pub/independent-component-analysis-ica-and-automated-component-labeling-eeg-example-fccfe9b0ea64">Independent Component Analysis (ICA) and Automated Component Labeling — EEG Example</a> by <a href="https://bartek-kulas.medium.com/">Bartek Kulas</a></li>
</ul>
<p>Across many of these sources, two examples are commonly presented to more clearly explain the purpose of ICA. First, the <a href="https://en.wikipedia.org/wiki/Cocktail_party_effect">cocktail party problem</a>, where we can isolate individual conversations among many during a party. The second comes from audio recording. Take for example a situation where you have multiple microphones. These microphones are being used to capture the sound of several audio sources (e.g., various instruments), and you’re attempting to isolate the sound from a single source. Both are situations where you’re trying to isolate the signal from surrounding noise. Indeed, these are simplified examples. The linked sources above provide more sophisticated explanations.</p>
<p>Before we use <code>step_ica()</code>, we’ll need some data. I’m using a portion of the data from the <a href="https://betterprogramming.pub/independent-component-analysis-ica-and-automated-component-labeling-eeg-example-fccfe9b0ea64">Independent Component Analysis (ICA) and Automated Component Labeling — EEG Example</a>. This data comes from the use of <a href="https://en.wikipedia.org/wiki/Electroencephalography">Electroencephalography (EEG)</a>. It was collected to examine EEG correlates of a genetic predisposition to alcoholism, and it was made available via <a href="https://www.kaggle.com/datasets/nnair25/Alcoholics/data">Kaggle</a>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>I am not an EEG professional, and I rarely work with this type of data. The approach I highlight here may not be best practice.</p>
</div>
</div>
<p>This data represents EEG sensor measurements of electrical activity during an experimental session for one participant. There are multiple sensors, which collect data intended to observe six known brain wave patterns (again, I’m not an expert here, so this is certainly a more complex topic then I’m making it out to be here). Let’s use <code>step_ica()</code> to see if we can transform this data into six different signals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb448"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb448-1"><a href="#cb448-1" aria-hidden="true" tabindex="-1"></a>data_eeg <span class="ot">&lt;-</span> </span>
<span id="cb448-2"><a href="#cb448-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(</span>
<span id="cb448-3"><a href="#cb448-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_eeg.csv"</span>)</span>
<span id="cb448-4"><a href="#cb448-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb448-5"><a href="#cb448-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">clean_names</span>() <span class="sc">|&gt;</span></span>
<span id="cb448-6"><a href="#cb448-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">id =</span> x1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>New names:
Rows: 16384 Columns: 10
── Column specification
──────────────────────────────────────────────────────────────────────────── Delimiter: "," chr
(4): sensor position, subject identifier, matching condition, name dbl (6): ...1, trial number,
sample num, sensor value, channel, time
ℹ Use `spec()` to retrieve the full column specification for this data. ℹ Specify the column types
or set `show_col_types = FALSE` to quiet this message.
• `` -&gt; `...1`</code></pre>
</div>
<div class="sourceCode cell-code" id="cb450"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb450-1"><a href="#cb450-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_eeg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 16,384
Columns: 10
$ id                 &lt;dbl&gt; 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, …
$ trial_number       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ sensor_position    &lt;chr&gt; "FP1", "FP1", "FP1", "FP1", "FP1", "FP1", "FP1", "FP1", "FP1", "FP1", "…
$ sample_num         &lt;dbl&gt; 0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 2…
$ sensor_value       &lt;dbl&gt; -8.921, -8.433, -2.574, 5.239, 11.587, 14.028, 11.587, 6.704, 1.821, -1…
$ subject_identifier &lt;chr&gt; "a", "a", "a", "a", "a", "a", "a", "a", "a", "a", "a", "a", "a", "a", "…
$ matching_condition &lt;chr&gt; "S1 obj", "S1 obj", "S1 obj", "S1 obj", "S1 obj", "S1 obj", "S1 obj", "…
$ channel            &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,…
$ name               &lt;chr&gt; "co2a0000364", "co2a0000364", "co2a0000364", "co2a0000364", "co2a000036…
$ time               &lt;dbl&gt; 0.00000000, 0.00390625, 0.00781250, 0.01171875, 0.01562500, 0.01953125,…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb452"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb452-1"><a href="#cb452-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(data_eeg)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">data_eeg</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">16384</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">10</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">4</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 24%">
<col style="width: 12%">
<col style="width: 18%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 14%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">sensor_position</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">64</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">subject_identifier</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">matching_condition</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">name</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">11</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 14%">
<col style="width: 10%">
<col style="width: 14%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 6%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8228.00</td>
<td style="text-align: right;">4748.27</td>
<td style="text-align: right;">5.00</td>
<td style="text-align: right;">4116.50</td>
<td style="text-align: right;">8228.00</td>
<td style="text-align: right;">12339.50</td>
<td style="text-align: right;">16451.0</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">trial_number</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.0</td>
<td style="text-align: left;">▁▁▇▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">sample_num</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">127.50</td>
<td style="text-align: right;">73.90</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">63.75</td>
<td style="text-align: right;">127.50</td>
<td style="text-align: right;">191.25</td>
<td style="text-align: right;">255.0</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">sensor_value</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.99</td>
<td style="text-align: right;">7.51</td>
<td style="text-align: right;">-39.83</td>
<td style="text-align: right;">-2.23</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right;">5.40</td>
<td style="text-align: right;">51.9</td>
<td style="text-align: left;">▁▂▇▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">channel</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">31.50</td>
<td style="text-align: right;">18.47</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">15.75</td>
<td style="text-align: right;">31.50</td>
<td style="text-align: right;">47.25</td>
<td style="text-align: right;">63.0</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">time</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">0.50</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>I’ll have to do some data wrangling here to work with the data first, though. Specifically, I need to go from long to wide data. This will give each EEG sensor measurement its own column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb453"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb453-1"><a href="#cb453-1" aria-hidden="true" tabindex="-1"></a>data_eeg <span class="ot">&lt;-</span> data_eeg <span class="sc">|&gt;</span></span>
<span id="cb453-2"><a href="#cb453-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(sensor_position, sensor_value, time) <span class="sc">|&gt;</span></span>
<span id="cb453-3"><a href="#cb453-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(</span>
<span id="cb453-4"><a href="#cb453-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">names_from =</span> sensor_position, </span>
<span id="cb453-5"><a href="#cb453-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">values_from =</span> sensor_value</span>
<span id="cb453-6"><a href="#cb453-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb453-7"><a href="#cb453-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb453-8"><a href="#cb453-8" aria-hidden="true" tabindex="-1"></a>data_eeg</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 256 × 65
      time   FP1    FP2      F7     F8    AF1    AF2     FZ    F4     F3   FC6    FC5    FC2    FC1
     &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
 1 0       -8.92  0.834 -19.8    8.15  -2.15   1.13  -0.071 3.41  -0.092 4.83  -2.43   0.488  0.824
 2 0.00391 -8.43  3.28  -12.5    1.80  -2.15   0.641 -0.559 1.46   0.397 6.30  -4.38  -0.977  0.824
 3 0.00781 -2.57  5.72    1.15  -2.59  -1.66  -0.336 -1.05  0.478 -1.07  5.81  -5.36  -1.46   0.336
 4 0.0117   5.24  7.67   14.8   -4.55  -0.682 -0.824 -0.559 0.966 -3.51  3.37  -5.36   0     -0.641
 5 0.0156  11.6   9.62   20.7   -5.04   2.25   0.641  0.905 1.94  -5.46  1.41  -0.966  1.95  -1.13 
 6 0.0195  14.0   9.62   17.3   -5.52   5.18   3.57   2.37  2.92  -4.49  0.437  6.85   3.42  -1.62 
 7 0.0234  11.6   8.65    8.96  -4.55   6.64   6.01   3.84  1.94  -1.07  0.926 13.7    3.42  -1.13 
 8 0.0273   6.70  5.23    0.173 -0.641  5.18   6.99   4.32  0.478  3.33  1.90  15.6    1.95   0.824
 9 0.0312   1.82  1.32   -3.73   5.71   1.76   5.52   3.35  0.478  6.74  1.90  11.7    0.977  3.75 
10 0.0352  -1.11 -2.10   -2.27  10.6   -1.66   2.59   1.88  1.94   7.23  1.90   3.92   0.977  5.22 
# ℹ 246 more rows
# ℹ 51 more variables: T8 &lt;dbl&gt;, T7 &lt;dbl&gt;, CZ &lt;dbl&gt;, C3 &lt;dbl&gt;, C4 &lt;dbl&gt;, CP5 &lt;dbl&gt;, CP6 &lt;dbl&gt;,
#   CP1 &lt;dbl&gt;, CP2 &lt;dbl&gt;, P3 &lt;dbl&gt;, P4 &lt;dbl&gt;, PZ &lt;dbl&gt;, P8 &lt;dbl&gt;, P7 &lt;dbl&gt;, PO2 &lt;dbl&gt;, PO1 &lt;dbl&gt;,
#   O2 &lt;dbl&gt;, O1 &lt;dbl&gt;, X &lt;dbl&gt;, AF7 &lt;dbl&gt;, AF8 &lt;dbl&gt;, F5 &lt;dbl&gt;, F6 &lt;dbl&gt;, FT7 &lt;dbl&gt;, FT8 &lt;dbl&gt;,
#   FPZ &lt;dbl&gt;, FC4 &lt;dbl&gt;, FC3 &lt;dbl&gt;, C6 &lt;dbl&gt;, C5 &lt;dbl&gt;, F2 &lt;dbl&gt;, F1 &lt;dbl&gt;, TP8 &lt;dbl&gt;, TP7 &lt;dbl&gt;,
#   AFZ &lt;dbl&gt;, CP3 &lt;dbl&gt;, CP4 &lt;dbl&gt;, P5 &lt;dbl&gt;, P6 &lt;dbl&gt;, C1 &lt;dbl&gt;, C2 &lt;dbl&gt;, PO7 &lt;dbl&gt;, PO8 &lt;dbl&gt;,
#   FCZ &lt;dbl&gt;, POZ &lt;dbl&gt;, OZ &lt;dbl&gt;, P2 &lt;dbl&gt;, P1 &lt;dbl&gt;, CPZ &lt;dbl&gt;, nd &lt;dbl&gt;, Y &lt;dbl&gt;</code></pre>
</div>
</div>
<p>In addition, <code>step_ica()</code> requires a few packages to be installed. This includes <code>dimRed</code> and <code>fastICA</code>. If these are not installed beforehand, an error will be returned.</p>
<p>Now we create our recipe. Just like principal components analysis, <a href="http://www.feat.engineering/numeric-many-to-many">we need to center and scale our data</a>. We achieve this by applying <code>step_center()</code> and <code>step_scale()</code> to <code>all_numeric()</code> variables. Since we’re attempting to create columns to represent the six brain waves, we’ll set <code>num_comp</code> to 6.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb455"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb455-1"><a href="#cb455-1" aria-hidden="true" tabindex="-1"></a>eeg_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_eeg) <span class="sc">|&gt;</span></span>
<span id="cb455-2"><a href="#cb455-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(time, <span class="at">new_role =</span> <span class="st">"time_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb455-3"><a href="#cb455-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_center</span>(<span class="fu">all_numeric</span>()) <span class="sc">|&gt;</span></span>
<span id="cb455-4"><a href="#cb455-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_scale</span>(<span class="fu">all_numeric</span>()) <span class="sc">|&gt;</span></span>
<span id="cb455-5"><a href="#cb455-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ica</span>(<span class="fu">all_numeric</span>(), <span class="at">num_comp =</span> <span class="dv">6</span>) <span class="sc">|&gt;</span></span>
<span id="cb455-6"><a href="#cb455-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s <code>tidy()</code> our recipe to get a better sense of what’s happening here. You’ll notice it’s very similar to principal components analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb456"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb456-1"><a href="#cb456-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(eeg_rec, <span class="at">number =</span> <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 390 × 4
   terms component     value id       
   &lt;chr&gt; &lt;chr&gt;         &lt;dbl&gt; &lt;chr&gt;    
 1 AF1   IC1       -0.0446   ica_xymfX
 2 AF1   IC2        0.0123   ica_xymfX
 3 AF1   IC3        0.00928  ica_xymfX
 4 AF1   IC4        0.000524 ica_xymfX
 5 AF1   IC5       -0.0280   ica_xymfX
 6 AF1   IC6       -0.0415   ica_xymfX
 7 AF2   IC1       -0.0489   ica_xymfX
 8 AF2   IC2        0.0667   ica_xymfX
 9 AF2   IC3       -0.00168  ica_xymfX
10 AF2   IC4       -0.0385   ica_xymfX
# ℹ 380 more rows</code></pre>
</div>
</div>
<p>Now let’s bake our data and see what the result of the <code>step_ica()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb458"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb458-1"><a href="#cb458-1" aria-hidden="true" tabindex="-1"></a>baked_eeg <span class="ot">&lt;-</span> <span class="fu">bake</span>(eeg_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb458-2"><a href="#cb458-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(data_eeg <span class="sc">|&gt;</span> <span class="fu">select</span>(time))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>For the heck of it, let’s plot our baked data. Do you see any of the common <a href="https://en.wikipedia.org/wiki/Electroencephalography#Wave%20patterns:~:text=prominent%20alpha%2Drhythm-,Wave%20patterns,-%5Bedit%5D">brain wave types</a> in these plots? Remember, this is only one participant, so if additional data were included, the patterns might become more apparent.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb459"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb459-1"><a href="#cb459-1" aria-hidden="true" tabindex="-1"></a><span class="fu">walk</span>(</span>
<span id="cb459-2"><a href="#cb459-2" aria-hidden="true" tabindex="-1"></a>  baked_eeg <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="sc">-</span>time), </span>
<span id="cb459-3"><a href="#cb459-3" aria-hidden="true" tabindex="-1"></a>  <span class="sc">~</span><span class="fu">plot</span>(baked_eeg<span class="sc">$</span>time, .x, <span class="at">type =</span> <span class="st">"line"</span>) </span>
<span id="cb459-4"><a href="#cb459-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.xy(xy, type, ...): plot type 'line' will be truncated to first character</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-15-vis-bake-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.xy(xy, type, ...): plot type 'line' will be truncated to first character</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-15-vis-bake-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.xy(xy, type, ...): plot type 'line' will be truncated to first character</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-15-vis-bake-3.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.xy(xy, type, ...): plot type 'line' will be truncated to first character</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-15-vis-bake-4.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.xy(xy, type, ...): plot type 'line' will be truncated to first character</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-15-vis-bake-5.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in plot.xy(xy, type, ...): plot type 'line' will be truncated to first character</code></pre>
</div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-15-vis-bake-6.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>There you have it, another <code>step_*()</code> function to try out. See you tomorrow.</p>
</section>
<section id="day-16---use-step_other-to-collapse-low-occurring-categorical-levels-into-other" class="level1">
<h1>Day 16 - Use <code>step_other()</code> to collapse low occurring categorical levels into <code>other</code></h1>
<p>For today, I’m going to highlight the use of <code>step_other()</code>. <code>step_other()</code> is used to collapse infrequent categorical values into an <code>other</code> category. To do this, the function has a <code>threshold</code> argument to modify the cutoff for determining values within this category. Let’s highlight its use with an example.</p>
<p>For data, I’m going back to our Google Analytics data. I’ve used this data for several examples already, so I’m not going to detail it too much here. However, here is some quick data exploration code for you to review.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb466"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb466-1"><a href="#cb466-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb466-2"><a href="#cb466-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb466-3"><a href="#cb466-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb468"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb468-1"><a href="#cb468-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(data_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 9,365
Columns: 14
$ event_date              &lt;dbl&gt; 20201201, 20201201, 20201201, 20201201, 20201201, 20201201, 202012…
$ purchase_revenue_in_usd &lt;dbl&gt; 40, 40, 40, 40, 40, 40, 40, 62, 62, 44, 28, 28, 36, 36, 36, 36, 92…
$ transaction_id          &lt;dbl&gt; 10648, 10648, 10648, 10648, 10648, 10648, 10648, 171491, 171491, 1…
$ item_name               &lt;chr&gt; "Google Hemp Tote", "Android SM S/F18 Sticker Sheet", "Android Buo…
$ item_category           &lt;chr&gt; "Clearance", "Accessories", "Drinkware", "Small Goods", "Office", …
$ price_in_usd            &lt;dbl&gt; 12, 2, 4, 2, 3, 3, 14, 48, 14, 44, 14, 14, 1, 4, 16, 7, 92, 7, 14,…
$ quantity                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 53, 1, 1, 1, 1,…
$ item_revenue_in_usd     &lt;dbl&gt; 12, 2, 4, 2, 3, 3, 14, 48, 14, 44, 14, 14, 1, 4, 16, 14, 92, 371, …
$ shipping_tier           &lt;chr&gt; "FedEx Ground", "FedEx Ground", "FedEx Ground", "FedEx Ground", "F…
$ payment_type            &lt;chr&gt; "Pay with credit card", "Pay with credit card", "Pay with credit c…
$ category                &lt;chr&gt; "mobile", "mobile", "mobile", "mobile", "mobile", "mobile", "mobil…
$ country                 &lt;chr&gt; "United States", "United States", "United States", "United States"…
$ region                  &lt;chr&gt; "California", "California", "California", "California", "Californi…
$ city                    &lt;chr&gt; "San Jose", "San Jose", "San Jose", "San Jose", "San Jose", "San J…</code></pre>
</div>
<div class="sourceCode cell-code" id="cb470"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb470-1"><a href="#cb470-1" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(data_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">data_ga</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">9365</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">item_name</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">385</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_category</td>
<td style="text-align: right;">164</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">shipping_tier</td>
<td style="text-align: right;">109</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">payment_type</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">category</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">country</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">96</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">289</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">city</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">434</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">event_date</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">20203675.03</td>
<td style="text-align: right;">3983.09</td>
<td style="text-align: right;">20201201</td>
<td style="text-align: right;">20201209</td>
<td style="text-align: right;">20201216</td>
<td style="text-align: right;">20210106</td>
<td style="text-align: right;">20210130</td>
<td style="text-align: left;">▇▁▁▁▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">purchase_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">101.84</td>
<td style="text-align: right;">118.06</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">125</td>
<td style="text-align: right;">1530</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">transaction_id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">487977.44</td>
<td style="text-align: right;">282873.71</td>
<td style="text-align: right;">546</td>
<td style="text-align: right;">249662</td>
<td style="text-align: right;">479506</td>
<td style="text-align: right;">724658</td>
<td style="text-align: right;">999850</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">price_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19.52</td>
<td style="text-align: right;">18.74</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">120</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">quantity</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">2.77</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">160</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23.26</td>
<td style="text-align: right;">28.61</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">30</td>
<td style="text-align: right;">704</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>First, let’s create a split.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb471"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb471-1"><a href="#cb471-1" aria-hidden="true" tabindex="-1"></a>split_ga <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb471-2"><a href="#cb471-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb471-3"><a href="#cb471-3" aria-hidden="true" tabindex="-1"></a>data_ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(split_ga)</span>
<span id="cb471-4"><a href="#cb471-4" aria-hidden="true" tabindex="-1"></a>data_ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(split_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>I’m interested in the <code>item_category</code> variable here. Let’s get a sense of the unique values and counts of each value within the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb472"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb472-1"><a href="#cb472-1" aria-hidden="true" tabindex="-1"></a>data_ga_tr <span class="sc">|&gt;</span></span>
<span id="cb472-2"><a href="#cb472-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(item_category, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb472-3"><a href="#cb472-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">prop =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">|&gt;</span></span>
<span id="cb472-4"><a href="#cb472-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="dv">25</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 21 × 3
   item_category               n     prop
   &lt;chr&gt;                   &lt;int&gt;    &lt;dbl&gt;
 1 Apparel                  2199 0.294   
 2 Campus Collection         755 0.101   
 3 New                       724 0.0966  
 4 Accessories               632 0.0844  
 5 Shop by Brand             463 0.0618  
 6 Office                    408 0.0545  
 7 Bags                      372 0.0497  
 8 Drinkware                 343 0.0458  
 9 Clearance                 336 0.0448  
10 Lifestyle                 263 0.0351  
11 Uncategorized Items       242 0.0323  
12 Google                    148 0.0198  
13 Stationery                146 0.0195  
14 &lt;NA&gt;                      140 0.0187  
15 Writing Instruments       121 0.0162  
16 Small Goods               106 0.0141  
17 Gift Cards                 48 0.00641 
18 Electronics Accessories    20 0.00267 
19 Notebooks &amp; Journals       16 0.00214 
20 Fun                         9 0.00120 
21 Black Lives Matter          1 0.000133</code></pre>
</div>
</div>
<p>Indeed, there are certainly some item categories that are purchased less than 5% of the time in our training data. Let’s create our recipe, where we focus on using <code>step_other()</code> to create an <code>other</code> category.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb474"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb474-1"><a href="#cb474-1" aria-hidden="true" tabindex="-1"></a><span class="co"># threshold defaults to .05</span></span>
<span id="cb474-2"><a href="#cb474-2" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb474-3"><a href="#cb474-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(item_category) <span class="sc">|&gt;</span></span>
<span id="cb474-4"><a href="#cb474-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb474-5"><a href="#cb474-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb474-6"><a href="#cb474-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 230 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Collapsing factor levels for: item_category | Trained</code></pre>
</div>
</div>
<p>We’ll now <code>tidy()</code> our recipe to drill down and get more information on what’s happening. When we look deeper into the first step, a tibble describing what columns will be affected by the step and what variables will not be converted into an <code>other</code> category is returned. In our case, <code>Accessories</code>, <code>Apparel</code>, <code>Bags</code>, <code>Campus Collection</code>, <code>New</code>, <code>Office</code>, and <code>Shop by Brand</code> will remain as factor levels. All others will be converted to the <code>other</code> category.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb487"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb487-1"><a href="#cb487-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type  trained skip  id         
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt; &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;      
1      1 step      other TRUE    FALSE other_MsyPy</code></pre>
</div>
<div class="sourceCode cell-code" id="cb489"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb489-1"><a href="#cb489-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7 × 3
  terms         retained          id         
  &lt;chr&gt;         &lt;chr&gt;             &lt;chr&gt;      
1 item_category Accessories       other_MsyPy
2 item_category Apparel           other_MsyPy
3 item_category Bags              other_MsyPy
4 item_category Campus Collection other_MsyPy
5 item_category New               other_MsyPy
6 item_category Office            other_MsyPy
7 item_category Shop by Brand     other_MsyPy</code></pre>
</div>
</div>
<p>We can bake to see what happens as a result.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb491"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb491-1"><a href="#cb491-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb491-2"><a href="#cb491-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb491-3"><a href="#cb491-3" aria-hidden="true" tabindex="-1"></a>baked_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 14
   event_date purchase_revenue_in_usd transaction_id item_name   item_category price_in_usd quantity
        &lt;dbl&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;                &lt;dbl&gt;    &lt;dbl&gt;
 1   20201210                      49         166937 Android Ic… New                      4        1
 2   20201208                      63         776080 Android SM… Accessories              2        2
 3   20201209                     163         517829 Womens Goo… Apparel                 16        1
 4   20201214                    1530         396355 Noogler An… Accessories             13       15
 5   20201210                     275         104071 Gift Card … other                   25        1
 6   20210113                      18         865692 Google Met… Office                   6        1
 7   20201203                     311         652984 Android Bu… other                    4        5
 8   20210120                      84         482111 Google See… other                   10        1
 9   20201202                      45         541131 Google Chr… Accessories             30        1
10   20201222                      54         125445 Google Tot… New                     19        1
# ℹ 7,482 more rows
# ℹ 7 more variables: item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;,
#   category &lt;fct&gt;, country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb493"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb493-1"><a href="#cb493-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="sc">|&gt;</span></span>
<span id="cb493-2"><a href="#cb493-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(item_category, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 9 × 2
  item_category         n
  &lt;fct&gt;             &lt;int&gt;
1 Apparel            2199
2 other              1799
3 Campus Collection   755
4 New                 724
5 Accessories         632
6 Shop by Brand       463
7 Office              408
8 Bags                372
9 &lt;NA&gt;                140</code></pre>
</div>
</div>
<p>Say we want to modify the threshold to be 10%. All we need to do is pass this value to the function via the <code>threshold</code> argument in <code>step_other()</code>. This looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb495"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb495-1"><a href="#cb495-1" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb495-2"><a href="#cb495-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(item_category, <span class="at">threshold =</span> .<span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb495-3"><a href="#cb495-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb495-4"><a href="#cb495-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb495-5"><a href="#cb495-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb495-6"><a href="#cb495-6" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 14
   event_date purchase_revenue_in_usd transaction_id item_name   item_category price_in_usd quantity
        &lt;dbl&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;                &lt;dbl&gt;    &lt;dbl&gt;
 1   20201210                      49         166937 Android Ic… other                    4        1
 2   20201208                      63         776080 Android SM… other                    2        2
 3   20201209                     163         517829 Womens Goo… Apparel                 16        1
 4   20201214                    1530         396355 Noogler An… other                   13       15
 5   20201210                     275         104071 Gift Card … other                   25        1
 6   20210113                      18         865692 Google Met… other                    6        1
 7   20201203                     311         652984 Android Bu… other                    4        5
 8   20210120                      84         482111 Google See… other                   10        1
 9   20201202                      45         541131 Google Chr… other                   30        1
10   20201222                      54         125445 Google Tot… other                   19        1
# ℹ 7,482 more rows
# ℹ 7 more variables: item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;,
#   category &lt;fct&gt;, country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb497"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb497-1"><a href="#cb497-1" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh <span class="sc">|&gt;</span></span>
<span id="cb497-2"><a href="#cb497-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(item_category, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 2
  item_category         n
  &lt;fct&gt;             &lt;int&gt;
1 other              4398
2 Apparel            2199
3 Campus Collection   755
4 &lt;NA&gt;                140</code></pre>
</div>
</div>
<p>This might be too restrictive. You can also pass an integer to <code>threshold</code> to use a frequency as a cutoff. This looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb499"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb499-1"><a href="#cb499-1" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb499-2"><a href="#cb499-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(item_category, <span class="at">threshold =</span> <span class="dv">300</span>) <span class="sc">|&gt;</span></span>
<span id="cb499-3"><a href="#cb499-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb499-4"><a href="#cb499-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb499-5"><a href="#cb499-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb499-6"><a href="#cb499-6" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 14
   event_date purchase_revenue_in_usd transaction_id item_name   item_category price_in_usd quantity
        &lt;dbl&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;                &lt;dbl&gt;    &lt;dbl&gt;
 1   20201210                      49         166937 Android Ic… New                      4        1
 2   20201208                      63         776080 Android SM… Accessories              2        2
 3   20201209                     163         517829 Womens Goo… Apparel                 16        1
 4   20201214                    1530         396355 Noogler An… Accessories             13       15
 5   20201210                     275         104071 Gift Card … other                   25        1
 6   20210113                      18         865692 Google Met… Office                   6        1
 7   20201203                     311         652984 Android Bu… Drinkware                4        5
 8   20210120                      84         482111 Google See… other                   10        1
 9   20201202                      45         541131 Google Chr… Accessories             30        1
10   20201222                      54         125445 Google Tot… New                     19        1
# ℹ 7,482 more rows
# ℹ 7 more variables: item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;,
#   category &lt;fct&gt;, country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb501"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb501-1"><a href="#cb501-1" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh <span class="sc">|&gt;</span></span>
<span id="cb501-2"><a href="#cb501-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(item_category, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 2
   item_category         n
   &lt;fct&gt;             &lt;int&gt;
 1 Apparel            2199
 2 other              1120
 3 Campus Collection   755
 4 New                 724
 5 Accessories         632
 6 Shop by Brand       463
 7 Office              408
 8 Bags                372
 9 Drinkware           343
10 Clearance           336
11 &lt;NA&gt;                140</code></pre>
</div>
</div>
<p>If you don’t like the <code>other</code> category label, you can modify it by passing a string to the <code>other</code>argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb503"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb503-1"><a href="#cb503-1" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb503-2"><a href="#cb503-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_other</span>(item_category, <span class="at">threshold =</span> <span class="dv">300</span>, <span class="at">other =</span> <span class="st">"Other items"</span>) <span class="sc">|&gt;</span></span>
<span id="cb503-3"><a href="#cb503-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb503-4"><a href="#cb503-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb503-5"><a href="#cb503-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb503-6"><a href="#cb503-6" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 14
   event_date purchase_revenue_in_usd transaction_id item_name   item_category price_in_usd quantity
        &lt;dbl&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;                &lt;dbl&gt;    &lt;dbl&gt;
 1   20201210                      49         166937 Android Ic… New                      4        1
 2   20201208                      63         776080 Android SM… Accessories              2        2
 3   20201209                     163         517829 Womens Goo… Apparel                 16        1
 4   20201214                    1530         396355 Noogler An… Accessories             13       15
 5   20201210                     275         104071 Gift Card … Other items             25        1
 6   20210113                      18         865692 Google Met… Office                   6        1
 7   20201203                     311         652984 Android Bu… Drinkware                4        5
 8   20210120                      84         482111 Google See… Other items             10        1
 9   20201202                      45         541131 Google Chr… Accessories             30        1
10   20201222                      54         125445 Google Tot… New                     19        1
# ℹ 7,482 more rows
# ℹ 7 more variables: item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;,
#   category &lt;fct&gt;, country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
<div class="sourceCode cell-code" id="cb505"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb505-1"><a href="#cb505-1" aria-hidden="true" tabindex="-1"></a>ga_rec_thresh <span class="sc">|&gt;</span></span>
<span id="cb505-2"><a href="#cb505-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(item_category, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 11 × 2
   item_category         n
   &lt;fct&gt;             &lt;int&gt;
 1 Apparel            2199
 2 Other items        1120
 3 Campus Collection   755
 4 New                 724
 5 Accessories         632
 6 Shop by Brand       463
 7 Office              408
 8 Bags                372
 9 Drinkware           343
10 Clearance           336
11 &lt;NA&gt;                140</code></pre>
</div>
</div>
<p>Check mark next to another day. <code>step_other()</code> is pretty useful in cases where you have many factor levels in a categorical variable. Take it for a test drive. See you tomorrow.</p>
</section>
<section id="day-17---convert-date-data-into-factor-or-numeric-variables-with-step_date" class="level1">
<h1>Day 17 - Convert date data into factor or numeric variables with <code>step_date()</code></h1>
<p>Do you ever work with date variables? Do these tasks often require you to parse date variables into various components (e.g., month, year, day of the week, etc.)? <code>recipes</code>’ <code>step_date()</code> simplifies these operations.</p>
<p>Let’s continue using our Google Analytics ecommerce data from yesterday. I’ve overviewed this data a few times now, so I’m not going to discuss it in depth here. Rather, I’m going to jump right into today’s examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb507"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb507-1"><a href="#cb507-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb507-2"><a href="#cb507-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb507-3"><a href="#cb507-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb509"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb509-1"><a href="#cb509-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240117</span>)</span>
<span id="cb509-2"><a href="#cb509-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb509-3"><a href="#cb509-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb509-4"><a href="#cb509-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Within this data is an <code>event_date</code> column. Let’s say I want to create two new columns from this data: <code>month</code> and <code>year</code>. First, we need to utilize <code>step_mutate()</code> to convert <code>event_date</code> to type <code>date</code> (i.e., <code>20201202</code> to <code>2020-12-02</code>). <code>lubridate</code>’s <code>ymd()</code> function is used to do this. We do this by doing the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb510"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb510-1"><a href="#cb510-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb510-2"><a href="#cb510-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb510-3"><a href="#cb510-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(event_date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb510-4"><a href="#cb510-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb510-5"><a href="#cb510-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb510-6"><a href="#cb510-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Date features from: event_date | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb524"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb524-1"><a href="#cb524-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms      value           id          
  &lt;chr&gt;      &lt;chr&gt;           &lt;chr&gt;       
1 event_date ymd(event_date) mutate_1gITK</code></pre>
</div>
</div>
<p>Let’s bake our recipe and take a look at what’s happening. You should notice two new variables are created, each prefixed with the original variable name <code>event_date_</code>. The data now contains <code>event_date_month</code> and <code>event_date_year</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb526"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb526-1"><a href="#cb526-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb526-2"><a href="#cb526-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"event_"</span>), <span class="at">.after =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 16
   event_date event_date_month event_date_year purchase_revenue_in_usd transaction_id item_name     
   &lt;date&gt;     &lt;fct&gt;                      &lt;int&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;         
 1 2020-12-02 Dec                         2020                      41          11395 Google Navy S…
 2 2020-12-07 Dec                         2020                      22         190059 Google Super …
 3 2020-12-08 Dec                         2020                      29         147010 Google SF Cam…
 4 2021-01-20 Jan                         2021                      86         101328 Google Speckl…
 5 2020-12-04 Dec                         2020                     142         469624 Google Men's …
 6 2020-12-28 Dec                         2020                      79         797936 Google Kirkla…
 7 2020-12-28 Dec                         2020                      79         797936 Google Kirkla…
 8 2020-12-17 Dec                         2020                     139         439292 Google Speckl…
 9 2021-01-24 Jan                         2021                      55         172750 Google Black …
10 2020-12-18 Dec                         2020                     128         878199 #IamRemarkabl…
# ℹ 7,482 more rows
# ℹ 10 more variables: item_category &lt;fct&gt;, price_in_usd &lt;dbl&gt;, quantity &lt;dbl&gt;,
#   item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;, category &lt;fct&gt;,
#   country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
</div>
<p>Say we don’t like the use of the abbreviation for <code>event_date_month</code>, we can change this by setting the <code>abbr</code> argument to <code>FALSE</code> in our recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb528"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb528-1"><a href="#cb528-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb528-2"><a href="#cb528-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb528-3"><a href="#cb528-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(event_date, <span class="at">features =</span> <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"year"</span>), <span class="at">abbr =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb528-4"><a href="#cb528-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb528-5"><a href="#cb528-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb528-6"><a href="#cb528-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Date features from: event_date | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb542"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb542-1"><a href="#cb542-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb542-2"><a href="#cb542-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"event_"</span>), <span class="at">.after =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 16
   event_date event_date_month event_date_year purchase_revenue_in_usd transaction_id item_name     
   &lt;date&gt;     &lt;fct&gt;                      &lt;int&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;         
 1 2020-12-02 December                    2020                      41          11395 Google Navy S…
 2 2020-12-07 December                    2020                      22         190059 Google Super …
 3 2020-12-08 December                    2020                      29         147010 Google SF Cam…
 4 2021-01-20 January                     2021                      86         101328 Google Speckl…
 5 2020-12-04 December                    2020                     142         469624 Google Men's …
 6 2020-12-28 December                    2020                      79         797936 Google Kirkla…
 7 2020-12-28 December                    2020                      79         797936 Google Kirkla…
 8 2020-12-17 December                    2020                     139         439292 Google Speckl…
 9 2021-01-24 January                     2021                      55         172750 Google Black …
10 2020-12-18 December                    2020                     128         878199 #IamRemarkabl…
# ℹ 7,482 more rows
# ℹ 10 more variables: item_category &lt;fct&gt;, price_in_usd &lt;dbl&gt;, quantity &lt;dbl&gt;,
#   item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;, category &lt;fct&gt;,
#   country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
</div>
<p>Also of note is <code>step_date()</code> converted the <code>event_date_month</code> column into an ordered factor for us.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb544"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb544-1"><a href="#cb544-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb544-2"><a href="#cb544-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pull</span>(event_date_month) <span class="sc">|&gt;</span></span>
<span id="cb544-3"><a href="#cb544-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">levels</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "January"   "February"  "March"     "April"     "May"       "June"      "July"      "August"   
 [9] "September" "October"   "November"  "December" </code></pre>
</div>
</div>
<p><code>step_date()</code>’s <code>feature</code> argument has many different options. This includes:</p>
<ul>
<li><code>month</code></li>
<li><code>dow</code> (day of week)</li>
<li><code>doy</code> (day of year)</li>
<li><code>week</code></li>
<li><code>month</code></li>
<li><code>decimal</code> (decimal date)</li>
<li><code>quarter</code></li>
<li><code>semester</code></li>
<li><code>year</code></li>
</ul>
<p>Just for the heck of it, let’s create features using all of the available options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb546"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb546-1"><a href="#cb546-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb546-2"><a href="#cb546-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb546-3"><a href="#cb546-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(</span>
<span id="cb546-4"><a href="#cb546-4" aria-hidden="true" tabindex="-1"></a>    event_date, </span>
<span id="cb546-5"><a href="#cb546-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">features =</span> <span class="fu">c</span>(<span class="st">"month"</span>, <span class="st">"dow"</span>, <span class="st">"doy"</span>, <span class="st">"week"</span>, <span class="st">"decimal"</span>, <span class="st">"quarter"</span>, <span class="st">"semester"</span>, <span class="st">"year"</span>)</span>
<span id="cb546-6"><a href="#cb546-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb546-7"><a href="#cb546-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb546-8"><a href="#cb546-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb546-9"><a href="#cb546-9" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Date features from: event_date | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb560"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb560-1"><a href="#cb560-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb560-2"><a href="#cb560-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">relocate</span>(<span class="fu">starts_with</span>(<span class="st">"event_"</span>), <span class="at">.after =</span> <span class="dv">1</span>)</span>
<span id="cb560-3"><a href="#cb560-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb560-4"><a href="#cb560-4" aria-hidden="true" tabindex="-1"></a>baked_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 22
   event_date event_date_month event_date_dow event_date_doy event_date_week event_date_decimal
   &lt;date&gt;     &lt;fct&gt;            &lt;fct&gt;                   &lt;int&gt;           &lt;int&gt;              &lt;dbl&gt;
 1 2020-12-02 Dec              Wed                       337              49              2021.
 2 2020-12-07 Dec              Mon                       342              49              2021.
 3 2020-12-08 Dec              Tue                       343              49              2021.
 4 2021-01-20 Jan              Wed                        20               3              2021.
 5 2020-12-04 Dec              Fri                       339              49              2021.
 6 2020-12-28 Dec              Mon                       363              52              2021.
 7 2020-12-28 Dec              Mon                       363              52              2021.
 8 2020-12-17 Dec              Thu                       352              51              2021.
 9 2021-01-24 Jan              Sun                        24               4              2021.
10 2020-12-18 Dec              Fri                       353              51              2021.
# ℹ 7,482 more rows
# ℹ 16 more variables: event_date_quarter &lt;int&gt;, event_date_semester &lt;int&gt;, event_date_year &lt;int&gt;,
#   purchase_revenue_in_usd &lt;dbl&gt;, transaction_id &lt;dbl&gt;, item_name &lt;fct&gt;, item_category &lt;fct&gt;,
#   price_in_usd &lt;dbl&gt;, quantity &lt;dbl&gt;, item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;,
#   payment_type &lt;fct&gt;, category &lt;fct&gt;, country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Unlike other <code>step_*()</code> functions, <code>step_date</code> does not remove the original column. If needed you can modify this with the <code>keep_original_columns</code> argument.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb562"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb562-1"><a href="#cb562-1" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 7,492
Columns: 22
$ event_date              &lt;date&gt; 2020-12-02, 2020-12-07, 2020-12-08, 2021-01-20, 2020-12-04, 2020-…
$ event_date_month        &lt;fct&gt; Dec, Dec, Dec, Jan, Dec, Dec, Dec, Dec, Jan, Dec, Dec, Dec, Jan, D…
$ event_date_dow          &lt;fct&gt; Wed, Mon, Tue, Wed, Fri, Mon, Mon, Thu, Sun, Fri, Thu, Thu, Fri, T…
$ event_date_doy          &lt;int&gt; 337, 342, 343, 20, 339, 363, 363, 352, 24, 353, 345, 352, 22, 352,…
$ event_date_week         &lt;int&gt; 49, 49, 49, 3, 49, 52, 52, 51, 4, 51, 50, 51, 4, 51, 50, 49, 51, 5…
$ event_date_decimal      &lt;dbl&gt; 2020.918, 2020.932, 2020.934, 2021.052, 2020.923, 2020.989, 2020.9…
$ event_date_quarter      &lt;int&gt; 4, 4, 4, 1, 4, 4, 4, 4, 1, 4, 4, 4, 1, 4, 4, 4, 4, 4, 4, 4, 4, 1, …
$ event_date_semester     &lt;int&gt; 2, 2, 2, 1, 2, 2, 2, 2, 1, 2, 2, 2, 1, 2, 2, 2, 2, 2, 2, 2, 2, 1, …
$ event_date_year         &lt;int&gt; 2020, 2020, 2020, 2021, 2020, 2020, 2020, 2020, 2021, 2020, 2020, …
$ purchase_revenue_in_usd &lt;dbl&gt; 41, 22, 29, 86, 142, 79, 79, 139, 55, 128, 23, 41, 20, 15, 223, 18…
$ transaction_id          &lt;dbl&gt; 11395, 190059, 147010, 101328, 469624, 797936, 797936, 439292, 172…
$ item_name               &lt;fct&gt; Google Navy Speckled Tee, Google Super G Tumbler (Red Lid), Google…
$ item_category           &lt;fct&gt; Apparel, Lifestyle, Campus Collection, New, Apparel, Clearance, Cl…
$ price_in_usd            &lt;dbl&gt; 24, 22, 6, 16, 71, 14, 14, 16, 55, 10, 16, 11, 10, 14, 3, 71, 11, …
$ quantity                &lt;dbl&gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 1, 1, 1, 2, …
$ item_revenue_in_usd     &lt;dbl&gt; 24, 22, 6, 16, 71, 14, 14, 16, 55, 19, 16, 11, 10, 14, 6, 71, 11, …
$ shipping_tier           &lt;fct&gt; FedEx Ground, FedEx Ground, UPS Ground, FedEx Ground, FedEx Ground…
$ payment_type            &lt;fct&gt; Pay with credit card, Pay with credit card, Pay with credit card, …
$ category                &lt;fct&gt; desktop, desktop, mobile, desktop, desktop, desktop, desktop, mobi…
$ country                 &lt;fct&gt; France, United States, Thailand, United Kingdom, United States, Un…
$ region                  &lt;fct&gt; Nouvelle-Aquitaine, Missouri, Bangkok, England, Washington, Califo…
$ city                    &lt;fct&gt; (not set), (not set), Bangkok, (not set), (not set), (not set), (n…</code></pre>
</div>
</div>
<p>Pretty neat! <code>step_date()</code> provides some pretty good utility, especially if you tend to work with a lot of dates needing to be transformed into different representations. We’ll see you tomorrow everybody.</p>
</section>
<section id="day-18---create-a-lagged-variable-using-step_lag" class="level1">
<h1>Day 18 - Create a lagged variable using <code>step_lag()</code></h1>
<p>Welcome back, fellow readers! Another day, another <code>step_*()</code> function.</p>
<p>Currently, I tend to work with timeseries data. As such, I need to create lagged variables from time-to-time. <code>recipes</code>’ <code>step_lag()</code> function is handy in these situations. Let’s highlight an example using this function. But first, we need some data.</p>
<p>Once again, I’m going to use the obfuscated Google Analytics ecommerce data. You can read more about this data in my previous posts. I’m not going to detail it much here, other than importing it, doing a little wrangling to calculate total revenue and total number of items purchased, and creating a training testing split. Here’s all the code to do this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb564"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb564-1"><a href="#cb564-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> </span>
<span id="cb564-2"><a href="#cb564-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">read_csv</span>(<span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb566"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb566-1"><a href="#cb566-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga <span class="sc">|&gt;</span></span>
<span id="cb566-2"><a href="#cb566-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb566-3"><a href="#cb566-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb566-4"><a href="#cb566-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">items_purchased =</span> <span class="fu">sum</span>(quantity),</span>
<span id="cb566-5"><a href="#cb566-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> <span class="fu">sum</span>(item_revenue_in_usd)</span>
<span id="cb566-6"><a href="#cb566-6" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb567"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb567-1"><a href="#cb567-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240118</span>)</span>
<span id="cb567-2"><a href="#cb567-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb567-3"><a href="#cb567-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb567-4"><a href="#cb567-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create our recipe, prep, and bake it. The <code>tidy()</code> method doesn’t provide too much useful information about our step, other than what columns lagged columns will be created from, so no use in looking at it here. The important argument is <code>lag</code>. This argument is where we specify how much we want to lag our variable by.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb568"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb568-1"><a href="#cb568-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb568-2"><a href="#cb568-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb568-3"><a href="#cb568-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb568-4"><a href="#cb568-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_lag</span>(items_purchased, revenue, <span class="at">lag =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb568-5"><a href="#cb568-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb568-6"><a href="#cb568-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb568-7"><a href="#cb568-7" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 48 × 5
   event_date items_purchased revenue lag_1_items_purchased lag_1_revenue
   &lt;date&gt;               &lt;dbl&gt;   &lt;dbl&gt;                 &lt;dbl&gt;         &lt;dbl&gt;
 1 2020-12-28             187    2097                    NA            NA
 2 2021-01-27              51     457                   187          2097
 3 2020-12-30             317    1606                    51           457
 4 2020-12-18             398    6617                   317          1606
 5 2021-01-09              68    1362                   398          6617
 6 2021-01-24             133    2406                    68          1362
 7 2020-12-06             140    2328                   133          2406
 8 2020-12-14             527    8498                   140          2328
 9 2021-01-04              63     835                   527          8498
10 2020-12-01             356    6260                    63           835
# ℹ 38 more rows</code></pre>
</div>
</div>
<p>The lag argument also makes it convenient to create multiple lagged variables in one step. We just need to pass along a vector of positive vectors (e.g., <code>1:3</code>) to the <code>lag</code> argument. This looks like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb570"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb570-1"><a href="#cb570-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb570-2"><a href="#cb570-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb570-3"><a href="#cb570-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb570-4"><a href="#cb570-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_lag</span>(items_purchased, revenue, <span class="at">lag =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb570-5"><a href="#cb570-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb570-6"><a href="#cb570-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb570-7"><a href="#cb570-7" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 2
date_ref:  1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 48 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Lagging: items_purchased and revenue | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb584"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb584-1"><a href="#cb584-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb584-2"><a href="#cb584-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 9
$ event_date            &lt;date&gt; 2020-12-28, 2021-01-27, 2020-12-30, 2020-12-18, 2021-01-09, 2021-01…
$ items_purchased       &lt;dbl&gt; 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 156, …
$ revenue               &lt;dbl&gt; 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, 551,…
$ lag_1_items_purchased &lt;dbl&gt; NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 1…
$ lag_2_items_purchased &lt;dbl&gt; NA, NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 6…
$ lag_3_items_purchased &lt;dbl&gt; NA, NA, NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 2…
$ lag_1_revenue         &lt;dbl&gt; NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, …
$ lag_2_revenue         &lt;dbl&gt; NA, NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 12…
$ lag_3_revenue         &lt;dbl&gt; NA, NA, NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260…</code></pre>
</div>
</div>
<p>Say we want a variable lagged by 1, 3, and 5 values. We can do this by doing the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb586"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb586-1"><a href="#cb586-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb586-2"><a href="#cb586-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb586-3"><a href="#cb586-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb586-4"><a href="#cb586-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_lag</span>(items_purchased, revenue, <span class="at">lag =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>)) <span class="sc">|&gt;</span></span>
<span id="cb586-5"><a href="#cb586-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb586-6"><a href="#cb586-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb586-7"><a href="#cb586-7" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 2
date_ref:  1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 48 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Lagging: items_purchased and revenue | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb600"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb600-1"><a href="#cb600-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb600-2"><a href="#cb600-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 9
$ event_date            &lt;date&gt; 2020-12-28, 2021-01-27, 2020-12-30, 2020-12-18, 2021-01-09, 2021-01…
$ items_purchased       &lt;dbl&gt; 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 156, …
$ revenue               &lt;dbl&gt; 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, 551,…
$ lag_1_items_purchased &lt;dbl&gt; NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 1…
$ lag_3_items_purchased &lt;dbl&gt; NA, NA, NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 2…
$ lag_5_items_purchased &lt;dbl&gt; NA, NA, NA, NA, NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 9…
$ lag_1_revenue         &lt;dbl&gt; NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, …
$ lag_3_revenue         &lt;dbl&gt; NA, NA, NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260…
$ lag_5_revenue         &lt;dbl&gt; NA, NA, NA, NA, NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 8…</code></pre>
</div>
</div>
<p>Not happy with the default <code>NA</code> value. We can change that by passing a value to the <code>default</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb602"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb602-1"><a href="#cb602-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb602-2"><a href="#cb602-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb602-3"><a href="#cb602-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb602-4"><a href="#cb602-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_lag</span>(items_purchased, revenue, <span class="at">lag =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">default =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb602-5"><a href="#cb602-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb602-6"><a href="#cb602-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb602-7"><a href="#cb602-7" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 2
date_ref:  1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 48 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Lagging: items_purchased and revenue | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb616"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb616-1"><a href="#cb616-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb616-2"><a href="#cb616-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 9
$ event_date            &lt;date&gt; 2020-12-28, 2021-01-27, 2020-12-30, 2020-12-18, 2021-01-09, 2021-01…
$ items_purchased       &lt;dbl&gt; 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 156, …
$ revenue               &lt;dbl&gt; 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, 551,…
$ lag_1_items_purchased &lt;dbl&gt; 0, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 15…
$ lag_2_items_purchased &lt;dbl&gt; 0, 0, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64,…
$ lag_3_items_purchased &lt;dbl&gt; 0, 0, 0, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, …
$ lag_1_revenue         &lt;dbl&gt; 0, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, 5…
$ lag_2_revenue         &lt;dbl&gt; 0, 0, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224…
$ lag_3_revenue         &lt;dbl&gt; 0, 0, 0, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1…</code></pre>
</div>
</div>
<p>The <code>prefix</code> argument also makes it easy to modify the prefix of the outputted column names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb618"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb618-1"><a href="#cb618-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb618-2"><a href="#cb618-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb618-3"><a href="#cb618-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb618-4"><a href="#cb618-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_lag</span>(items_purchased, revenue, <span class="at">lag =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">prefix =</span> <span class="st">"diff_"</span>) <span class="sc">|&gt;</span></span>
<span id="cb618-5"><a href="#cb618-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb618-6"><a href="#cb618-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb618-7"><a href="#cb618-7" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 2
date_ref:  1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 48 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Variable mutation for: ~ymd(event_date) | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Lagging: items_purchased and revenue | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb632"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb632-1"><a href="#cb632-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb632-2"><a href="#cb632-2" aria-hidden="true" tabindex="-1"></a><span class="fu">glimpse</span>(baked_ga)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Rows: 48
Columns: 9
$ event_date             &lt;date&gt; 2020-12-28, 2021-01-27, 2020-12-30, 2020-12-18, 2021-01-09, 2021-0…
$ items_purchased        &lt;dbl&gt; 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, 156,…
$ revenue                &lt;dbl&gt; 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224, 551…
$ diff_1_items_purchased &lt;dbl&gt; NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, 64, …
$ diff_2_items_purchased &lt;dbl&gt; NA, NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, 26, …
$ diff_3_items_purchased &lt;dbl&gt; NA, NA, NA, 187, 51, 317, 398, 68, 133, 140, 527, 63, 356, 96, 40, …
$ diff_1_revenue         &lt;dbl&gt; NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1224,…
$ diff_2_revenue         &lt;dbl&gt; NA, NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 6260, 1…
$ diff_3_revenue         &lt;dbl&gt; NA, NA, NA, 2097, 457, 1606, 6617, 1362, 2406, 2328, 8498, 835, 626…</code></pre>
</div>
</div>
<p>There you have it, another useful <code>step_*()</code> function. <code>step_lag()</code> is pretty straightforward, but the <code>lag</code> argument makes it easy to create many different lagged variables. See you tomorrow.</p>
</section>
<section id="day-19---use-step_log-to-log-transform-variables" class="level1">
<h1>Day 19 - Use <code>step_log()</code> to log transform variables</h1>
<p>Let’s pivot topics at this point in the post. Another type of preprocessing step <code>recipes</code> can perform is data transformations. For today’s example, I’ll spend some time learning about <code>step_log()</code>. <code>step_log()</code> creates a recipe step that will log transform data.</p>
<p>Before highlighting the use of this step function, I wanted to revisit this topic from my Stats 101 course. To refresh my memory, I went to find explanations on what a log transformation is, while also looking for views on why you might employ it as a data preprocessing step in machine learning contexts.</p>
<p>What is a log transformation? In simple terms, it’s using a mathematical function (i.e., a logarithim) to transform variables from one representation to another. The <span class="citation" data-cites="statquest">@statquest</span> YouTube channel has a pretty good <a href="https://www.youtube.com/watch?v=VSi0Z04fWj0">video</a> explaining what a log transformation does when applied to a variable.</p>
<p>Why use a log transformation? In most of what I’ve read, a log transformation is used to address skewed distributions, where it seeks to make the distribution more normal. This normality is important because some models (e.g., linear regression) assume variables are normally distributed. In addition, when employed in various modeling contexts, its application may lead to more accurate model predictions. Several of the articles I read stated log transformations are useful when working in domains that tend to have variables with skewed distributions, like financial data (i.e., salaries, housing prices, etc.). This Stack Exchange <a href="https://datascience.stackexchange.com/questions/40089/what-is-the-reason-behind-taking-log-transformation-of-few-continuous-variables">post</a> provides a pretty good explanation on the use of a log transformation.</p>
<p>To highlight the use of this step function, let’s continue using our obfuscated Google Analytics data. Here’s the code to get started with this data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb634"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb634-1"><a href="#cb634-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb634-2"><a href="#cb634-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb634-3"><a href="#cb634-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb636"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb636-1"><a href="#cb636-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240117</span>)</span>
<span id="cb636-2"><a href="#cb636-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb636-3"><a href="#cb636-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb636-4"><a href="#cb636-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span>
<span id="cb636-5"><a href="#cb636-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb636-6"><a href="#cb636-6" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(ga_tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">ga_tr</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">7492</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">item_name</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">384</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_category</td>
<td style="text-align: right;">132</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">shipping_tier</td>
<td style="text-align: right;">85</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">payment_type</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">category</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">country</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">94</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">285</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">city</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">420</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">event_date</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">20203701.15</td>
<td style="text-align: right;">3996.13</td>
<td style="text-align: right;">20201201</td>
<td style="text-align: right;">20201209</td>
<td style="text-align: right;">20201216</td>
<td style="text-align: right;">20210106.0</td>
<td style="text-align: right;">20210130</td>
<td style="text-align: left;">▇▁▁▁▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">purchase_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">101.74</td>
<td style="text-align: right;">119.22</td>
<td style="text-align: right;">2</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">124.0</td>
<td style="text-align: right;">1530</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">transaction_id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">487314.88</td>
<td style="text-align: right;">283530.55</td>
<td style="text-align: right;">546</td>
<td style="text-align: right;">246420</td>
<td style="text-align: right;">479575</td>
<td style="text-align: right;">724942.5</td>
<td style="text-align: right;">999850</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">price_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19.57</td>
<td style="text-align: right;">18.85</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">120</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">quantity</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.41</td>
<td style="text-align: right;">2.13</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">53</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23.26</td>
<td style="text-align: right;">28.89</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">704</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s take a quick look at <code>item_revenue_in_usd</code>. Using <code>skim()</code>, this variable ranges from $1 to $704. Now let’s peek at the distribution of the <code>item_revenue_in_usd</code> using base R plotting.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb637"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb637-1"><a href="#cb637-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ga_tr<span class="sc">$</span>item_revenue_in_usd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-19-vis-item-rev-hist-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Indeed, this variable is skewed to the right. A log transformation would be appropriate here. Let’s do this by using <code>step_log()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb638"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb638-1"><a href="#cb638-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb638-2"><a href="#cb638-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb638-3"><a href="#cb638-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(item_revenue_in_usd) <span class="sc">|&gt;</span></span>
<span id="cb638-4"><a href="#cb638-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb638-5"><a href="#cb638-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb638-6"><a href="#cb638-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 13
date_ref:   1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Log transformation on: item_revenue_in_usd | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb651"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb651-1"><a href="#cb651-1" aria-hidden="true" tabindex="-1"></a>bake_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we transformed the variable, let’s explore the histogram of our baked variable and see its effect on the distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb652"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb652-1"><a href="#cb652-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bake_ga<span class="sc">$</span>item_revenue_in_usd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-19-vis-item-rev-bake-hist-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Not bad. The transformed <code>item_revenue_in_usd</code> now exhibits a more normal distribution.</p>
<p><code>step_log()</code> also has a few useful arguments. The first useful argument is <code>base</code>. When taking the log, R defaults to using the natural log, or <code>exp(1)</code>. Say we want to log using base 10? This is certainly useful when dealing with money, since money makes more since in multiples of 10 (e.g., $100, $1,000, $10,000, etc.). Lets change the base of our recipe and see what happens.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb653"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb653-1"><a href="#cb653-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb653-2"><a href="#cb653-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb653-3"><a href="#cb653-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(item_revenue_in_usd, <span class="at">base =</span> <span class="dv">10</span>) <span class="sc">|&gt;</span></span>
<span id="cb653-4"><a href="#cb653-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb653-5"><a href="#cb653-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb653-6"><a href="#cb653-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 13
date_ref:   1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Log transformation on: item_revenue_in_usd | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb666"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb666-1"><a href="#cb666-1" aria-hidden="true" tabindex="-1"></a>bake_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb667"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb667-1"><a href="#cb667-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bake_ga<span class="sc">$</span>item_revenue_in_usd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-19-change-base-bake-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The second useful argument is the <code>offset</code> argument. This argument accepts a value to offset the data prior to logging, which helps us avoid <code>log(0)</code>. Here’s some example code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb668"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb668-1"><a href="#cb668-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb668-2"><a href="#cb668-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb668-3"><a href="#cb668-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(item_revenue_in_usd, <span class="at">offset =</span> <span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb668-4"><a href="#cb668-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb668-5"><a href="#cb668-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb668-6"><a href="#cb668-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 13
date_ref:   1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Log transformation on: item_revenue_in_usd | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb681"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb681-1"><a href="#cb681-1" aria-hidden="true" tabindex="-1"></a>bake_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb682"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb682-1"><a href="#cb682-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bake_ga<span class="sc">$</span>item_revenue_in_usd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-19-offset-bake-hist-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The final useful argument is <code>signed</code>, which accepts a boolean. Setting this argument to <code>TRUE</code> will make <code>step_log()</code> calculate the signed log. This is useful in cases where you have negative values, since a standard log transformation can’t be used to transform negative values. I found this <a href="https://www.r-statistics.com/2013/05/log-transformations-for-skewed-and-wide-distributions-from-practical-data-science-with-r/">article</a> useful for getting an intuitive sense of what the signed log is and how it can useful for modeling. Here’s the code to serve as an example, even though we don’t have any negative values in our data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb683"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb683-1"><a href="#cb683-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb683-2"><a href="#cb683-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(event_date, <span class="at">new_role =</span> <span class="st">"date_ref"</span>) <span class="sc">|&gt;</span></span>
<span id="cb683-3"><a href="#cb683-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_log</span>(item_revenue_in_usd, <span class="at">signed =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb683-4"><a href="#cb683-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb683-5"><a href="#cb683-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb683-6"><a href="#cb683-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 13
date_ref:   1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 216 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Signed log transformation on: item_revenue_in_usd | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb696"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb696-1"><a href="#cb696-1" aria-hidden="true" tabindex="-1"></a>bake_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb697"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb697-1"><a href="#cb697-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bake_ga<span class="sc">$</span>item_revenue_in_usd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-19-signed-log-bake-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>That’s it for today. <code>step_log()</code> is a great first step in learning all the transformations <code>recipes</code> can do. I’m looking forward to tomorrow.</p>
</section>
<section id="day-20---use-step_sqrt-to-apply-a-square-root-transformation" class="level1">
<h1>Day 20 - Use <code>step_sqrt()</code> to apply a square root transformation</h1>
<p>Welcome back fellow learners. I had to take a couple days off because my schedule didn’t allow me the time to focus on this post. Nevertheless, let’s get back to it.</p>
<p>Today I’m focusing on another transformation function, <code>step_sqrt()</code>. <code>step_sqrt()</code> applies a square root transformation to variables. This function is similair to <code>step_log()</code>–it’s just applying a different function to the variable.</p>
<p>The square root transformation is pretty straightforward, but I did some digging to more deeply understand what it is and why it’s useful. Here’s what I came up with:</p>
<ul>
<li><p><a href="https://stats.stackexchange.com/questions/11359/what-could-be-the-reason-for-using-square-root-transformation-on-data">What could be the reason for using square root transformation on data? - Cross Validated post</a></p></li>
<li><p><a href="https://stats.stackexchange.com/questions/46418/why-is-the-square-root-transformation-recommended-for-count-data">Why is the square root transformation recommended for count data? - Cross Validated post</a></p></li>
</ul>
<p>Let’s get our data. I’m going to continue using the obfuscated Google Analytics ecommerce data we’ve been working with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb698"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb698-1"><a href="#cb698-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb698-2"><a href="#cb698-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb698-3"><a href="#cb698-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb700"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb700-1"><a href="#cb700-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240122</span>)</span>
<span id="cb700-2"><a href="#cb700-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb700-3"><a href="#cb700-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb700-4"><a href="#cb700-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span>
<span id="cb700-5"><a href="#cb700-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb700-6"><a href="#cb700-6" aria-hidden="true" tabindex="-1"></a><span class="fu">skim</span>(ga_tr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<caption>Data summary</caption>
<tbody>
<tr class="odd">
<td style="text-align: left;">Name</td>
<td style="text-align: left;">ga_tr</td>
</tr>
<tr class="even">
<td style="text-align: left;">Number of rows</td>
<td style="text-align: left;">7492</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Number of columns</td>
<td style="text-align: left;">14</td>
</tr>
<tr class="even">
<td style="text-align: left;">_______________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Column type frequency:</td>
<td style="text-align: left;"></td>
</tr>
<tr class="even">
<td style="text-align: left;">character</td>
<td style="text-align: left;">8</td>
</tr>
<tr class="odd">
<td style="text-align: left;">numeric</td>
<td style="text-align: left;">6</td>
</tr>
<tr class="even">
<td style="text-align: left;">________________________</td>
<td style="text-align: left;"></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Group variables</td>
<td style="text-align: left;">None</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: character</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 13%">
<col style="width: 19%">
<col style="width: 5%">
<col style="width: 5%">
<col style="width: 8%">
<col style="width: 12%">
<col style="width: 15%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">min</th>
<th style="text-align: right;">max</th>
<th style="text-align: right;">empty</th>
<th style="text-align: right;">n_unique</th>
<th style="text-align: right;">whitespace</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">item_name</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">41</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">382</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_category</td>
<td style="text-align: right;">138</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">23</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">shipping_tier</td>
<td style="text-align: right;">84</td>
<td style="text-align: right;">0.99</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">22</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">13</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">payment_type</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">category</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">6</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">country</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">20</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">93</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="odd">
<td style="text-align: left;">region</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">52</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">282</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">city</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">4</td>
<td style="text-align: right;">24</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">419</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
<p><strong>Variable type: numeric</strong></p>
<table class="table table-sm table-striped small">
<colgroup>
<col style="width: 19%">
<col style="width: 8%">
<col style="width: 11%">
<col style="width: 9%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 4%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">skim_variable</th>
<th style="text-align: right;">n_missing</th>
<th style="text-align: right;">complete_rate</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">p0</th>
<th style="text-align: right;">p25</th>
<th style="text-align: right;">p50</th>
<th style="text-align: right;">p75</th>
<th style="text-align: right;">p100</th>
<th style="text-align: left;">hist</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">event_date</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">20203682.14</td>
<td style="text-align: right;">3986.72</td>
<td style="text-align: right;">20201201</td>
<td style="text-align: right;">20201209</td>
<td style="text-align: right;">20201216</td>
<td style="text-align: right;">20210106.0</td>
<td style="text-align: right;">20210130</td>
<td style="text-align: left;">▇▁▁▁▃</td>
</tr>
<tr class="even">
<td style="text-align: left;">purchase_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">101.68</td>
<td style="text-align: right;">118.25</td>
<td style="text-align: right;">3</td>
<td style="text-align: right;">39</td>
<td style="text-align: right;">72</td>
<td style="text-align: right;">124.0</td>
<td style="text-align: right;">1530</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">transaction_id</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">487567.11</td>
<td style="text-align: right;">282529.44</td>
<td style="text-align: right;">546</td>
<td style="text-align: right;">250363</td>
<td style="text-align: right;">477087</td>
<td style="text-align: right;">723799.8</td>
<td style="text-align: right;">999850</td>
<td style="text-align: left;">▇▇▇▇▇</td>
</tr>
<tr class="even">
<td style="text-align: left;">price_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">19.55</td>
<td style="text-align: right;">18.80</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">7</td>
<td style="text-align: right;">14</td>
<td style="text-align: right;">24.0</td>
<td style="text-align: right;">120</td>
<td style="text-align: left;">▇▂▁▁▁</td>
</tr>
<tr class="odd">
<td style="text-align: left;">quantity</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.45</td>
<td style="text-align: right;">2.89</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1.0</td>
<td style="text-align: right;">160</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
<tr class="even">
<td style="text-align: left;">item_revenue_in_usd</td>
<td style="text-align: right;">0</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">23.40</td>
<td style="text-align: right;">29.67</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">8</td>
<td style="text-align: right;">15</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">704</td>
<td style="text-align: left;">▇▁▁▁▁</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We do have some count data, <code>quantity</code>. This is the number of times a specific item was purchased. Let’s take a look at its distribution before we apply our transformation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb701"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb701-1"><a href="#cb701-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ga_tr<span class="sc">$</span>quantity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-20-vis-quantity-distribution-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Indeed, this data seems to follow a Poisson Distribution. Let’s see if we can transform it to be more normal (Gaussian) with a square root transformation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb702"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb702-1"><a href="#cb702-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb702-2"><a href="#cb702-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_sqrt</span>(quantity) <span class="sc">|&gt;</span></span>
<span id="cb702-3"><a href="#cb702-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb702-4"><a href="#cb702-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb702-5"><a href="#cb702-5" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 7492 data points and 221 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Square root transformation on: quantity | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb715"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb715-1"><a href="#cb715-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb715-2"><a href="#cb715-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb715-3"><a href="#cb715-3" aria-hidden="true" tabindex="-1"></a>baked_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 7,492 × 14
   event_date purchase_revenue_in_usd transaction_id item_name   item_category price_in_usd quantity
        &lt;dbl&gt;                   &lt;dbl&gt;          &lt;dbl&gt; &lt;fct&gt;       &lt;fct&gt;                &lt;dbl&gt;    &lt;dbl&gt;
 1   20201211                      60         411613 Supernatur… Bags                    46     1   
 2   20210126                      68         315802 Google Sea… Campus Colle…            7     1   
 3   20201217                      75         940161 Google Inc… Bags                    75     1   
 4   20210114                      83          22807 Google Pen… Office                   1     1.41
 5   20201215                      95         892183 Google Fel… Clearance               16     1.41
 6   20210102                     183         548270 Google Wom… Apparel                 50     1   
 7   20201217                      16         199350 Google Per… Lifestyle               16     1   
 8   20201228                      44         302288 Google Lap… New                      8     1   
 9   20210124                     104          19596 Google Key… New                      6     1.41
10   20201212                      74         539684 Google Bou… Clearance               14     1   
# ℹ 7,482 more rows
# ℹ 7 more variables: item_revenue_in_usd &lt;dbl&gt;, shipping_tier &lt;fct&gt;, payment_type &lt;fct&gt;,
#   category &lt;fct&gt;, country &lt;fct&gt;, region &lt;fct&gt;, city &lt;fct&gt;</code></pre>
</div>
</div>
<p>Now we’ll check out the effect of the transformation by looking at a histogram of the baked data’s <code>quantity</code> variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb717"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb717-1"><a href="#cb717-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(baked_ga<span class="sc">$</span>quantity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-20-vis-baked-hist-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can further explore the effect of this transformation by plotting the un-transformed variable on a scatter plot with the baked variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb718"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb718-1"><a href="#cb718-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ga_tr<span class="sc">$</span>quantity, baked_ga<span class="sc">$</span>quantity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-20-vis-baked-scatter-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Eh, looking at the histogram it seems this transformation didn’t really help very much. My assumption is this is due to many items only being purchased once. Thus, no transformation would likely be helpful in this case. Nonetheless, <code>step_sqrt()</code> is a pretty simple transformation function. You might find it useful when working with your data.</p>
</section>
<section id="day-21---apply-the-box-cox-transformation-using-step_boxcox" class="level1">
<h1>Day 21 - Apply the Box-Cox transformation using <code>step_BoxCox()</code></h1>
<p>Here we are, another day of transformations. To get us started, I turned to <a href="https://chat.openai.com/">ChatGPT</a> for a joke about data transformations.</p>
<p>Hey ChatGPT, tell me a joke about data transformations (prompt).</p>
<blockquote class="blockquote">
<p>Why do data transformations never get invited to parties?</p>
<p>Because they always skew the conversation and standard deviations can be quite awkward!</p>
</blockquote>
<p>Not bad … Okay, let’s talk about <code>step_BoxCox()</code>. This function applies a <a href="https://en.wikipedia.org/wiki/Power_transform#Box%E2%80%93Cox_transformation">Box Cox Transformation</a> to our variables. I haven’t used this transformation in some time, so I scoured the internet to get back up to speed. I found these sources helpful in reminding me what this transformation is and how it can be useful:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=zYeTyEWt7Cw">Transforming the response(Y) in regression: Box Cox transformation (7 mins)</a> from the <span class="citation" data-cites="PhilChanstats">@PhilChanstats</span> YouTube channel</li>
<li><a href="https://www.youtube.com/watch?v=2gVA3TudAXI&amp;t=4s">Box Cox transformation formula in regression analysis</a> from the <span class="citation" data-cites="PhilChanstats">@PhilChanstats</span> YouTube channel</li>
<li><a href="https://www.youtube.com/watch?v=vGOpEpjz2Ks">Box-Cox Transformation + R Demo</a> from the <span class="citation" data-cites="mathetal">@mathetal</span> YouTube channel</li>
</ul>
<p>Though the following is a simplified explanation, many of these sources mention the Box Cox transformation attempts to make our distribution more normal. It does this by focusing on the tails of the distribution. Box Cox can be applied in situations where variance is not equal (i.e., heteroscedasticity). This transformation also allows us to better meet the assumptions of our models, and its application can result in a better predictive model. Lastly, many of these sources suggest this transformation is applied to the outcome variable of our model.</p>
<p>Let’s go back to our Google Analytics obfuscated ecommerce data for today’s examples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb719"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb719-1"><a href="#cb719-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb719-2"><a href="#cb719-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb719-3"><a href="#cb719-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb721"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb721-1"><a href="#cb721-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga <span class="sc">|&gt;</span></span>
<span id="cb721-2"><a href="#cb721-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb721-3"><a href="#cb721-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb721-4"><a href="#cb721-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">items_purchased =</span> <span class="fu">sum</span>(quantity),</span>
<span id="cb721-5"><a href="#cb721-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> <span class="fu">sum</span>(item_revenue_in_usd)</span>
<span id="cb721-6"><a href="#cb721-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb721-7"><a href="#cb721-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb721-8"><a href="#cb721-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240122</span>)</span>
<span id="cb721-9"><a href="#cb721-9" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb721-10"><a href="#cb721-10" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb721-11"><a href="#cb721-11" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Since we can use the Box Cox transformation to rescale a variable to be more normal, let’s see if the <code>revenue</code> variable will be a good candidate. You’ll notice the application of the Box Cox transformation is pretty straightforward (like most of <code>recipes</code>’ transformation functions) with <code>step_BoxCox()</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb722"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb722-1"><a href="#cb722-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ga_tr<span class="sc">$</span>revenue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-21-vis-hist-revenue-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Indeed, this varible exhibits a slight right skew. Let’s use the <code>step_BoxCox()</code> function here to perform the transformation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb723"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb723-1"><a href="#cb723-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(revenue <span class="sc">~</span> ., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb723-2"><a href="#cb723-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_BoxCox</span>(revenue) <span class="sc">|&gt;</span></span>
<span id="cb723-3"><a href="#cb723-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb723-4"><a href="#cb723-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb723-5"><a href="#cb723-5" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>outcome:   1
predictor: 2</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 48 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Box-Cox transformation on: revenue | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb736"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb736-1"><a href="#cb736-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb736-2"><a href="#cb736-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb736-3"><a href="#cb736-3" aria-hidden="true" tabindex="-1"></a>baked_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 48 × 3
   event_date items_purchased revenue
        &lt;dbl&gt;           &lt;dbl&gt;   &lt;dbl&gt;
 1   20210101              97    14.2
 2   20210126              61    15.2
 3   20201225              40    12.2
 4   20210125             199    19.4
 5   20201211             617    25.3
 6   20210115             119    17.2
 7   20210120             400    22.8
 8   20201201             356    22.5
 9   20201205             333    22.6
10   20201224              69    15.0
# ℹ 38 more rows</code></pre>
</div>
</div>
<p>Not too bad. The distribution has been rescaled to resemble a slightly more normal distribution. The following histogram shows the effect of this transformation on the distribution.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb738"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb738-1"><a href="#cb738-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(baked_ga<span class="sc">$</span>revenue)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-21-vis-hist-transform-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>If for some reason you wanted to inspect the lambda value used by the transformation, you can inspect it by tidying the recipe. The outputted table shows lambda in the <code>value</code> column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb739"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb739-1"><a href="#cb739-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  terms   value id          
  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;       
1 revenue 0.190 BoxCox_GMKqI</code></pre>
</div>
</div>
<p><code>step_BoxCox()</code> is pretty simple, but useful. You might give it a try if you have some data of positive values exihibiting skewness. Until tomorrow, keep having fun with <code>recipes</code>.</p>
</section>
<section id="day-22---apply-an-inverse-transformation-using-step_inverse" class="level1">
<h1>Day 22 - Apply an inverse transformation using <code>step_inverse()</code></h1>
<p>I’m keeping things simple today; <code>step_inverse()</code> is my focus. This step function will inverse transform our data. Just like the other transformation functions, <code>recipes</code> makes it pretty easy to perform.</p>
<p>Let’s continue using our Google Analytics ecommerce data for today’s example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb741"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb741-1"><a href="#cb741-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb741-2"><a href="#cb741-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb741-3"><a href="#cb741-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb743"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb743-1"><a href="#cb743-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga <span class="sc">|&gt;</span></span>
<span id="cb743-2"><a href="#cb743-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb743-3"><a href="#cb743-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb743-4"><a href="#cb743-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">items_purchased =</span> <span class="fu">sum</span>(quantity),</span>
<span id="cb743-5"><a href="#cb743-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> <span class="fu">sum</span>(item_revenue_in_usd)</span>
<span id="cb743-6"><a href="#cb743-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb743-7"><a href="#cb743-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb743-8"><a href="#cb743-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240122</span>)</span>
<span id="cb743-9"><a href="#cb743-9" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb743-10"><a href="#cb743-10" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb743-11"><a href="#cb743-11" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just as a quick reminder, let’s take a look at the histogram of <code>items_purchased</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb744"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb744-1"><a href="#cb744-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ga_tr<span class="sc">$</span>items_purchased)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-22-vis-items-purchased-hist-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>To apply an inverse transformation to our variable, we do the following in our recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb745"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb745-1"><a href="#cb745-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_te) <span class="sc">|&gt;</span></span>
<span id="cb745-2"><a href="#cb745-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_inverse</span>(items_purchased) <span class="sc">|&gt;</span></span>
<span id="cb745-3"><a href="#cb745-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb745-4"><a href="#cb745-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb745-5"><a href="#cb745-5" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 13 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Inverse transformation on: items_purchased | Trained</code></pre>
</div>
</div>
<p>Now bake.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb758"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb758-1"><a href="#cb758-1" aria-hidden="true" tabindex="-1"></a>ga_baked <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb758-2"><a href="#cb758-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb758-3"><a href="#cb758-3" aria-hidden="true" tabindex="-1"></a>ga_baked</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 3
   event_date items_purchased revenue
        &lt;dbl&gt;           &lt;dbl&gt;   &lt;dbl&gt;
 1   20201202         0.00366    5202
 2   20201203         0.00319    4313
 3   20201207         0.00215    8466
 4   20201208         0.00161    8691
 5   20201214         0.00190    8498
 6   20201219         0.00714    2778
 7   20201222         0.00474    3226
 8   20201230         0.00315    1606
 9   20201231         0.0106     2595
10   20210102         0.00990    1025
11   20210113         0.00990    1859
12   20210116         0.0139     1462
13   20210123         0.00524    2744</code></pre>
</div>
</div>
<p>Here’s the effect of the transformation on our variable in two plots.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb760"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb760-1"><a href="#cb760-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ga_baked<span class="sc">$</span>items_purchased)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-22-vis-effect-trans-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb761"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb761-1"><a href="#cb761-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ga_te<span class="sc">$</span>items_purchased, ga_baked<span class="sc">$</span>items_purchased)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-22-vis-effect-trans-2.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The inverse did a pretty good job of making this distribution more normal.</p>
<p>Like I said, keeping things simple today with a straight forward <code>step_*()</code> function. <code>recipes</code> makes it pretty easy to perform the inverse transformation with the <code>step_inverse()</code> function.</p>
</section>
<section id="day-23---use-extension-packages-to-get-even-more-steps" class="level1">
<h1>Day 23 - Use extension packages to get even more steps</h1>
<p>Recently, I’ve felt these posts have become a little stale and templated. So today, I’m switching it up a bit. I’m highlighting <code>recipes</code> extension packages. I’m also using this post for a bit of inspiration; I’m exploring other <code>step_*</code> functions to highlight. As such, I most likely won’t describe specific examples from each package in today’s post (there’s too many to cover). However, I’m aiming to list them here and highlight some packages that would be useful for the work I do.</p>
<p>Several packages are available that provide additional <code>step_*()</code> functions, which are outside the core functionality of the <code>recipes</code> package. At the time of this writing, these include but are not limited to:</p>
<ul>
<li><a href="https://mattheaphy.github.io/actxps/"><code>actxps</code></a></li>
<li><a href="https://petersonr.github.io/bestNormalize/"><code>bestNormalize</code></a></li>
<li><a href="https://github.com/smaakage85/customsteps"><code>customsteps</code></a></li>
<li><a href="https://embed.tidymodels.org/"><code>embed</code></a></li>
<li><a href="https://emilhvitfeldt.github.io/extrasteps/"><code>extrasteps</code></a></li>
<li><a href="https://github.com/rstudio/tfhub"><code>tfhub</code></a></li>
<li><a href="https://docs.healthcare.ai/"><code>healthcareai</code></a></li>
<li><a href="https://www.spsanderson.com/healthyR.ai/"><code>healthyR.ai</code></a></li>
<li><a href="https://www.spsanderson.com/healthyR.ts/"><code>healthyR.ts</code></a></li>
<li><a href="https://github.com/jkennel/hydrorecipes"><code>hydrorecipes</code></a></li>
<li><a href="https://brian-j-smith.github.io/MachineShop/"><code>MachineShop</code></a></li>
<li><a href="https://brian-j-smith.github.io/MachineShop/"><code>measure</code></a></li>
<li><a href="https://ashbythorpe.github.io/nestedmodels/"><code>nestedmodels</code></a></li>
<li><a href="https://petersonr.github.io/sparseR/"><code>sparseR</code></a></li>
<li><a href="https://textrecipes.tidymodels.org/"><code>textrecipes</code></a></li>
<li><a href="https://themis.tidymodels.org/"><code>themis</code></a></li>
<li><a href="https://business-science.github.io/timetk/"><code>timetk</code></a></li>
</ul>
<p>The <code>tidymodels</code> site provides a <a href="https://www.tidymodels.org/find/recipes/">table</a> of a good majority of <code>step_*()</code> functions made available via these extension packages. Shout out to <span class="citation" data-cites="jonthegeek">@jonthegeek</span> from the R4DS Online Learning Community for pointing me to this table, and much praise to <code>@Emil Hvitfeldt</code> for pointing me in the direction of additional <code>recipes</code> extension packages I wasn’t aware. Keep in mind, not all of these extension packages are made available on <a href="https://cran.r-project.org/">CRAN</a>.</p>
<p>Taking a moment to read the descriptions of each extension package, I found <code>textrecipes</code>, <code>themis</code>, and <code>timetk</code> to be the most applicable to my work. Here’s a brief description of what each does. I also included some functions that could be interesting to explore in future posts. Note, some of these packages are meant to be applied in a specific domain, so their purpose may not solely be to be an extension of <code>recipes</code> (e.g., <code>timetk</code>).</p>
<ul>
<li><p>The <code>textrecipes</code> package provides extra <code>step_*()</code> functions to preprocess text data. Looking through the package’s <a href="https://textrecipes.tidymodels.org/reference/index.html"><code>reference</code></a> section, the <code>step_tokenize()</code> family of functions look useful. I also find the token modification (e.g., <code>step_stem()</code> and <code>step_stopwords()</code>) and text cleaning functions (e.g.&nbsp;<code>step_clean_levels()</code>) to be intriguing and worth further exploration.</p></li>
<li><p>The <code>themis</code> package provides additional <code>step_*()</code> functions to assist in the preprocessing of unbalanced data. Specifically, this package provides functions to apply over-sampling or under-sampling methods to unbalance the data used for modeling. There’s several functions in here that seem to be useful when dealing with unbalanced data. I highly suggest checking out its <a href="https://themis.tidymodels.org/reference/index.html">reference page</a> to get an idea of what all is available.</p></li>
<li><p>The <code>timetk</code> package does more than extend <code>recipes</code>. It’s main focus is to assist in the analysis of timeseries data. The package contains some similar functions we’ve highlighted before (e.g., <code>step_holiday_signature()</code> and <code>step_box_cox()</code>). However, there’s some additional functions of interest. <code>step_ts_pad()</code> seems useful in cases where you need to add rows to fill in gaps. <code>step_ts_clean()</code> helps to clean outliers and missing data for timeseries analysis. <code>step_diff()</code> also looks helpful if you need to create a differenced predictor. If you’re working with timeseries, you might want to explore this package some more.</p></li>
</ul>
<p>Indeed, the <code>tidymodels</code> ecosystem is quite vast. This is especially true in the area of preprocessing steps achieved by extension packages for the <code>recipes</code> package.</p>
<p>I wanted to shake it up a little bit. Today’s post was a little different, but in a good, refreshing way. See you tomorrow.</p>
</section>
<section id="day-24---use-step_tokenize-from-textrecipes-to-convert-a-character-predictor-into-a-token-variable" class="level1">
<h1>Day 24 - Use <code>step_tokenize()</code> from <code>textrecipes</code> to convert a character predictor into a <code>token</code> variable</h1>
<p>Building on yesterday’s post, I’ll begin exploring <code>recipes</code> extension packages’ functions. <code>step_tokenize()</code> from <a href="https://textrecipes.tidymodels.org/"><code>textrecipes</code></a> is first up. This function is useful when we need to convert a character variable into a token variable. If you’re unfamiliar with the concept of tokenization, the <a href="https://www.tidytextmining.com/tidytext">Text Mining with R: A Tidy Approach</a> provides an overview.</p>
<p>I’ll keep things simple here by using a pared down data set. This will make it easier to see what this <code>step_function()</code> is doing. How about some <a href="https://stats.stackexchange.com/questions/726/famous-statistical-quotations?page=1&amp;tab=scoredesc#tab-top">quotes</a> about statistics?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb762"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb762-1"><a href="#cb762-1" aria-hidden="true" tabindex="-1"></a>quotes <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb762-2"><a href="#cb762-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">text =</span> <span class="fu">c</span>(</span>
<span id="cb762-3"><a href="#cb762-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"All models are wrong, but some are useful."</span>,</span>
<span id="cb762-4"><a href="#cb762-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Statisticians, like artists, have the bad habit of falling in love with their models."</span>,</span>
<span id="cb762-5"><a href="#cb762-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"If you torture the data enough, nature will always confess."</span>,</span>
<span id="cb762-6"><a href="#cb762-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"All generalizations are false, including this one."</span></span>
<span id="cb762-7"><a href="#cb762-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb762-8"><a href="#cb762-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s create our recipe to tokenize by word.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb763"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb763-1"><a href="#cb763-1" aria-hidden="true" tabindex="-1"></a>quotes_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb763-2"><a href="#cb763-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb763-3"><a href="#cb763-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() </span>
<span id="cb763-4"><a href="#cb763-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb763-5"><a href="#cb763-5" aria-hidden="true" tabindex="-1"></a>quotes_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 4 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Tokenization for: text | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb776"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb776-1"><a href="#cb776-1" aria-hidden="true" tabindex="-1"></a>baked_quotes <span class="ot">&lt;-</span> <span class="fu">bake</span>(quotes_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb776-2"><a href="#cb776-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb776-3"><a href="#cb776-3" aria-hidden="true" tabindex="-1"></a>baked_quotes</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 1
         text
    &lt;tknlist&gt;
1  [8 tokens]
2 [14 tokens]
3 [10 tokens]
4  [7 tokens]</code></pre>
</div>
</div>
<p>One thing I didn’t expect, but learned, was <code>step_tokenize()</code> creates a <code>tknlist</code> column. Indeed, I expected the column to still be a character where every token was placed on it’s own row, like what happens when you use <a href="https://juliasilge.github.io/tidytext/"><code>tidytext</code></a> functions. This certainly makes the object more compact and easier to work with, an excellent design decision in my opinion. To see the tokens, though, we need to use <code>recipes</code> <code>show_tokens()</code> function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb778"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb778-1"><a href="#cb778-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb778-2"><a href="#cb778-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(text) <span class="sc">|&gt;</span></span>
<span id="cb778-3"><a href="#cb778-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_tokens</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "all"    "models" "are"    "wrong"  "but"    "some"   "are"    "useful"

[[2]]
 [1] "statisticians" "like"          "artists"       "have"          "the"           "bad"          
 [7] "habit"         "of"            "falling"       "in"            "love"          "with"         
[13] "their"         "models"       

[[3]]
 [1] "if"      "you"     "torture" "the"     "data"    "enough"  "nature"  "will"    "always" 
[10] "confess"

[[4]]
[1] "all"             "generalizations" "are"             "false"           "including"      
[6] "this"            "one"            </code></pre>
</div>
</div>
<p><code>step_tokenize()</code> defaults to tokenizing by word. However, there are several ways we can tokenize by. To do this, we modify the <code>tokenizers</code> argument. For example, say we want to tokenize by character instead of word. We do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb780"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb780-1"><a href="#cb780-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb780-2"><a href="#cb780-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(text, <span class="at">token =</span> <span class="st">"characters"</span>) <span class="sc">|&gt;</span></span>
<span id="cb780-3"><a href="#cb780-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_tokens</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
 [1] "a" "l" "l" "m" "o" "d" "e" "l" "s" "a" "r" "e" "w" "r" "o" "n" "g" "b" "u" "t" "s" "o" "m" "e"
[25] "a" "r" "e" "u" "s" "e" "f" "u" "l"

[[2]]
 [1] "s" "t" "a" "t" "i" "s" "t" "i" "c" "i" "a" "n" "s" "l" "i" "k" "e" "a" "r" "t" "i" "s" "t" "s"
[25] "h" "a" "v" "e" "t" "h" "e" "b" "a" "d" "h" "a" "b" "i" "t" "o" "f" "f" "a" "l" "l" "i" "n" "g"
[49] "i" "n" "l" "o" "v" "e" "w" "i" "t" "h" "t" "h" "e" "i" "r" "m" "o" "d" "e" "l" "s"

[[3]]
 [1] "i" "f" "y" "o" "u" "t" "o" "r" "t" "u" "r" "e" "t" "h" "e" "d" "a" "t" "a" "e" "n" "o" "u" "g"
[25] "h" "n" "a" "t" "u" "r" "e" "w" "i" "l" "l" "a" "l" "w" "a" "y" "s" "c" "o" "n" "f" "e" "s" "s"

[[4]]
 [1] "a" "l" "l" "g" "e" "n" "e" "r" "a" "l" "i" "z" "a" "t" "i" "o" "n" "s" "a" "r" "e" "f" "a" "l"
[25] "s" "e" "i" "n" "c" "l" "u" "d" "i" "n" "g" "t" "h" "i" "s" "o" "n" "e"</code></pre>
</div>
</div>
<p>How about by word stems?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb782"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb782-1"><a href="#cb782-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb782-2"><a href="#cb782-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(text, <span class="at">token =</span> <span class="st">"word_stems"</span>) <span class="sc">|&gt;</span></span>
<span id="cb782-3"><a href="#cb782-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_tokens</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "all"   "model" "are"   "wrong" "but"   "some"  "are"   "use"  

[[2]]
 [1] "statistician" "like"         "artist"       "have"         "the"          "bad"         
 [7] "habit"        "of"           "fall"         "in"           "love"         "with"        
[13] "their"        "model"       

[[3]]
 [1] "if"      "you"     "tortur"  "the"     "data"    "enough"  "natur"   "will"    "alway"  
[10] "confess"

[[4]]
[1] "all"     "general" "are"     "fals"    "includ"  "this"    "one"    </code></pre>
</div>
</div>
<p>ngrams?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb784"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb784-1"><a href="#cb784-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb784-2"><a href="#cb784-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(text, <span class="at">token =</span> <span class="st">"ngrams"</span>) <span class="sc">|&gt;</span></span>
<span id="cb784-3"><a href="#cb784-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_tokens</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "all models are"   "models are wrong" "are wrong but"    "wrong but some"   "but some are"    
[6] "some are useful" 

[[2]]
 [1] "statisticians like artists" "like artists have"          "artists have the"          
 [4] "have the bad"               "the bad habit"              "bad habit of"              
 [7] "habit of falling"           "of falling in"              "falling in love"           
[10] "in love with"               "love with their"            "with their models"         

[[3]]
[1] "if you torture"      "you torture the"     "torture the data"    "the data enough"    
[5] "data enough nature"  "enough nature will"  "nature will always"  "will always confess"

[[4]]
[1] "all generalizations are"   "generalizations are false" "are false including"      
[4] "false including this"      "including this one"       </code></pre>
</div>
</div>
<p>Say we only want 2 words in our ngram tokens. In this case, we need to pass argument values to the <code>tokenizers::tokenize_ngrams()</code> function using <code>step_tokenize()</code>’s <code>options</code> argument. Here we pass all the argument values in a list.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb786"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb786-1"><a href="#cb786-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb786-2"><a href="#cb786-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(</span>
<span id="cb786-3"><a href="#cb786-3" aria-hidden="true" tabindex="-1"></a>    text, </span>
<span id="cb786-4"><a href="#cb786-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">token =</span> <span class="st">"ngrams"</span>,</span>
<span id="cb786-5"><a href="#cb786-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="dv">2</span>)</span>
<span id="cb786-6"><a href="#cb786-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb786-7"><a href="#cb786-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_tokens</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "all models" "models are" "are wrong"  "wrong but"  "but some"   "some are"   "are useful"

[[2]]
 [1] "statisticians like" "like artists"       "artists have"       "have the"          
 [5] "the bad"            "bad habit"          "habit of"           "of falling"        
 [9] "falling in"         "in love"            "love with"          "with their"        
[13] "their models"      

[[3]]
[1] "if you"         "you torture"    "torture the"    "the data"       "data enough"   
[6] "enough nature"  "nature will"    "will always"    "always confess"

[[4]]
[1] "all generalizations" "generalizations are" "are false"           "false including"    
[5] "including this"      "this one"           </code></pre>
</div>
</div>
<p>Going further, say we want to also exclude stop words (e.g., the, is, and) from being included within our ngrams. We just pass this option along in our list of options.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb788"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb788-1"><a href="#cb788-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span> text, <span class="at">data =</span> quotes) <span class="sc">|&gt;</span></span>
<span id="cb788-2"><a href="#cb788-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_tokenize</span>(</span>
<span id="cb788-3"><a href="#cb788-3" aria-hidden="true" tabindex="-1"></a>    text, </span>
<span id="cb788-4"><a href="#cb788-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">token =</span> <span class="st">"ngrams"</span>,</span>
<span id="cb788-5"><a href="#cb788-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">options =</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="dv">2</span>, <span class="at">stopwords =</span> <span class="fu">c</span>(<span class="st">"the"</span>, <span class="st">"is"</span>, <span class="st">"and"</span>))</span>
<span id="cb788-6"><a href="#cb788-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb788-7"><a href="#cb788-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">show_tokens</span>(text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]
[1] "all models" "models are" "are wrong"  "wrong but"  "but some"   "some are"   "are useful"

[[2]]
 [1] "statisticians like" "like artists"       "artists have"       "have bad"          
 [5] "bad habit"          "habit of"           "of falling"         "falling in"        
 [9] "in love"            "love with"          "with their"         "their models"      

[[3]]
[1] "if you"         "you torture"    "torture data"   "data enough"    "enough nature" 
[6] "nature will"    "will always"    "always confess"

[[4]]
[1] "all generalizations" "generalizations are" "are false"           "false including"    
[5] "including this"      "this one"           </code></pre>
</div>
</div>
<p>That’s all the time I have for today. There’s some other things <code>step_tokenize()</code> can do. I highly suggest checking out it’s <a href="https://textrecipes.tidymodels.org/reference/step_tokenize.html">documentation</a> to see all of its functionality.</p>
</section>
<section id="day-25---use-step_clean_level-to-clean-categorical-levels" class="level1">
<h1>Day 25 - Use <code>step_clean_level()</code> to clean categorical levels</h1>
<p>Keeping our focus on <code>textrecipes</code>, I’m going to highlight the use of <code>step_clean_levels()</code>. This function is useful for cleaning up the text used within character or factor variables. Specifically, this function will clean text values in our variable to only include:</p>
<ul>
<li>letters</li>
<li>numbers</li>
<li>underscores</li>
</ul>
<p>Let’s apply this text cleaning recipe step to the <code>item_name</code> variable in our obfuscated Google Analytics data. In fact, to make it easier to see what’s happening, I’ll <code>select()</code> just the <code>item_name</code> within our example data set. I’ll also go ahead and just create our training and testing split here as well.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb790"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb790-1"><a href="#cb790-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb790-2"><a href="#cb790-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb790-3"><a href="#cb790-3" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb790-4"><a href="#cb790-4" aria-hidden="true" tabindex="-1"></a><span class="fu">select</span>(item_name)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb792"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb792-1"><a href="#cb792-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240127</span>)</span>
<span id="cb792-2"><a href="#cb792-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb792-3"><a href="#cb792-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb792-4"><a href="#cb792-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you scan through the items, you’ll begin to notice some of the text could be cleaned. For example, the data contains item names like:</p>
<ul>
<li><code>Google Medium Pet Collar (Red/Yellow)</code></li>
<li><code>#IamRemarkable Unisex T-Shirt</code></li>
<li><code>Android SM S/F18 Sticker Sheet</code></li>
</ul>
<p>If you’ve ever worked with ecommerce or website data, these strings are actually not too bad. However, we can use <code>step_clean_levels()</code> to make them easier to compute on.</p>
<p>Here’s our recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb793"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb793-1"><a href="#cb793-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_te) <span class="sc">|&gt;</span></span>
<span id="cb793-2"><a href="#cb793-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_clean_levels</span>(item_name) <span class="sc">|&gt;</span></span>
<span id="cb793-3"><a href="#cb793-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb793-4"><a href="#cb793-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb793-5"><a href="#cb793-5" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 1873 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Cleaning factor levels for: item_name | Trained</code></pre>
</div>
</div>
<p><code>step_clean_levels()</code>’ tidy method is pretty informative. It provides one column with the original value and a second column with the cleaned value. Take a look at what it will do to our values once baked.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb806"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb806-1"><a href="#cb806-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 332 × 4
   terms     original                      value                                id                
   &lt;chr&gt;     &lt;chr&gt;                         &lt;chr&gt;                                &lt;chr&gt;             
 1 item_name #IamRemarkable Journal        number_iam_remarkable_journal        clean_levels_JONrr
 2 item_name #IamRemarkable Ladies T-Shirt number_iam_remarkable_ladies_t_shirt clean_levels_JONrr
 3 item_name #IamRemarkable Lapel Pin      number_iam_remarkable_lapel_pin      clean_levels_JONrr
 4 item_name #IamRemarkable Pen            number_iam_remarkable_pen            clean_levels_JONrr
 5 item_name #IamRemarkable Unisex Hoodie  number_iam_remarkable_unisex_hoodie  clean_levels_JONrr
 6 item_name #IamRemarkable Unisex T-Shirt number_iam_remarkable_unisex_t_shirt clean_levels_JONrr
 7 item_name #IamRemarkable Water Bottle   number_iam_remarkable_water_bottle   clean_levels_JONrr
 8 item_name Android Buoy Bottle           android_buoy_bottle                  clean_levels_JONrr
 9 item_name Android Garden Tee Orange     android_garden_tee_orange            clean_levels_JONrr
10 item_name Android Geek Pin              android_geek_pin                     clean_levels_JONrr
# ℹ 322 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>It’s interesting to see that the hashtag (i.e., <code>#</code>) was converted to the value <code>number</code>. I couldn’t find any options in <code>step_clean_levels()</code>to modify this, so you may need to first do some pre-cleaning before applying this function.</p>
</div>
</div>
<p>Now, we bake.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>step_clean_levels()</code> will convert character vectors to factors for us.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb808"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb808-1"><a href="#cb808-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,873 × 1
   item_name                           
   &lt;fct&gt;                               
 1 google_thermal_tumbler_navy         
 2 noogler_android_figure              
 3 google_leather_strap_hat_blue       
 4 you_tube_jotter_task_pad            
 5 google_nyc_campus_mug               
 6 google_nyc_campus_zip_hoodie        
 7 number_iam_remarkable_ladies_t_shirt
 8 number_iam_remarkable_lapel_pin     
 9 google_leather_strap_hat_blue       
10 google_f_c_longsleeve_ash           
# ℹ 1,863 more rows</code></pre>
</div>
</div>
<p>All in all, a pretty useful step function from <code>textrecipes</code>. Take some time to apply the <code>step_clean_levels()</code> to your data. It might save you a great deal of time if you’re working with some messy text data.</p>
</section>
<section id="day-26---use-over-sampling-and-under-sampling-methods-with-the-themis-package" class="level1">
<h1>Day 26 - Use over-sampling and under-sampling methods with the <code>themis</code> package</h1>
<p>Today I’m going to highlight some basic uses of the <a href="https://themis.tidymodels.org/reference/index.html"><code>themis</code></a> package. <code>themis</code> makes over- and under-sampling methods available. These methods are useful to address imbalanced class data. You can read more about these methods <a href="https://en.wikipedia.org/wiki/Oversampling_and_undersampling_in_data_analysis">here</a> and <a href="https://www.mastersindatascience.org/learning/statistics-data-science/undersampling/">here</a>. In short, these methods allow us to extract more accurate information from imbalanced data.</p>
<p>To highlight this, let’s use our obfuscated Google Analytics ecommerce data. Specifically, let’s check out our <code>shipping_tier</code> variable for each transaction. Here’s the code we’ll need to wrangle the data for our example:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb810"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb810-1"><a href="#cb810-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb810-2"><a href="#cb810-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb810-3"><a href="#cb810-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb812"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb812-1"><a href="#cb812-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga <span class="sc">|&gt;</span></span>
<span id="cb812-2"><a href="#cb812-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(transaction_id) <span class="sc">|&gt;</span></span>
<span id="cb812-3"><a href="#cb812-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb812-4"><a href="#cb812-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> <span class="fu">sum</span>(item_revenue_in_usd),</span>
<span id="cb812-5"><a href="#cb812-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">shipping_tier =</span> <span class="fu">max</span>(shipping_tier)</span>
<span id="cb812-6"><a href="#cb812-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb812-7"><a href="#cb812-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">shipping_tier =</span> <span class="fu">factor</span>(shipping_tier))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb813"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb813-1"><a href="#cb813-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240128</span>)</span>
<span id="cb813-2"><a href="#cb813-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(data_ga, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb813-3"><a href="#cb813-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb813-4"><a href="#cb813-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a moment to check for the presence of imbalanced data. We can do this with a simple <code>count()</code> and a quick bar chart using <code>ggplot2</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb814"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb814-1"><a href="#cb814-1" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="sc">|&gt;</span></span>
<span id="cb814-2"><a href="#cb814-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(shipping_tier, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 14 × 2
   shipping_tier              n
   &lt;fct&gt;                  &lt;int&gt;
 1 FedEx Ground            2048
 2 UPS Ground               270
 3 FedEx 2Day               125
 4 International Shipping    34
 5 FedEx Overnight           25
 6 &lt;NA&gt;                      25
 7 FedEx Ground-T            12
 8 FedEx Ground-V             7
 9 UPS 2nd Day Air            5
10 UPS 3 Day Select           5
11 FedEx Ground-GI            2
12 FedEx 2Day-V               1
13 UPS 2nd Day Air-F-V        1
14 UPS Next Day Air           1</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb816"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb816-1"><a href="#cb816-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb816-2"><a href="#cb816-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(ga_tr, shipping_tier, <span class="at">sort =</span> <span class="cn">TRUE</span>),</span>
<span id="cb816-3"><a href="#cb816-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="fu">reorder</span>(shipping_tier, n), <span class="at">y =</span> n)</span>
<span id="cb816-4"><a href="#cb816-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb816-5"><a href="#cb816-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb816-6"><a href="#cb816-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb816-7"><a href="#cb816-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Shipping Tier"</span>) <span class="sc">+</span></span>
<span id="cb816-8"><a href="#cb816-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-26-vis-shipping-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>You’ll notice the presence of a severe imbalance in the <code>shipping_tier</code> variable, as most transactions selected FedEx ground as the shipping tier (most likely the cheapest and default shipping tier). We can use <code>step_upsample()</code> and <code>step_downsample()</code> to create synthetic samples to address this imbalance with our recipe.</p>
<p>When over- or under-sampling, we need to select an <code>over_ratio</code> or <code>under_raio</code>. These values specify the ratio of the majority-to-minority or minority-to-majority frequencies, which are used to determine how many of the minority samples are added or how many of the majority class are removed.</p>
<p>For instance, if we are upsampling, we can set the <code>over_ratio</code> to 1. This will synthetically add points to the minority class so the minority and majority classes are equal.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>I’m omitting <code>NA</code>s here with <code>step_naomit()</code>, just to make things easier.</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb817"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb817-1"><a href="#cb817-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb817-2"><a href="#cb817-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_naomit</span>(shipping_tier) <span class="sc">|&gt;</span></span>
<span id="cb817-3"><a href="#cb817-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_upsample</span>(shipping_tier, <span class="at">over_ratio =</span> <span class="dv">1</span>) <span class="sc">|&gt;</span></span>
<span id="cb817-4"><a href="#cb817-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb817-5"><a href="#cb817-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb817-6"><a href="#cb817-6" aria-hidden="true" tabindex="-1"></a>ga_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 3</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 3202 data points and 27 incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Removing rows with NA values in: shipping_tier | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Up-sampling based on: shipping_tier | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb831"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb831-1"><a href="#cb831-1" aria-hidden="true" tabindex="-1"></a>baked_ga <span class="ot">&lt;-</span> <span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb831-2"><a href="#cb831-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb831-3"><a href="#cb831-3" aria-hidden="true" tabindex="-1"></a>baked_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 33,436 × 3
   transaction_id revenue shipping_tier
            &lt;dbl&gt;   &lt;dbl&gt; &lt;fct&gt;        
 1         551345     137 FedEx 2Day   
 2         548006      71 FedEx 2Day   
 3         843790      40 FedEx 2Day   
 4         852510      50 FedEx 2Day   
 5         318033      48 FedEx 2Day   
 6         392135      57 FedEx 2Day   
 7         888228      90 FedEx 2Day   
 8         396838     671 FedEx 2Day   
 9         975263      24 FedEx 2Day   
10         859104      14 FedEx 2Day   
# ℹ 33,426 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb833"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb833-1"><a href="#cb833-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(</span>
<span id="cb833-2"><a href="#cb833-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(baked_ga, shipping_tier, <span class="at">sort =</span> <span class="cn">TRUE</span>),</span>
<span id="cb833-3"><a href="#cb833-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="fu">reorder</span>(shipping_tier, n), <span class="at">y =</span> n)</span>
<span id="cb833-4"><a href="#cb833-4" aria-hidden="true" tabindex="-1"></a>) <span class="sc">+</span></span>
<span id="cb833-5"><a href="#cb833-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb833-6"><a href="#cb833-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb833-7"><a href="#cb833-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Shipping Tier"</span>) <span class="sc">+</span></span>
<span id="cb833-8"><a href="#cb833-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-26-baked-upsample-over-vis-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Say we only want the minority levels to have about half the amount of values of the majority class. We can do this by passing <code>.5</code> to the <code>over_ratio</code> argument.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb834"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb834-1"><a href="#cb834-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb834-2"><a href="#cb834-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_naomit</span>(shipping_tier) <span class="sc">|&gt;</span></span>
<span id="cb834-3"><a href="#cb834-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_upsample</span>(shipping_tier, <span class="at">over_ratio =</span> .<span class="dv">5</span>) <span class="sc">|&gt;</span></span>
<span id="cb834-4"><a href="#cb834-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb834-5"><a href="#cb834-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb834-6"><a href="#cb834-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(shipping_tier, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb834-7"><a href="#cb834-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb834-8"><a href="#cb834-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="fu">reorder</span>(shipping_tier, n), <span class="at">y =</span> n)</span>
<span id="cb834-9"><a href="#cb834-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb834-10"><a href="#cb834-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb834-11"><a href="#cb834-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb834-12"><a href="#cb834-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Shipping Tier"</span>) <span class="sc">+</span></span>
<span id="cb834-13"><a href="#cb834-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-26-recipe-half-upsample-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Under-sampling is pretty much the same, but we use <code>step_downsample()</code> and the <code>under_ratio</code> argument. Here’s some example code to get you started.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb835"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb835-1"><a href="#cb835-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb835-2"><a href="#cb835-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_naomit</span>(shipping_tier) <span class="sc">|&gt;</span></span>
<span id="cb835-3"><a href="#cb835-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_downsample</span>(shipping_tier, <span class="at">under_ratio =</span> <span class="dv">100</span>) <span class="sc">|&gt;</span></span>
<span id="cb835-4"><a href="#cb835-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb835-5"><a href="#cb835-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb835-6"><a href="#cb835-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(shipping_tier, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb835-7"><a href="#cb835-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(</span>
<span id="cb835-8"><a href="#cb835-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="fu">reorder</span>(shipping_tier, n), <span class="at">y =</span> n)</span>
<span id="cb835-9"><a href="#cb835-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb835-10"><a href="#cb835-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb835-11"><a href="#cb835-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb835-12"><a href="#cb835-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">"Shipping Tier"</span>) <span class="sc">+</span></span>
<span id="cb835-13"><a href="#cb835-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="index_files/figure-html/day-26-recipe-downsample-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p><code>themis</code> makes it pretty easy to utilize over- and under-sampling methods. Indeed, this was just a highlight of some of the package’s basics. <code>themis</code> also has implemented some more advanced methods to address imbalanced data (e.g., <a href="https://arxiv.org/abs/1106.1813">SMOTE</a>). If you work with imbalanced data, I suggest checking out the <code>themis</code> package.</p>
</section>
<section id="day-27---use-step_ts_pad-from-timetk-to-pad-timeseries-data" class="level1">
<h1>Day 27 - Use <code>step_ts_pad()</code> from <code>timetk</code> to pad timeseries data</h1>
<p>It’s been a few of days. Work was getting busy, so I didn’t have time to focus on this post as much as I would have liked. So, let’s pick up where we left off, focusing on some <code>step_*()</code> functions from extension packages. Today, I’m focusing on the <code>step_ts_pad()</code> from the <a href="https://business-science.github.io/timetk/"><code>timetk</code></a> package.</p>
<p><code>timetk</code> is it’s own package. It serves as a toolkit for working with timeseries data, so it’s not just an extension package to <code>recipes</code>. However, it contains some useful <code>step_*()</code> functions when modeling timeseries data. <code>step_ts_pad()</code> is highlighted in today’s post.</p>
<p><code>step_ts_pad()</code> fills in the gaps of timeseries data with a specified value. Let’s take a look at some example data. Specifically, we’re returning to our obfuscated Google Analytics ecommerce data. To make it more clear what this function is doing, I’ll remove some values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb836"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb836-1"><a href="#cb836-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(</span>
<span id="cb836-2"><a href="#cb836-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">here</span>(<span class="st">"blog/posts/2024-01-01-30-days-challenge-tidymodels-recipes/data_google_merch.csv"</span>)</span>
<span id="cb836-3"><a href="#cb836-3" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 9365 Columns: 14
── Column specification ────────────────────────────────────────────────────────────────────────────
Delimiter: ","
chr (8): item_name, item_category, shipping_tier, payment_type, category, country, region, city
dbl (6): event_date, purchase_revenue_in_usd, transaction_id, price_in_usd, quantity, item_reven...

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb838"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb838-1"><a href="#cb838-1" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga <span class="sc">|&gt;</span></span>
<span id="cb838-2"><a href="#cb838-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">event_date =</span> <span class="fu">ymd</span>(event_date)) <span class="sc">|&gt;</span></span>
<span id="cb838-3"><a href="#cb838-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(event_date) <span class="sc">|&gt;</span></span>
<span id="cb838-4"><a href="#cb838-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb838-5"><a href="#cb838-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">revenue =</span> <span class="fu">sum</span>(item_revenue_in_usd),</span>
<span id="cb838-6"><a href="#cb838-6" aria-hidden="true" tabindex="-1"></a>  ) </span>
<span id="cb838-7"><a href="#cb838-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb838-8"><a href="#cb838-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove some values to better highlight the example</span></span>
<span id="cb838-9"><a href="#cb838-9" aria-hidden="true" tabindex="-1"></a>data_ga <span class="ot">&lt;-</span> data_ga[<span class="dv">1</span><span class="sc">:</span><span class="dv">61</span> <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb838-10"><a href="#cb838-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb838-11"><a href="#cb838-11" aria-hidden="true" tabindex="-1"></a>data_ga</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 30 × 2
   event_date revenue
   &lt;date&gt;       &lt;dbl&gt;
 1 2020-12-02    5202
 2 2020-12-04    6454
 3 2020-12-06    2328
 4 2020-12-08    8691
 5 2020-12-10   10760
 6 2020-12-12    6280
 7 2020-12-14    8498
 8 2020-12-16   11505
 9 2020-12-18    6617
10 2020-12-20    1401
# ℹ 20 more rows</code></pre>
</div>
</div>
<p>We’re working with timeseries data, so the training and testing split is created using <code>rsamples</code>’ <code>initital_time_split()</code> function. This split function performs the same action as <code>initial_split()</code>, however, it takes the first <code>prop</code> samples for training, instead of a random selection (checkout <code>?initial_time_split</code> for more info).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb840"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb840-1"><a href="#cb840-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240202</span>)</span>
<span id="cb840-2"><a href="#cb840-2" aria-hidden="true" tabindex="-1"></a>ga_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(data_ga)</span>
<span id="cb840-3"><a href="#cb840-3" aria-hidden="true" tabindex="-1"></a>ga_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(ga_split)</span>
<span id="cb840-4"><a href="#cb840-4" aria-hidden="true" tabindex="-1"></a>ga_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(ga_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We don’t have a complete timeseries here, since this data is aggregated by day and we removed some days in the wrangling step. However, we can use <code>step_ts_pad()</code> to fill in values for missing days. This can be as simple as filling in missing values with <code>NA</code>. Here’s the code to do this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb841"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb841-1"><a href="#cb841-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> ga_tr) <span class="sc">|&gt;</span></span>
<span id="cb841-2"><a href="#cb841-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ts_pad</span>(event_date, <span class="at">by =</span> <span class="st">"day"</span>, <span class="at">pad_value =</span> <span class="cn">NA</span>) <span class="sc">|&gt;</span></span>
<span id="cb841-3"><a href="#cb841-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb841-4"><a href="#cb841-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb841-5"><a href="#cb841-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type   trained skip  id              
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;           
1      1 step      ts_pad TRUE    FALSE ts_padding_KR6BU</code></pre>
</div>
<div class="sourceCode cell-code" id="cb843"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb843-1"><a href="#cb843-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  terms      by    pad_value id              
  &lt;chr&gt;      &lt;chr&gt; &lt;lgl&gt;     &lt;chr&gt;           
1 event_date day   NA        ts_padding_KR6BU</code></pre>
</div>
<div class="sourceCode cell-code" id="cb845"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb845-1"><a href="#cb845-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 43 × 2
   event_date revenue
   &lt;date&gt;       &lt;dbl&gt;
 1 2020-12-02    5202
 2 2020-12-03      NA
 3 2020-12-04    6454
 4 2020-12-05      NA
 5 2020-12-06    2328
 6 2020-12-07      NA
 7 2020-12-08    8691
 8 2020-12-09      NA
 9 2020-12-10   10760
10 2020-12-11      NA
# ℹ 33 more rows</code></pre>
</div>
</div>
<p>Now we have a complete series. However, say we want to fill in this padded value with another value, say the mean of revenue from our training data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb847"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb847-1"><a href="#cb847-1" aria-hidden="true" tabindex="-1"></a>ga_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> data_ga) <span class="sc">|&gt;</span></span>
<span id="cb847-2"><a href="#cb847-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ts_pad</span>(event_date, <span class="at">by =</span> <span class="st">"day"</span>, <span class="at">pad_value =</span> <span class="fu">mean</span>(ga_tr<span class="sc">$</span>revenue)) <span class="sc">|&gt;</span></span>
<span id="cb847-3"><a href="#cb847-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb847-4"><a href="#cb847-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb847-5"><a href="#cb847-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type   trained skip  id              
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;  &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;           
1      1 step      ts_pad TRUE    FALSE ts_padding_wvkNb</code></pre>
</div>
<div class="sourceCode cell-code" id="cb849"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb849-1"><a href="#cb849-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(ga_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  terms      by    pad_value id              
  &lt;chr&gt;      &lt;chr&gt;     &lt;dbl&gt; &lt;chr&gt;           
1 event_date day       3883. ts_padding_wvkNb</code></pre>
</div>
<div class="sourceCode cell-code" id="cb851"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb851-1"><a href="#cb851-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(ga_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 59 × 2
   event_date revenue
   &lt;date&gt;       &lt;dbl&gt;
 1 2020-12-02   5202 
 2 2020-12-03   3883.
 3 2020-12-04   6454 
 4 2020-12-05   3883.
 5 2020-12-06   2328 
 6 2020-12-07   3883.
 7 2020-12-08   8691 
 8 2020-12-09   3883.
 9 2020-12-10  10760 
10 2020-12-11   3883.
# ℹ 49 more rows</code></pre>
</div>
</div>
<p>The <code>by</code> argument can be used to modify the padding interval. This argument can take values like:</p>
<ul>
<li>“auto”</li>
<li>“year”</li>
<li>“month”</li>
<li>“day”</li>
<li>“hour”</li>
<li>“7 days”</li>
</ul>
<p>For example, let’s use the <code>drinks</code> timeseries data from the <code>modeldata</code> package. This data is a monthly timeseries of drink sales from 1992-01-01 to 2017-09-01. You can get more information about this data by running <code>?drinks</code> in your console. I’m going to remove some rows again to make it more clear on what this function is doing to our data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb853"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb853-1"><a href="#cb853-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(drinks, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb853-2"><a href="#cb853-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb853-3"><a href="#cb853-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove some values to better highlight the example</span></span>
<span id="cb853-4"><a href="#cb853-4" aria-hidden="true" tabindex="-1"></a>data_drinks <span class="ot">&lt;-</span> drinks[<span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(drinks) <span class="sc">%%</span> <span class="dv">2</span> <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb853-5"><a href="#cb853-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb853-6"><a href="#cb853-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240202</span>)</span>
<span id="cb853-7"><a href="#cb853-7" aria-hidden="true" tabindex="-1"></a>drinks_split <span class="ot">&lt;-</span> <span class="fu">initial_time_split</span>(data_drinks)</span>
<span id="cb853-8"><a href="#cb853-8" aria-hidden="true" tabindex="-1"></a>drinks_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(drinks_split)</span>
<span id="cb853-9"><a href="#cb853-9" aria-hidden="true" tabindex="-1"></a>drinks_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(drinks_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To pad by month, all we do is pass “month” to the <code>by</code> argument of the function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb854"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb854-1"><a href="#cb854-1" aria-hidden="true" tabindex="-1"></a>drinks_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> drinks_tr) <span class="sc">|&gt;</span></span>
<span id="cb854-2"><a href="#cb854-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ts_pad</span>(date, <span class="at">by =</span> <span class="st">"month"</span>) <span class="sc">|&gt;</span></span>
<span id="cb854-3"><a href="#cb854-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb854-4"><a href="#cb854-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb854-5"><a href="#cb854-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(drinks_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 229 × 2
   date       S4248SM144NCEN
   &lt;date&gt;              &lt;dbl&gt;
 1 1992-02-01           3458
 2 1992-03-01             NA
 3 1992-04-01           4564
 4 1992-05-01             NA
 5 1992-06-01           4529
 6 1992-07-01             NA
 7 1992-08-01           4137
 8 1992-09-01             NA
 9 1992-10-01           4259
10 1992-11-01             NA
# ℹ 219 more rows</code></pre>
</div>
</div>
<p>We can also pad with an alternative value, just like we did above. We just do the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb856"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb856-1"><a href="#cb856-1" aria-hidden="true" tabindex="-1"></a>drinks_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> drinks_tr) <span class="sc">|&gt;</span></span>
<span id="cb856-2"><a href="#cb856-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_ts_pad</span>(date, <span class="at">by =</span> <span class="st">"month"</span>, <span class="at">pad_value =</span> <span class="fu">mean</span>(drinks_tr<span class="sc">$</span>S4248SM144NCEN)) <span class="sc">|&gt;</span></span>
<span id="cb856-3"><a href="#cb856-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb856-4"><a href="#cb856-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb856-5"><a href="#cb856-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(drinks_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 229 × 2
   date       S4248SM144NCEN
   &lt;date&gt;              &lt;dbl&gt;
 1 1992-02-01          3458 
 2 1992-03-01          6628.
 3 1992-04-01          4564 
 4 1992-05-01          6628.
 5 1992-06-01          4529 
 6 1992-07-01          6628.
 7 1992-08-01          4137 
 8 1992-09-01          6628.
 9 1992-10-01          4259 
10 1992-11-01          6628.
# ℹ 219 more rows</code></pre>
</div>
</div>
<p><code>timetk</code>’s <code>step_ts_pad()</code> function is pretty useful. If you need to pad values in a set of timeseries data, then check it out.</p>
</section>
<section id="day-28---specify-an-interaction-variable-using-step_interact" class="level1">
<h1>Day 28 - Specify an interaction variable using <code>step_interact()</code></h1>
<p>Today, I’m taking a step back. I forgot to cover a very important <code>step_*()</code> function. Interaction terms are an essential component to modeling, and so I need to highlight the use of <code>recipes</code>’ <code>step_interact()</code> function.</p>
<p><code>recipes</code>’ <code>step_interact()</code> function specifies new columns of interaction terms between two or more variables within our recipe. Let’s apply this step function to some example data. Going back to a previous data set, let’s use <code>credit_data</code> from the <code>modeldata</code> package for our examples. I’ve used this data several times in previous posts, so I just provide the code to wrangle and create the testing and training split without much exploration or explanation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb858"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb858-1"><a href="#cb858-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"credit_data"</span>, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb858-2"><a href="#cb858-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb858-3"><a href="#cb858-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove NAs to make it easier to work with data</span></span>
<span id="cb858-4"><a href="#cb858-4" aria-hidden="true" tabindex="-1"></a>credit_data <span class="ot">&lt;-</span> credit_data <span class="sc">|&gt;</span> <span class="fu">na.omit</span>()</span>
<span id="cb858-5"><a href="#cb858-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb858-6"><a href="#cb858-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240203</span>)</span>
<span id="cb858-7"><a href="#cb858-7" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb858-8"><a href="#cb858-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb858-9"><a href="#cb858-9" aria-hidden="true" tabindex="-1"></a>credit_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb858-10"><a href="#cb858-10" aria-hidden="true" tabindex="-1"></a>credit_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>How about we add a simple interaction between <code>Expenses</code> and <code>Income</code> to our recipe. We can do this by doing the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb859"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb859-1"><a href="#cb859-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb859-2"><a href="#cb859-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span>Expenses<span class="sc">:</span>Income) <span class="sc">|&gt;</span></span>
<span id="cb859-3"><a href="#cb859-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb859-4"><a href="#cb859-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb859-5"><a href="#cb859-5" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 3231 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Interactions with: Expenses:Income | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb872"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb872-1"><a href="#cb872-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 6
  number operation type     trained skip  id            
   &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;    &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;         
1      1 step      interact TRUE    FALSE interact_xYaaz</code></pre>
</div>
<div class="sourceCode cell-code" id="cb874"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb874-1"><a href="#cb874-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 2
  terms           id            
  &lt;chr&gt;           &lt;chr&gt;         
1 Expenses:Income interact_xYaaz</code></pre>
</div>
<div class="sourceCode cell-code" id="cb876"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb876-1"><a href="#cb876-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Select just the interaction term, just to make it easier to see</span></span>
<span id="cb876-2"><a href="#cb876-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb876-3"><a href="#cb876-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Expenses_x_Income)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 1
   Expenses_x_Income
               &lt;dbl&gt;
 1              7200
 2              4125
 3              2835
 4              8100
 5              2345
 6              7500
 7              4500
 8              7200
 9              4500
10              6525
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>step_interact()</code>’s docs mention this function is intended for <strong>numeric data</strong>, and categorical variables should be converted to dummy variables first. This can be done using <code>step_dummy()</code> (see my previous day 04 post).</p>
</div>
</div>
<p>You’ll notice <code>step_interact()</code> modifies the interaction variable’s name by using <code>_x_</code> as the separator. If for some reason you want to change this, you just pass a character string to <code>step_interact()</code>’s <code>sep</code> argument.</p>
<p>This naming convention is useful, especially if you intend to specify higher order interaction variables within your model, like a 3-way interaction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb878"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb878-1"><a href="#cb878-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb878-2"><a href="#cb878-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="at">terms =</span> <span class="sc">~</span>Expenses<span class="sc">:</span>Income<span class="sc">:</span>Assets) <span class="sc">|&gt;</span></span>
<span id="cb878-3"><a href="#cb878-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb878-4"><a href="#cb878-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb878-5"><a href="#cb878-5" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb878-6"><a href="#cb878-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Expenses_x_Income_x_Assets)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 1
   Expenses_x_Income_x_Assets
                        &lt;dbl&gt;
 1                          0
 2                   16500000
 3                          0
 4                  243000000
 5                          0
 6                   60000000
 7                   15750000
 8                   21600000
 9                   24750000
10                   45675000
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<p><code>step_interact()</code> also allows the use of traditional R model formula when specifying interaction variables. This is really convenient. Say we want to include all the two-way interactions along with our three way interaction, we could do something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb880"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb880-1"><a href="#cb880-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb880-2"><a href="#cb880-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(</span>
<span id="cb880-3"><a href="#cb880-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="sc">~</span>Expenses<span class="sc">:</span>Income <span class="sc">+</span> Expenses<span class="sc">:</span>Assets <span class="sc">+</span> Income<span class="sc">:</span>Assets <span class="sc">+</span> Expenses<span class="sc">:</span>Income<span class="sc">:</span>Assets) <span class="sc">|&gt;</span></span>
<span id="cb880-4"><a href="#cb880-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb880-5"><a href="#cb880-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb880-6"><a href="#cb880-6" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb880-7"><a href="#cb880-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"Expenses"</span>), <span class="fu">starts_with</span>(<span class="st">"Income"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 6
   Expenses Expenses_x_Income Expenses_x_Assets Expenses_x_Income_x_Assets Income Income_x_Assets
      &lt;int&gt;             &lt;dbl&gt;             &lt;dbl&gt;                      &lt;dbl&gt;  &lt;int&gt;           &lt;dbl&gt;
 1       60              7200                 0                          0    120               0
 2       75              4125            300000                   16500000     55          220000
 3       35              2835                 0                          0     81               0
 4       90              8100           2700000                  243000000     90         2700000
 5       35              2345                 0                          0     67               0
 6       75              7500            600000                   60000000    100          800000
 7       45              4500            157500                   15750000    100          350000
 8       60              7200            180000                   21600000    120          360000
 9       60              4500            330000                   24750000     75          412500
10       45              6525            315000                   45675000    145         1015000
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Add additional interactions using the <code>+</code></p>
</div>
</div>
<p>However, a short-cut would be to do something like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb882"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb882-1"><a href="#cb882-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb882-2"><a href="#cb882-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(</span>
<span id="cb882-3"><a href="#cb882-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">terms =</span> <span class="sc">~</span>(Expenses <span class="sc">+</span> Income <span class="sc">+</span> Assets)<span class="sc">^</span><span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb882-4"><a href="#cb882-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb882-5"><a href="#cb882-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb882-6"><a href="#cb882-6" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 3231 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Interactions with: (Expenses + Income + Assets)^3 | Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb895"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb895-1"><a href="#cb895-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>) <span class="sc">|&gt;</span></span>
<span id="cb895-2"><a href="#cb895-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">starts_with</span>(<span class="st">"Expenses"</span>), <span class="fu">starts_with</span>(<span class="st">"Income"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 6
   Expenses Expenses_x_Income Expenses_x_Assets Expenses_x_Income_x_Assets Income Income_x_Assets
      &lt;int&gt;             &lt;dbl&gt;             &lt;dbl&gt;                      &lt;dbl&gt;  &lt;int&gt;           &lt;dbl&gt;
 1       60              7200                 0                          0    120               0
 2       75              4125            300000                   16500000     55          220000
 3       35              2835                 0                          0     81               0
 4       90              8100           2700000                  243000000     90         2700000
 5       35              2345                 0                          0     67               0
 6       75              7500            600000                   60000000    100          800000
 7       45              4500            157500                   15750000    100          350000
 8       60              7200            180000                   21600000    120          360000
 9       60              4500            330000                   24750000     75          412500
10       45              6525            315000                   45675000    145         1015000
# ℹ 3,221 more rows</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>Although traditional model formula syntax can be used, <code>step_interact()</code>’s docs warn that inline functions (e.g., <code>log</code>) should not be used.</p>
</div>
</div>
<p>It’s also important to mention, again, categorical variables should be converted into numeric variables before being used within an interaction. Let’s say we want to specify an interaction between <code>Debt</code> and <code>Home</code> variables within our <code>credit_data</code> recipe. We would use <code>step_dummy()</code> first on <code>Home</code>, then specify all the interactions between the dummy variables and <code>Debt</code>. <code>step_interact()</code> makes this very easy with the use of <a href="https://dplyr.tidyverse.org/reference/select.html"><code>dplyr</code>-like selection functions</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb897"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb897-1"><a href="#cb897-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_data) <span class="sc">|&gt;</span></span>
<span id="cb897-2"><a href="#cb897-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(Home) <span class="sc">|&gt;</span></span>
<span id="cb897-3"><a href="#cb897-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_interact</span>(<span class="sc">~</span><span class="fu">starts_with</span>(<span class="st">"Home"</span>)<span class="sc">:</span>Debt) <span class="sc">|&gt;</span></span>
<span id="cb897-4"><a href="#cb897-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb897-5"><a href="#cb897-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb897-6"><a href="#cb897-6" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Recipe ──────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Inputs </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Number of variables by role</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>predictor: 14</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Training information </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Training data contained 4039 data points and no incomplete rows.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>── Operations </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Dummy variables from: Home | Trained</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>• Interactions with: (Home_other + Home_owner + Home_parents + Home_priv + Home_rent):Debt |
  Trained</code></pre>
</div>
<div class="sourceCode cell-code" id="cb911"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb911-1"><a href="#cb911-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec, <span class="at">number =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  terms columns id         
  &lt;chr&gt; &lt;chr&gt;   &lt;chr&gt;      
1 Home  other   dummy_asve2
2 Home  owner   dummy_asve2
3 Home  parents dummy_asve2
4 Home  priv    dummy_asve2
5 Home  rent    dummy_asve2</code></pre>
</div>
<div class="sourceCode cell-code" id="cb913"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb913-1"><a href="#cb913-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tidy</span>(credit_rec, <span class="at">number =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 2
  terms             id            
  &lt;chr&gt;             &lt;chr&gt;         
1 Home_other:Debt   interact_hgBQM
2 Home_owner:Debt   interact_hgBQM
3 Home_parents:Debt interact_hgBQM
4 Home_priv:Debt    interact_hgBQM
5 Home_rent:Debt    interact_hgBQM</code></pre>
</div>
<div class="sourceCode cell-code" id="cb915"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb915-1"><a href="#cb915-1" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,039 × 23
   Status Seniority  Time   Age Marital Records Job       Expenses Income Assets  Debt Amount Price
   &lt;fct&gt;      &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;fct&gt;   &lt;fct&gt;   &lt;fct&gt;        &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt; &lt;int&gt;
 1 good           9    60    30 married no      freelance       73    129      0     0    800   846
 2 good          17    60    58 widow   no      fixed           48    131      0     0   1000  1658
 3 bad           10    36    46 married yes     freelance       90    200   3000     0   2000  2985
 4 good           0    60    24 single  no      fixed           63    182   2500     0    900  1325
 5 good           0    36    26 single  no      fixed           46    107      0     0    310   910
 6 good           1    60    36 married no      fixed           75    214   3500     0    650  1645
 7 good          29    60    44 married no      fixed           75    125  10000     0   1600  1800
 8 good           9    12    27 single  no      fixed           35     80      0     0    200  1093
 9 good           0    60    32 married no      freelance       90    107  15000     0   1200  1957
10 bad            0    48    41 married no      partime         90     80      0     0   1200  1468
# ℹ 4,029 more rows
# ℹ 10 more variables: Home_other &lt;dbl&gt;, Home_owner &lt;dbl&gt;, Home_parents &lt;dbl&gt;, Home_priv &lt;dbl&gt;,
#   Home_rent &lt;dbl&gt;, Home_other_x_Debt &lt;dbl&gt;, Home_owner_x_Debt &lt;dbl&gt;, Home_parents_x_Debt &lt;dbl&gt;,
#   Home_priv_x_Debt &lt;dbl&gt;, Home_rent_x_Debt &lt;dbl&gt;</code></pre>
</div>
</div>
<p>The <code>tidy</code> methods are useful here, especially if you want to know what variables will be created as a result of the recipe.</p>
<p>To sum up today’s post, <code>step_interact()</code> has a nice, intuitive interface. It allows for traditional interaction variable specification, while also adding some convenient functionality. A really great <code>step_*()</code> function.</p>
</section>
<section id="day-29---use-recipes-check_-functions-to-validate-steps" class="level1">
<h1>Day 29 - Use <code>recipes</code>’ <code>check_*()</code> functions to validate steps</h1>
<p><code>recipes</code> has several <a href="https://recipes.tidymodels.org/reference/index.html#check-functions"><code>check_*()</code></a> functions. These functions are useful for validating data returned from recipe steps. Specifically, <code>recipes</code> includes the following <code>check_*()</code> functions:</p>
<ul>
<li><code>check_class()</code> - checks variable classes</li>
<li><code>check_cols()</code> - checks if all columns are present</li>
<li><code>check_missing()</code> - checks for any missing values</li>
<li><code>check_new_values()</code> - checks for the presence of any new values</li>
<li><code>check_range()</code> - checks for whether a variable’s range changes</li>
</ul>
<p>Today, I’m going to highlight a couple of these <code>check_*</code> functions: <code>check_class()</code>, <code>check_cols()</code>, and <code>check_missing()</code>. Let’s start with <code>check_class()</code>.</p>
<p>We’ll continue to use our <code>credit_data</code> for some of today’s examples. Towards the end, I’ll use the <code>penguins</code> data for the final example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb917"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb917-1"><a href="#cb917-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"credit_data"</span>, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb917-2"><a href="#cb917-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb917-3"><a href="#cb917-3" aria-hidden="true" tabindex="-1"></a>credit_data <span class="ot">&lt;-</span> credit_data <span class="sc">|&gt;</span> <span class="fu">na.omit</span>()</span>
<span id="cb917-4"><a href="#cb917-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb917-5"><a href="#cb917-5" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240204</span>)</span>
<span id="cb917-6"><a href="#cb917-6" aria-hidden="true" tabindex="-1"></a>credit_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(credit_data, <span class="at">prop =</span> <span class="fl">0.8</span>)</span>
<span id="cb917-7"><a href="#cb917-7" aria-hidden="true" tabindex="-1"></a>credit_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(credit_split)</span>
<span id="cb917-8"><a href="#cb917-8" aria-hidden="true" tabindex="-1"></a>credit_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(credit_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><code>check_class()</code> is useful for verifying variables are expected classes. Two methods are used to check variable classes. First, this check function uses values provided to the <code>class</code> argument. If <code>NULL</code>, the check will then learn the classes from the <code>prep</code>. A variable can have multiple classes, which will be used within the check.</p>
<p>Here’s how to use the training set to learn variable classes for the check:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb918"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb918-1"><a href="#cb918-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb918-2"><a href="#cb918-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_class</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb918-3"><a href="#cb918-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb918-4"><a href="#cb918-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb918-5"><a href="#cb918-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb918-6"><a href="#cb918-6" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 14
   Status Seniority Home     Time   Age Marital   Records Job    Expenses Income Assets  Debt Amount
   &lt;fct&gt;      &lt;int&gt; &lt;fct&gt;   &lt;int&gt; &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;
 1 good           1 other      30    26 single    no      fixed        35    110      0     0    700
 2 good           1 parents    48    22 married   no      fixed        45    117      0     0    768
 3 good          25 priv       48    55 married   no      fixed        60    169   4000     0   1000
 4 good          34 owner      60    50 married   yes     fixed        60    150   9000     0   1300
 5 good           0 parents    60    21 single    no      parti…       45    312  10000     0   1033
 6 good          15 owner      60    35 single    yes     fixed        35    150   5000  2800   1300
 7 good           3 other      12    30 single    no      freel…       35    150      0     0    920
 8 good          23 other      54    38 separated no      fixed        60    178      0     0    740
 9 bad            2 owner      60    38 married   yes     fixed        75     74   3500   500   1700
10 good           0 parents    36    22 single    no      parti…       35    105   3000     0    750
# ℹ 3,221 more rows
# ℹ 1 more variable: Price &lt;int&gt;</code></pre>
</div>
</div>
<p>Indeed, nothing happens because our recipe resulted in variables to not change their class. If any unexpected changes did occur, then the <code>bake</code> would be broken with an error.</p>
<p>We can manually specify our variable class expectations using the <code>class_nm</code> argument:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb920"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb920-1"><a href="#cb920-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb920-2"><a href="#cb920-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_class</span>(</span>
<span id="cb920-3"><a href="#cb920-3" aria-hidden="true" tabindex="-1"></a>    Status, Home, Marital, Records, Job, <span class="at">class_nm =</span> <span class="st">"factor"</span></span>
<span id="cb920-4"><a href="#cb920-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb920-5"><a href="#cb920-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_class</span>(</span>
<span id="cb920-6"><a href="#cb920-6" aria-hidden="true" tabindex="-1"></a>    Seniority, Time, Age, Expenses, Income, </span>
<span id="cb920-7"><a href="#cb920-7" aria-hidden="true" tabindex="-1"></a>    Assets, Debt, Amount, Price, <span class="at">class_nm =</span> <span class="st">"integer"</span></span>
<span id="cb920-8"><a href="#cb920-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb920-9"><a href="#cb920-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(<span class="at">strings_as_factors =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb920-10"><a href="#cb920-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span>
<span id="cb920-11"><a href="#cb920-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb920-12"><a href="#cb920-12" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 14
   Status Seniority Home     Time   Age Marital   Records Job    Expenses Income Assets  Debt Amount
   &lt;fct&gt;      &lt;int&gt; &lt;fct&gt;   &lt;int&gt; &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;
 1 good           1 other      30    26 single    no      fixed        35    110      0     0    700
 2 good           1 parents    48    22 married   no      fixed        45    117      0     0    768
 3 good          25 priv       48    55 married   no      fixed        60    169   4000     0   1000
 4 good          34 owner      60    50 married   yes     fixed        60    150   9000     0   1300
 5 good           0 parents    60    21 single    no      parti…       45    312  10000     0   1033
 6 good          15 owner      60    35 single    yes     fixed        35    150   5000  2800   1300
 7 good           3 other      12    30 single    no      freel…       35    150      0     0    920
 8 good          23 other      54    38 separated no      fixed        60    178      0     0    740
 9 bad            2 owner      60    38 married   yes     fixed        75     74   3500   500   1700
10 good           0 parents    36    22 single    no      parti…       35    105   3000     0    750
# ℹ 3,221 more rows
# ℹ 1 more variable: Price &lt;int&gt;</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>If you intend to have a variable with multiple classes, you can specify this with <code>allow_additional = TRUE</code> in the <code>check_class()</code> function. Check out the function’s examples section for more details (run <code>?check_class</code> in your console).</p>
</div>
</div>
<p>Just to highlight what happens when the check fails, let’s set the second check to expect a <code>numeric</code> rather than an <code>integer</code> class for the variable.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb922"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb922-1"><a href="#cb922-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb922-2"><a href="#cb922-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_class</span>(</span>
<span id="cb922-3"><a href="#cb922-3" aria-hidden="true" tabindex="-1"></a>    Status, Home, Marital, Records, Job, <span class="at">class_nm =</span> <span class="st">"factor"</span></span>
<span id="cb922-4"><a href="#cb922-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb922-5"><a href="#cb922-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_class</span>(</span>
<span id="cb922-6"><a href="#cb922-6" aria-hidden="true" tabindex="-1"></a>    Seniority, Time, Age, Expenses, Income, </span>
<span id="cb922-7"><a href="#cb922-7" aria-hidden="true" tabindex="-1"></a>    Assets, Debt, Amount, Price, <span class="at">class_nm =</span> <span class="st">"numeric"</span></span>
<span id="cb922-8"><a href="#cb922-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb922-9"><a href="#cb922-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>(<span class="at">strings_as_factors =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span></span>
<span id="cb922-10"><a href="#cb922-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `check_class()`:
Caused by error:
! Seniority should have the class(es) numeric but has the class(es) integer.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb924"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb924-1"><a href="#cb924-1" aria-hidden="true" tabindex="-1"></a>credit_rec</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3,231 × 14
   Status Seniority Home     Time   Age Marital   Records Job    Expenses Income Assets  Debt Amount
   &lt;fct&gt;      &lt;int&gt; &lt;fct&gt;   &lt;int&gt; &lt;int&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;fct&gt;     &lt;int&gt;  &lt;int&gt;  &lt;int&gt; &lt;int&gt;  &lt;int&gt;
 1 good           1 other      30    26 single    no      fixed        35    110      0     0    700
 2 good           1 parents    48    22 married   no      fixed        45    117      0     0    768
 3 good          25 priv       48    55 married   no      fixed        60    169   4000     0   1000
 4 good          34 owner      60    50 married   yes     fixed        60    150   9000     0   1300
 5 good           0 parents    60    21 single    no      parti…       45    312  10000     0   1033
 6 good          15 owner      60    35 single    yes     fixed        35    150   5000  2800   1300
 7 good           3 other      12    30 single    no      freel…       35    150      0     0    920
 8 good          23 other      54    38 separated no      fixed        60    178      0     0    740
 9 bad            2 owner      60    38 married   yes     fixed        75     74   3500   500   1700
10 good           0 parents    36    22 single    no      parti…       35    105   3000     0    750
# ℹ 3,221 more rows
# ℹ 1 more variable: Price &lt;int&gt;</code></pre>
</div>
</div>
<p>Another useful check is <code>check_cols()</code>. This function checks if all the columns from the training frame are also present within the new data. Here’s what this looks like:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb926"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb926-1"><a href="#cb926-1" aria-hidden="true" tabindex="-1"></a>credit_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> credit_tr) <span class="sc">|&gt;</span></span>
<span id="cb926-2"><a href="#cb926-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_cols</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb926-3"><a href="#cb926-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(Job) <span class="sc">|&gt;</span></span>
<span id="cb926-4"><a href="#cb926-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span>
<span id="cb926-5"><a href="#cb926-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb926-6"><a href="#cb926-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Omit Job variable in the new data to show the error</span></span>
<span id="cb926-7"><a href="#cb926-7" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(credit_rec, <span class="at">new_data =</span> credit_te[, <span class="sc">-</span><span class="dv">8</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `bake()`:
! The following required columns are missing from `new_data`: "Job".
ℹ These columns have one of the following roles, which are required at `bake()` time: "predictor".</code></pre>
</div>
</div>
<p>You’ll notice an error stops our <code>bake</code>. This is because the variable used to make our dummy variables, <code>Job</code>, was omitted from the new data. Indeed, this is a very useful check, especially to verify if variables needed in our new data are available when the recipe is baked.</p>
<p>Okay, I’ll highlight one more useful <code>check_*</code> function for today, <code>check_missing()</code>. This function’s purpose is simple–check if variables contain any missing values. <code>check_missing()</code> can fail either on <code>prep</code> or <code>bake</code>. Both help catch if missing values are present in the training or new data.</p>
<p>The <code>check_missing()</code> documentation (run <code>?check_missing</code> in your console), uses the <code>credit_data</code> data for its examples. So, let’s switch it up a bit here. Instead, I’ll use the <code>penguins</code> data for this final example. Here’s the code to get us up to the specification of the recipe.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb928"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb928-1"><a href="#cb928-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"penguins"</span>, <span class="at">package =</span> <span class="st">"modeldata"</span>)</span>
<span id="cb928-2"><a href="#cb928-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb928-3"><a href="#cb928-3" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">20240204</span>)</span>
<span id="cb928-4"><a href="#cb928-4" aria-hidden="true" tabindex="-1"></a>penguins_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(penguins, <span class="at">prop =</span> .<span class="dv">8</span>)</span>
<span id="cb928-5"><a href="#cb928-5" aria-hidden="true" tabindex="-1"></a>penguins_tr <span class="ot">&lt;-</span> <span class="fu">training</span>(penguins_split)</span>
<span id="cb928-6"><a href="#cb928-6" aria-hidden="true" tabindex="-1"></a>penguins_te <span class="ot">&lt;-</span> <span class="fu">testing</span>(penguins_split)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb929"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb929-1"><a href="#cb929-1" aria-hidden="true" tabindex="-1"></a><span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb929-2"><a href="#cb929-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_missing</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb929-3"><a href="#cb929-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>() <span class="sc">|&gt;</span></span>
<span id="cb929-4"><a href="#cb929-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bake</span>(<span class="at">new_data =</span> <span class="cn">NULL</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `check_missing()`:
Caused by error in `bake()`:
! The following columns contain missing values: `bill_length_mm`, `bill_depth_mm`, `flipper_length_mm`, `body_mass_g`, `sex`.</code></pre>
</div>
</div>
<p>You’ll notice the above code errors because all the columns listed in the error contain a missing value(s).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb931"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb931-1"><a href="#cb931-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is.na</span>(penguins_tr) <span class="sc">|&gt;</span> <span class="fu">colSums</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          species            island    bill_length_mm     bill_depth_mm flipper_length_mm 
                0                 0                 1                 1                 1 
      body_mass_g               sex 
                1                 9 </code></pre>
</div>
</div>
<p>If for some reason your training data doesn’t contain missing values, but your new data does, then the check will push an error during the <code>bake</code>.</p>
<p>Here I’ll use <code>step_naomit()</code> to remove missing values from the training set to show how <code>check_missing()</code> throws an error during the <code>bake</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb933"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb933-1"><a href="#cb933-1" aria-hidden="true" tabindex="-1"></a><span class="co"># No error</span></span>
<span id="cb933-2"><a href="#cb933-2" aria-hidden="true" tabindex="-1"></a>penguin_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(<span class="sc">~</span>., <span class="at">data =</span> penguins_tr) <span class="sc">|&gt;</span></span>
<span id="cb933-3"><a href="#cb933-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_naomit</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb933-4"><a href="#cb933-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">check_missing</span>(<span class="fu">everything</span>()) <span class="sc">|&gt;</span></span>
<span id="cb933-5"><a href="#cb933-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">prep</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb934"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb934-1"><a href="#cb934-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error</span></span>
<span id="cb934-2"><a href="#cb934-2" aria-hidden="true" tabindex="-1"></a><span class="fu">bake</span>(penguin_rec, <span class="at">new_data =</span> penguins_te)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error in `bake()`:
! The following columns contain missing values: `bill_length_mm`, `bill_depth_mm`, `flipper_length_mm`, `body_mass_g`, `sex`.</code></pre>
</div>
</div>
<p>A pretty useful <code>check_*()</code> function, especially if you’re concerned data might contain missing values.</p>
<p>Indeed, recipes provides some other <code>check_*()</code> functions. I highly suggest looking over <code>recipes</code>’ <a href="https://recipes.tidymodels.org/reference/index.html#check-functions">reference page</a> to see the other functions that are provided.</p>
<p>That’s all for day 29. Tomorrow is day 30 of this challenge. I’m excited to wrap this post up.</p>


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div id="quarto-reuse" class="quarto-appendix-contents"><div><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></div></section><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@misc{berke2024,
  author = {Berke, Collin K},
  title = {30 Day Tidymodels `Recipes` Challenge},
  date = {2024-01-01},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-berke2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Berke, Collin K. 2024. <span>“30 Day Tidymodels `Recipes`
Challenge.”</span> January 1, 2024.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'alternate';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>